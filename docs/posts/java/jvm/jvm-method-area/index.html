<!DOCTYPE html>
<html lang="zh" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="google-site-verification" content="tVxoyWMeaEzEUV0EzY1STfJXZWaZ8WM-i-a8AWBri0o" />
    <meta name="msvalidate.01" content="48159A4EAF3C3F448369E581664B1A21" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="whitepure" />
	
	
	
	<title>JVM中的方法区 ｜ 脚踏实地</title>
	
    
    
    <meta name="description" content="Java虚拟机定义了若干种程序运行期间会使用到的运行时数据区，其中有一些会随着虚拟机启动而创建，随着虚拟机退出而销毁。 另外一些则是与线程一一对应的，这些与线程对" />
    

    
    
    <meta name="keywords" content="whitepure博客, whiteppure, whitepure, Java, 博客, 技术博客" />
    

	

    <link rel="shortcut icon" href="https://blog.lijizhi.website/images/favicon.ico" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://blog.lijizhi.website/css/normalize.css" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://blog.lijizhi.website/css/animate.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://blog.lijizhi.website/css/zozo.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://blog.lijizhi.website/css/remixicon.css" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://blog.lijizhi.website/css/highlight.css" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://blog.lijizhi.website/css/toc.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://blog.lijizhi.website/css/search.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://blog.lijizhi.website/css/img.css" />

    
    
</head>

<body>
    <div class="post-password">
        
    </div>

    
    
    









<div id="post_content_toc" class="toc">
    <div class="page-header"><strong></strong></div>
    <div id="page-scrollspy" class="toc-nav">

        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e5%af%b9%e4%ba%8e%e6%96%b9%e6%b3%95%e5%8c%ba%e7%9a%84%e7%90%86%e8%a7%a3">
                    对于方法区的理解
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#jdk7%e4%b8%8ejdk8%e7%9a%84%e6%96%b9%e6%b3%95%e5%8c%ba">
                    JDK7与JDK8的方法区
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e8%ae%be%e7%bd%ae%e6%96%b9%e6%b3%95%e5%8c%ba%e5%a4%a7%e5%b0%8f">
                    设置方法区大小
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#jdk7%e5%8f%8a%e4%b9%8b%e5%89%8d">
                    JDK7及之前
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#jdk8%e5%8f%8a%e4%b9%8b%e5%90%8e">
                    JDK8及之后
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e6%96%b9%e6%b3%95%e5%8c%ba%e7%9a%84%e5%86%85%e9%83%a8%e7%bb%93%e6%9e%84">
                    方法区的内部结构
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e7%b1%bb%e5%9e%8b%e4%bf%a1%e6%81%af">
                    类型信息
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e5%9f%9f%e4%bf%a1%e6%81%af">
                    域信息
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e6%96%b9%e6%b3%95%e4%bf%a1%e6%81%af">
                    方法信息
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#non-final%e7%9a%84%e7%b1%bb%e5%8f%98%e9%87%8f">
                    non-final的类变量
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e8%bf%90%e8%a1%8c%e6%97%b6%e5%b8%b8%e9%87%8f%e6%b1%a0">
                    运行时常量池
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e5%ad%97%e8%8a%82%e7%a0%81%e6%8c%87%e4%bb%a4%e8%a7%a3%e6%9e%90">
                    字节码指令解析
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e6%96%b9%e6%b3%95%e5%8c%ba%e6%bc%94%e8%bf%9b%e7%bb%86%e8%8a%82">
                    方法区演进细节
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e6%96%b9%e6%b3%95%e5%8c%ba%e7%9a%84%e5%9e%83%e5%9c%be%e5%9b%9e%e6%94%b6">
                    方法区的垃圾回收
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        

    </div>
</div>



    

    
    <div class="main animate__animated animate__fadeInDown" id="main_content">
        <div class="nav_container animated fadeInDown">
    <div class="site_nav" id="site_nav">
        <ul><li class="">
                <a href="https://blog.lijizhi.website/">首页</a>
            </li><li class="">
                <a href="https://blog.lijizhi.website/posts/">归档</a>
            </li><li class="">
                <a href="https://blog.lijizhi.website/tags/">标签</a>
            </li><li class="">
                <a href="https://blog.lijizhi.website/about/">关于</a>
            </li>
        </ul>
    </div>
    <div class="menu_icon">
        <a id="menu_icon"><i class="ri-menu-line"></i></a>
    </div>
</div>
        <div id="post_header" class="header animated fadeInDown">
    <div class="site_title_container">
        <div class="site_title">
            <h1>
                <a href="https://blog.lijizhi.website/">
                    <span>脚踏实地</span>
                </a>
            </h1>
        </div>
        <div class="description">
            <p class="sub_title">
                
            </p>

            
            <div class="my_socials">
                
                    
                    <a href="https://github.com/whiteppure/" title="github" target="_blank">
                        <i class="ri-github-fill"></i>
                    </a>
                    
                
                <a href="" type="application/rss+xml" title="rss" target="_blank">
                    <i class="ri-rss-fill"></i>
                </a>
                
                
                <span id="sys_function" class="sys_function display_none">
                    <a id="export_pdf"  title="导出pdf" style="border: none; cursor: pointer; margin-left: 10px">
                        <svg t="1688701481347" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3517" width="16" height="16"><path d="M425.610455 85.814544H149.05897A42.303635 42.303635 0 0 0 106.6274 128.075535V896.492068c0 23.326702 18.976933 42.26099 42.43157 42.26099h682.743143a42.559504 42.559504 0 0 0 42.431569-42.559504v-384.016365a42.644793 42.644793 0 0 1 85.289587 0v384.016365A127.849091 127.849091 0 0 1 831.802113 1024H149.05897A127.635867 127.635867 0 0 1 21.337813 896.449423V128.03289A127.593222 127.593222 0 0 1 149.101614 0.524957h276.466196a42.644793 42.644793 0 0 1 0 85.289587z m564.062683 158.08425l-170.579174 170.579173a42.644793 42.644793 0 1 1-60.299738-60.299738L856.578738 256.393718H618.364922a42.644793 42.644793 0 1 1 0-85.289587h238.213816l-97.784512-97.784511A42.644793 42.644793 0 1 1 819.093964 13.019882l170.579174 170.579174a42.644793 42.644793 0 0 1 0 60.299738zM149.272194 597.552066a42.644793 42.644793 0 0 1 42.644793-42.644794h51.514911c59.190973 0 107.891327 23.284057 107.976617 97.102195 0 71.003581-49.46796 102.347504-106.185536 102.347504h-31.343923v66.781747a32.282109 32.282109 0 0 1-64.606862 0V597.552066z m92.709781 100.215264c31.429213 0 46.568114-16.46089 46.568114-45.757863 0-30.064579-17.313786-40.512554-48.359196-40.512554h-26.311837v86.270417h28.145563z m232.414124-142.860058c81.878003 0 136.036891 43.710913 136.036891 147.67892S556.231457 853.420826 477.935617 853.420826h-38.16709a42.644793 42.644793 0 0 1-42.644794-42.644793v-213.223967a42.644793 42.644793 0 0 1 42.644794-42.644794h34.542282z m-4.008611 240.729859c43.32711 0 73.988717-22.047358 73.988717-93.050939 0-71.046226-30.704251-90.705476-73.988717-90.705476h-8.699538v183.79906h8.699538zM692.481573 853.420826a32.282109 32.282109 0 0 1-32.282109-32.282108V597.552066a42.644793 42.644793 0 0 1 42.644793-42.644794h99.063855a29.680776 29.680776 0 1 1 0 59.404197h-77.144431v65.374469h61.749661a29.894 29.894 0 1 1 0 59.788h-61.749661v81.66478a32.282109 32.282109 0 0 1-32.282108 32.282108z" fill="#5f5f5f" p-id="3518"></path></svg>
                    </a>
                    <a id="export_pic" title="导出图片" style="border: none; cursor: pointer; margin-left: 10px">
                        <svg t="1689071509720" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4564" width="16" height="16"><path d="M909.132886 0.037506h-184.960611a33.909445 33.909445 0 0 0-32.368107 33.909445 33.909445 33.909445 0 0 0 33.909445 33.395666h158.244078l-200.373995 199.346437a33.395666 33.395666 0 0 0 0 47.781491 31.854327 31.854327 0 0 0 23.633856 9.76181 33.909445 33.909445 0 0 0 24.147635-9.76181l198.832657-199.346437V272.340628a33.909445 33.909445 0 0 0 69.874009 0V88.921355A88.37007 88.37007 0 0 0 909.132886 0.037506zM216.558153 347.866211a107.37991 107.37991 0 1 0 107.37991-107.379911 107.89369 107.89369 0 0 0-107.37991 107.379911z m154.133843 0a51.377948 51.377948 0 0 1-97.618101 0 51.377948 51.377948 0 1 1 97.618101 0z" p-id="4565" fill="#424242"></path><path d="M963.079731 437.777619a34.423225 34.423225 0 0 0-33.909446 33.909445v265.110209a1811.07265 1811.07265 0 0 0-137.692899-193.181082 106.352351 106.352351 0 0 0-78.60826-36.478343 123.820854 123.820854 0 0 0-82.204716 35.964563l-3.596456 3.082677-188.557068 176.74014c-11.816928-13.358266-47.781491-51.377948-82.204716-87.856291a83.232275 83.232275 0 0 0-85.801172-21.578738 105.324792 105.324792 0 0 0-38.019681 19.52362l-141.289356 121.765736V89.948914a22.092517 22.092517 0 0 1 22.606297-22.606297h417.702713a33.395666 33.395666 0 0 0 33.395666-33.909445 33.395666 33.395666 0 0 0-33.395666-33.395666H113.802258A89.911408 89.911408 0 0 0 23.89085 89.948914v844.139678a89.911408 89.911408 0 0 0 89.911408 89.911408h793.27551a89.911408 89.911408 0 0 0 89.397629-89.911408v-462.401528a33.909445 33.909445 0 0 0-33.395666-33.909445z m-33.909446 496.310973a22.606297 22.606297 0 0 1-22.092517 22.606297H113.802258a22.606297 22.606297 0 0 1-22.606297-22.606297v-88.37007l183.933052-160.812976a43.157476 43.157476 0 0 1 15.413385-7.192912 15.927164 15.927164 0 0 1 17.982281 5.137794c37.505902 36.478343 78.60826 83.232275 82.718496 87.856291a61.653537 61.653537 0 0 0 42.643696 22.092517 62.681096 62.681096 0 0 0 51.377948-20.037399c8.220472-8.220472 134.610223-125.875971 194.208641-181.877935a57.029522 57.029522 0 0 1 34.423225-16.440943 45.212594 45.212594 0 0 1 29.79921 15.927164 2954.231982 2954.231982 0 0 1 186.501949 256.889738z" p-id="4566" fill="#424242"></path></svg>
                    </a>
                    <a id="export_markdown" title="导出markdown" style="border: none; cursor: pointer; margin-left: 10px">
                        <svg t="1689071035200" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="13570" width="16" height="16"><path d="M178.073367 843.957262V461.158929h107.121045l107.121045 140.734874 107.125433-140.734874h107.116657v382.798333h-107.116657v-219.54307l-107.125433 140.730486-107.116657-140.730486v219.54307zM737.783131 892.148786l-131.221196-209.156132h87.479334V461.158929h87.479335v221.833725h87.483722z" p-id="13571" fill="#424242"></path><path d="M911.9958 217.142709c10.672172 10.663395 19.812851 25.144549 27.430816 43.430297 7.617965 18.285748 11.431335 35.044392 11.431336 50.28471V969.140255c0 15.235929-5.336086 28.18998-15.999481 38.853375-10.667783 10.667783-23.621834 16.003869-38.857763 16.003869H127.994904c-15.240317 0-28.18998-5.336086-38.857763-16.003869-10.663395-10.663395-15.999481-23.617446-15.999481-38.853375V54.852856c0-15.240317 5.331698-28.18998 15.999481-38.857763C99.804925 5.336086 112.758975 0 127.999292 0h512.000944c15.235929 0 31.998962 3.808982 50.28471 11.426947 18.285748 7.622353 32.762514 16.763033 43.430297 27.426428zM658.290372 77.715526v214.856442h214.856442c-3.808982-11.049559-7.99974-18.856218-12.572275-23.43314l-178.855415-178.851027c-4.572534-4.572534-12.383581-8.763292-23.43314-12.572275z m219.428976 873.143369V365.71496h-237.714724c-15.240317 0-28.18998-5.336086-38.857763-15.999481-10.663395-10.667783-15.999481-23.621834-15.999481-38.857763V73.142992H146.28504v877.715903z" p-id="13572" fill="#424242"></path></svg>
                    </a>
                    <a id="export_doc" title="导出文档" style="border: none; cursor: pointer; margin-left: 10px">
                        <svg t="1689246982401" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6825" width="16" height="16"><path d="M270.76864 608.32h180.8a31.68 31.68 0 0 0 0-62.976H270.76864a31.68 31.68 0 0 0 0 62.976zM271.34464 458.56h457.92a33.472 33.472 0 0 0 31.552-34.752 33.28 33.28 0 0 0-31.552-34.624H271.34464a34.816 34.816 0 0 0 0 69.376zM271.34464 293.504h457.92a33.344 33.344 0 0 0 31.552-34.688 33.216 33.216 0 0 0-31.552-34.624H271.34464a33.28 33.28 0 0 0-31.616 34.624 33.28 33.28 0 0 0 31.616 34.688z" p-id="6826" fill="#424242"></path><path d="M869.87264 0H153.77664A70.4 70.4 0 0 0 84.65664 70.912V953.6A69.952 69.952 0 0 0 153.77664 1024h370.048a32 32 0 0 0 0-63.68H147.12064V64h729.6v468.672a31.296 31.296 0 1 0 62.528 0V70.912A70.4 70.4 0 0 0 869.87264 0z" p-id="6827" fill="#424242"></path><path d="M482.16064 730.624h337.664L715.82464 625.216a28.864 28.864 0 0 1-7.936-28.736 29.184 29.184 0 0 1 20.608-21.184 29.632 29.632 0 0 1 29.12 8.128l174.784 177.216-174.784 176.96a29.184 29.184 0 0 1-49.728-13.312 29.248 29.248 0 0 1 8-28.8l103.936-105.344H482.16064a29.696 29.696 0 0 1-29.504-29.76 29.632 29.632 0 0 1 29.504-29.76z" p-id="6828" fill="#424242"></path></svg>
                    </a>
                </span>
                <a  id="icon_more" title="更多" >
                    <svg t="1688715321313" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5356" width="16" height="16"><path d="M483.555556 199.111111m-85.333334 0a85.333333 85.333333 0 1 0 170.666667 0 85.333333 85.333333 0 1 0-170.666667 0Z" fill="#424242" p-id="5357"></path><path d="M483.555556 540.444444m-85.333334 0a85.333333 85.333333 0 1 0 170.666667 0 85.333333 85.333333 0 1 0-170.666667 0Z" fill="#424242" p-id="5358"></path><path d="M483.555556 881.777778m-85.333334 0a85.333333 85.333333 0 1 0 170.666667 0 85.333333 85.333333 0 1 0-170.666667 0Z" fill="#424242" p-id="5359"></path></svg>
                </a>
                <a  id="icon_less" class="display_none">
                    <svg t="1688723160472" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15872" width="16" height="16"><path d="M300.105143 592.676571h423.789714a80.676571 80.676571 0 1 0 0-161.353142H300.105143a80.676571 80.676571 0 0 0 0 161.353142z" fill="#8a8a8a" p-id="15873"></path></svg>
                </a>
                
            </div>

            
            <div class="post">
                <div class="post_title post_detail_title">
                    <span class="date" id="busuanzi_container_site_pv">访问量 <span id="busuanzi_value_site_pv">...</span> 次</span>
                </div>
                <div class="post_title post_detail_title">
                    <span class="date" id="busuanzi_container_site_uv">访客数 <span id="busuanzi_value_site_uv">...</span> 人</span>
                </div>
            </div>
            

            <div class="post">
                <div class="post_title post_detail_title">
                    
                    <span class="date">总文章数 195 篇</span>
                </div>
                <div class="post_title post_detail_title">
                    
                    
                    
                    
                    
                    <span class="date">博客已运行 2067 天</span>
                </div>
            </div>

        </div>
    </div>
</div>
        <div class="content">
            <div class="post_page">
                <div class="post animate__animated animate__fadeInDown">
                    <div class="post_title post_detail_title">
                        <h2 id="post_single_title">JVM中的方法区</h2>
                        <span id="post_page_title_date" class="date">2021.04.08</span>





                    </div>
                    <div class="post_content markdown"><p>Java虚拟机定义了若干种程序运行期间会使用到的运行时数据区，其中有一些会随着虚拟机启动而创建，随着虚拟机退出而销毁。
另外一些则是与线程一一对应的，这些与线程对应的数据区域会随着线程开始和结束而创建和销毁。</p>
<p><img alt="运行时数据区" src="/posts/annex/images/essays/%E8%BF%90%E8%A1%8C%E6%97%B6%E6%95%B0%E6%8D%AE%E5%8C%BA.png"></p>
<p>运行时数据区域包括</p>
<ul>
<li>程序计数寄存器</li>
<li>虚拟机栈</li>
<li>本地方法栈</li>
<li>堆</li>
<li>方法区</li>
</ul>
<p>其中：方法区、堆为线程共享；程序计数寄存器、虚拟机栈、本地方法栈 为线程私有。</p>
<h2 id="对于方法区的理解">对于方法区的理解</h2>
<p>方法区属于是 JVM 运行时数据区域的一块逻辑区域，是各个线程共享的内存区域。
尽管所有的方法区在逻辑上是属于堆的一部分，但一些简单的实现可能不会选择去进行垃圾收集，所以把方法区看作是一块独立于Java堆的内存空间。</p>
<p>把方法区看作是一块独立于Java堆的内存空间。下图说明了栈、堆、方法区的交互关系
<img alt="方法区定位" src="/posts/annex/images/essays/%E6%96%B9%E6%B3%95%E5%8C%BA%E5%AE%9A%E4%BD%8D.png"></p>
<ul>
<li>方法区主要存放的是 class，而堆中主要存放的是实例化的对象。</li>
<li>方法区与Java堆一样，是各个线程共享的内存区域。</li>
<li>方法区在JVM启动的时候被创建，并且它的实际的物理内存空间中和Java堆区一样都可以是不连续的。</li>
<li>方法区的大小，跟堆空间一样，可以选择固定大小或者可扩展。</li>
<li>方法区的大小决定了系统可以保存多少个类，如果系统定义了太多的类，导致方法区溢出，虚拟机同样会抛出内存溢出错误：<code>java.lang.OuOfMemoryError：PermGen space</code> 或者<code>java.lang.OutOfMemoryError:Metaspace</code></li>
<li>关闭JVM就会释放这个区域的内存。</li>
</ul>
<p>方法区和永久代以及元空间是什么关系呢？</p>
<p>方法区和永久代以及元空间的关系很像 Java 中接口和类的关系，类实现了接口，这里的类就可以看作是永久代和元空间，接口可以看作是方法区，也就是说永久代以及元空间是 HotSpot 虚拟机对虚拟机规范中方法区的两种实现方式。
并且永久代是 JDK 1.8 之前的方法区实现，JDK 1.8 及以后方法区的实现变成了元空间。</p>
<h2 id="jdk7与jdk8的方法区">JDK7与JDK8的方法区</h2>
<p>在HotSpot，JDK7及以前，习惯上把方法区，称为永久代。JDK8开始，使用元空间取代了永久代，JDK 1.8后，元空间存放在直接内存中。</p>
<div style="width: 45%;display: inline-block">
    <img src="/posts/annex/images/essays/jvm1.8之前.png" alt="jvm1.8之前">
</div>
<div style="width: 45%;display: inline-block">
    <img src="/posts/annex/images/essays/jvm1.8.png" alt="jvm1.8">
</div>
<p>元空间的本质和永久代类似，都是对JVM规范中方法区的实现。不过元空间与永久代最大的区别在于，元空间不在虚拟机设置的内存中，而是使用本地内存。
永久代、元空间二者并不只是名字变了，内部结构也调整了。根据《Java虚拟机规范》的规定，如果方法区无法满足新的内存分配需求时，将抛出OOM异常。</p>
<h2 id="设置方法区大小">设置方法区大小</h2>
<p>方法区的大小不必是固定的，JVM可以根据应用的需要动态调整。</p>
<h3 id="jdk7及之前">JDK7及之前</h3>
<p>通过参数<code>-XX:Permsize=size</code>来设置永久代初始分配空间，默认值是20.75M。
通过参数<code>-XX:MaxPermsize=size</code>来设定永久代最大可分配空间。32位机器默认是64M，64位机器模式是82M。
当JVM加载的类信息容量超过了这个值，会报异常<code>OuOfMemoryError:PermGen space</code>。</p>
<h3 id="jdk8及之后">JDK8及之后</h3>
<p>元空间大小可以使用参数 <code>-XX:MetaspaceSize=size</code> 和 <code>-XX:MaxMetaspaceSize=size</code> 来指定。</p>
<p>它的默认值依赖于平台。对于一个64位的服务器端JVM来说，<code>-XX:MetaspaceSize</code>是21M，<code>-XX:MaxMetaspaceSize</code>的值是-1，由于直接存放在直接内存中所以没有限制。
与永久代不同，如果不指定大小，默认情况下，虚拟机会耗尽所有的可用系统内存。如果元数据区发生溢出，虚拟机一样会抛出异常<code>OutOfMemoryError:Metaspace</code>。
可通过<code>-XX:MetaspaceSize=size</code>设置初始的元空间大小。</p>
<p>对于一个64位的服务器端JVM来说，其默认的<code>-XX:MetaspaceSize</code>值为21M。
这就是初始的高水位线，一旦触及这个水位线，<code>FullGC</code>将会被触发并卸载没用的类即这些类对应的类加载器不再存活然后这个高水位线将会重置。
新的高水位线的值取决于GC后释放了多少元空间。如果释放的空间不足，那么在不超过<code>MaxMetaspaceSize</code>时，适当提高该值。如果释放空间过多，则适当降低该值。</p>
<p>如果初始化的高水位线设置过低，上述高水位线调整情况会发生很多次。通过垃圾回收器的日志可以观察到<code>FullGC</code>多次调用。
<strong>为了避免频繁地GC，建议将<code>-XX:MetaspaceSize=size</code>设置为一个相对较高的值。</strong></p>
<h2 id="方法区的内部结构">方法区的内部结构</h2>
<p>方法区用于存储已被虚拟机加载的类型信息、常量、静态变量、即时编译器编译后的代码缓存等。</p>
<p><img alt="方法区内部结构" src="/posts/annex/images/essays/%E6%96%B9%E6%B3%95%E5%8C%BA%E5%86%85%E9%83%A8%E7%BB%93%E6%9E%84.png"></p>
<p>展示方法区内部结构，演示代码</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">public class MainTest {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    private String string = &#34;awsl&#34;;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    public static void context() {
</span></span><span class="line"><span class="cl">        try {
</span></span><span class="line"><span class="cl">            int a = 0;
</span></span><span class="line"><span class="cl">            int b = 20/a;
</span></span><span class="line"><span class="cl">        }catch (Exception e) {
</span></span><span class="line"><span class="cl">            e.printStackTrace();
</span></span><span class="line"><span class="cl">        }
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    private String context2() {
</span></span><span class="line"><span class="cl">        return string;
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    public static void main(String[] args) {
</span></span><span class="line"><span class="cl">        new MainTest().context2();
</span></span><span class="line"><span class="cl">        context();
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>编译该类，找到该类的class文件，打开终端执行<code>javap -v MainTest.class &gt; test.txt</code>命令，在当前目录会生成<code>test.txt</code>文件。
打开即可查看反编译后的字节码信息。</p>
<h3 id="类型信息">类型信息</h3>
<p>对每个加载的类型（类class、接口interface、枚举enum、注解annotation），JVM必须在方法区中存储以下类型信息：</p>
<ul>
<li>这个类型的完整有效名称（包名.类名）；</li>
<li>这个类型直接父类的完整有效名（对于interface或是java.lang.object，都没有父类）；</li>
<li>这个类型的修饰符（public，abstract，final的某个子集）；</li>
<li>这个类型直接接口的一个有序列表；</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// ...
</span></span><span class="line"><span class="cl">public class content.posts.jvm.MainTest
</span></span><span class="line"><span class="cl">  minor version: 0
</span></span><span class="line"><span class="cl">  major version: 52
</span></span><span class="line"><span class="cl">  flags: ACC_PUBLIC, ACC_SUPER
</span></span><span class="line"><span class="cl">//...
</span></span></code></pre></div><h3 id="域信息">域信息</h3>
<p>JVM必须在方法区中，保存类型的所有域的相关信息以及域的声明顺序。
域的相关信息包括：域名称、域类型、域修饰符（public，private，protected，static，final，volatile，transient的某个子集）。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">// ...
</span></span><span class="line"><span class="cl">Constant pool:
</span></span><span class="line"><span class="cl">   #1 = Methodref          #10.#35        // java/lang/Object.&#34;&lt;init&gt;&#34;:()V
</span></span><span class="line"><span class="cl">   #2 = String             #36            // awsl
</span></span><span class="line"><span class="cl">   #3 = Fieldref           #6.#37         // content/posts/jvm/MainTest.string:Ljava/lang/String;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">// ...
</span></span></code></pre></div><h3 id="方法信息">方法信息</h3>
<p>JVM必须保存所有方法的以下信息，同域信息一样包括声明顺序：</p>
<ul>
<li>方法名称；</li>
<li>方法的返回类型（或void）；</li>
<li>方法参数的数量和类型（按顺序）；</li>
<li>方法的修饰符（<code>public，private，protected，static，final，synchronized，native，abstract</code>的一个子集）；</li>
<li>方法的字节码（<code>bytecodes</code>）、操作数栈、局部变量表及大小（<code>abstract和native</code>方法除外）；</li>
<li>异常表（<code>abstract和native</code>方法除外）；</li>
</ul>
<p>每个异常处理的开始位置、结束位置、代码处理在程序计数器中的偏移地址、被捕获的异常类的常量池索引。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"> <span class="n">public</span> <span class="k">static</span> <span class="n">void</span> <span class="n">context</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">descriptor</span><span class="p">:</span> <span class="p">()</span><span class="n">V</span>
</span></span><span class="line"><span class="cl">    <span class="n">flags</span><span class="p">:</span> <span class="n">ACC_PUBLIC</span><span class="p">,</span> <span class="n">ACC_STATIC</span>
</span></span><span class="line"><span class="cl">    <span class="n">Code</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">      <span class="n">stack</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">locals</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">args_size</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">         <span class="mi">0</span><span class="p">:</span> <span class="n">iconst_0</span>
</span></span><span class="line"><span class="cl">         <span class="mi">1</span><span class="p">:</span> <span class="n">istore_0</span>
</span></span><span class="line"><span class="cl">         <span class="mi">2</span><span class="p">:</span> <span class="n">bipush</span>        <span class="mi">20</span>
</span></span><span class="line"><span class="cl">         <span class="mi">4</span><span class="p">:</span> <span class="n">iload_0</span>
</span></span><span class="line"><span class="cl">         <span class="mi">5</span><span class="p">:</span> <span class="n">idiv</span>
</span></span><span class="line"><span class="cl">         <span class="mi">6</span><span class="p">:</span> <span class="n">istore_1</span>
</span></span><span class="line"><span class="cl">         <span class="mi">7</span><span class="p">:</span> <span class="n">goto</span>          <span class="mi">15</span>
</span></span><span class="line"><span class="cl">        <span class="mi">10</span><span class="p">:</span> <span class="n">astore_0</span>
</span></span><span class="line"><span class="cl">        <span class="mi">11</span><span class="p">:</span> <span class="n">aload_0</span>
</span></span><span class="line"><span class="cl">        <span class="mi">12</span><span class="p">:</span> <span class="n">invokevirtual</span> <span class="c1">#5                  // Method java/lang/Exception.printStackTrace:()V</span>
</span></span><span class="line"><span class="cl">        <span class="mi">15</span><span class="p">:</span> <span class="k">return</span>
</span></span><span class="line"><span class="cl">       <span class="o">//</span> <span class="err">异常表</span>
</span></span><span class="line"><span class="cl">      <span class="n">Exception</span> <span class="n">table</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">         <span class="n">from</span>    <span class="n">to</span>  <span class="n">target</span> <span class="n">type</span>
</span></span><span class="line"><span class="cl">             <span class="mi">0</span>     <span class="mi">7</span>    <span class="mi">10</span>   <span class="n">Class</span> <span class="n">java</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">Exception</span>
</span></span><span class="line"><span class="cl">       <span class="o">//</span> <span class="err">代码字节码指令行号对照表</span>
</span></span><span class="line"><span class="cl">      <span class="n">LineNumberTable</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="mi">11</span><span class="p">:</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="mi">12</span><span class="p">:</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="mi">15</span><span class="p">:</span> <span class="mi">7</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="mi">13</span><span class="p">:</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="mi">14</span><span class="p">:</span> <span class="mi">11</span>
</span></span><span class="line"><span class="cl">        <span class="n">line</span> <span class="mi">16</span><span class="p">:</span> <span class="mi">15</span>
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="err">局部变量表</span>
</span></span><span class="line"><span class="cl">      <span class="n">LocalVariableTable</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">Start</span>  <span class="n">Length</span>  <span class="n">Slot</span>  <span class="n">Name</span>   <span class="n">Signature</span>
</span></span><span class="line"><span class="cl">            <span class="mi">2</span>       <span class="mi">5</span>     <span class="mi">0</span>     <span class="n">a</span>   <span class="n">I</span>
</span></span><span class="line"><span class="cl">           <span class="mi">11</span>       <span class="mi">4</span>     <span class="mi">0</span>     <span class="n">e</span>   <span class="n">Ljava</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">Exception</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">StackMapTable</span><span class="p">:</span> <span class="n">number_of_entries</span> <span class="o">=</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl">        <span class="n">frame_type</span> <span class="o">=</span> <span class="mi">74</span> <span class="o">/*</span> <span class="n">same_locals_1_stack_item</span> <span class="o">*/</span>
</span></span><span class="line"><span class="cl">          <span class="n">stack</span> <span class="o">=</span> <span class="p">[</span> <span class="k">class</span> <span class="n">java</span><span class="o">/</span><span class="n">lang</span><span class="o">/</span><span class="n">Exception</span> <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">frame_type</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">/*</span> <span class="n">same</span> <span class="o">*/</span>
</span></span></code></pre></div><h3 id="non-final的类变量">non-final的类变量</h3>
<p>静态变量和类关联在一起，随着类的加载而加载，他们成为类数据在逻辑上的一部分。</p>
<p>类变量被类的所有实例共享，即使没有类实例时，也可以访问它：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">public class MainTest {
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    public static void main(String[] args) {
</span></span><span class="line"><span class="cl">        Test test = null;
</span></span><span class="line"><span class="cl">        // 相当于 Test.hello();
</span></span><span class="line"><span class="cl">        test.hello();
</span></span><span class="line"><span class="cl">        // Test.count;
</span></span><span class="line"><span class="cl">        System.out.println(test.count);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">class Test {
</span></span><span class="line"><span class="cl">    public static int count = 1;
</span></span><span class="line"><span class="cl">    public static final int number = 2;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    public static void hello() {
</span></span><span class="line"><span class="cl">        System.out.println(&#34;hello!&#34;);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>全局常量就是使用<code>static final</code>进行修饰，被声明为<code>final</code>的类变量的处理方法则不同，每个全局常量在编译的时候就会被分配了。</p>
<h3 id="运行时常量池">运行时常量池</h3>
<p>运行时常量池是每一个类或接口的常量池的运行时表示形式。</p>
<p>它包括了若干种不同的常量：从编译期可知的数值字面量到必须运行期解析后才能获得的方法或字段引用。
运行时常量池扮演了类似传统语言中符号表的角色，不过它存储数据范围比通常意义上的符号表要更为广泛。</p>
<p>每一个运行时常量池都分配在 Java 虚拟机的方法区之中，在类和接口被加载到虚拟机后，对应的运行时常量池就被创建出来。</p>
<ul>
<li>保存在方法区中的叫运行时常量池；</li>
<li>在 class/字节码 文件中的叫class常量池（静态常量池）。</li>
</ul>
<p>简单说来就是JVM在完成类装载操作后，将class文件中的常量池载入到内存中，并保存在方法区中。
我们常说的常量池，就是指方法区中的运行时常量池。</p>
<p>运行时常量池类似于传统编程语言中的符号表，但是它所包含的数据却比符号表要更加丰富一些。
当创建类或接口的运行时常量池时，如果构造运行时常量池所需的内存空间超过了方法区所能提供的最大值，则JVM会抛<code>OutOfMemoryError</code>异常。</p>
<h2 id="字节码指令解析">字节码指令解析</h2>
<p>演示代码如下</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">public class MethodAreaDemo {
</span></span><span class="line"><span class="cl">    public static void main(String args[]) {
</span></span><span class="line"><span class="cl">        int x = 500;
</span></span><span class="line"><span class="cl">        int y = 100;
</span></span><span class="line"><span class="cl">        int a = x / y;
</span></span><span class="line"><span class="cl">        int b = 50;
</span></span><span class="line"><span class="cl">        System.out.println(a+b);
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div><p>反编译后该方法字节码指令</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="o">//</span> <span class="o">....</span>
</span></span><span class="line"><span class="cl">     <span class="o">//</span> <span class="err">栈的最大深度为</span><span class="mi">3</span> <span class="err">局部变量表长度为</span><span class="mi">5</span> <span class="err">参数长度为</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">      <span class="n">stack</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">locals</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">args_size</span><span class="o">=</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">         <span class="o">//</span> <span class="err">将</span><span class="mi">500</span><span class="err">压入操作数栈</span>
</span></span><span class="line"><span class="cl">         <span class="mi">0</span><span class="p">:</span> <span class="n">sipush</span>        <span class="mi">500</span>
</span></span><span class="line"><span class="cl">         <span class="o">//</span> <span class="err">在局部变量表里存放</span> <span class="mi">500</span>
</span></span><span class="line"><span class="cl">         <span class="mi">3</span><span class="p">:</span> <span class="n">istore_1</span>
</span></span><span class="line"><span class="cl">         <span class="o">//</span> <span class="err">将</span><span class="mi">100</span><span class="err">压入栈</span>
</span></span><span class="line"><span class="cl">         <span class="mi">4</span><span class="p">:</span> <span class="n">bipush</span>        <span class="mi">100</span>
</span></span><span class="line"><span class="cl">         <span class="o">//</span> <span class="err">在局部变量表里存放</span> <span class="mi">100</span> 
</span></span><span class="line"><span class="cl">         <span class="mi">6</span><span class="p">:</span> <span class="n">istore_2</span>
</span></span><span class="line"><span class="cl">         <span class="o">//</span> <span class="err">将</span> <span class="mi">500</span> <span class="err">从局部变量表里边取出，并压入操作数栈</span>
</span></span><span class="line"><span class="cl">         <span class="mi">7</span><span class="p">:</span> <span class="n">iload_1</span>
</span></span><span class="line"><span class="cl">         <span class="o">//</span> <span class="err">将</span> <span class="mi">100</span> <span class="err">从局部变量表里边取出，并压入操作数栈</span>
</span></span><span class="line"><span class="cl">         <span class="mi">8</span><span class="p">:</span> <span class="n">iload_2</span>
</span></span><span class="line"><span class="cl">         <span class="o">//</span> <span class="err">调用</span> <span class="n">CPU</span> <span class="err">执行除法</span> <span class="mi">500</span><span class="o">/</span><span class="mi">100</span><span class="o">=</span><span class="mi">5</span>
</span></span><span class="line"><span class="cl">         <span class="mi">9</span><span class="p">:</span> <span class="n">idiv</span>
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="err">存储在局部变量表里</span>
</span></span><span class="line"><span class="cl">        <span class="mi">10</span><span class="p">:</span> <span class="n">istore_3</span>
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="err">将</span><span class="mi">50</span><span class="err">压入栈中</span>
</span></span><span class="line"><span class="cl">        <span class="mi">11</span><span class="p">:</span> <span class="n">bipush</span>        <span class="mi">50</span>
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="err">将</span> <span class="mi">50</span> <span class="err">存储在局部变量表中</span>
</span></span><span class="line"><span class="cl">        <span class="mi">13</span><span class="p">:</span> <span class="n">istore</span>        <span class="mi">4</span>
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="err">获取</span> <span class="c1">#2 地址上类或接口字段的值并将其推入操作数栈</span>
</span></span><span class="line"><span class="cl">        <span class="mi">15</span><span class="p">:</span> <span class="n">getstatic</span>     <span class="c1">#2                  // Field java/lang/System.out:Ljava/io/PrintStream;</span>
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="err">将</span> <span class="mi">5</span> <span class="err">从本地变量表取出放到栈中</span>
</span></span><span class="line"><span class="cl">        <span class="mi">18</span><span class="p">:</span> <span class="n">iload_3</span>
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="err">将</span><span class="mi">50</span><span class="err">从本地变量表，压入栈</span>
</span></span><span class="line"><span class="cl">        <span class="mi">19</span><span class="p">:</span> <span class="n">iload</span>         <span class="mi">4</span>
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="err">调用</span><span class="n">cpu执行加法</span> <span class="mi">5</span> <span class="o">+</span> <span class="mi">50</span><span class="o">=</span><span class="mi">55</span>
</span></span><span class="line"><span class="cl">        <span class="mi">21</span><span class="p">:</span> <span class="n">iadd</span>
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="err">虚方法调用</span> <span class="c1">#3 中的方法 </span>
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="n">JVM会根据这个方法的描述</span><span class="err">，创建新的栈桢，方法的参数从操作数栈中弹出来，压入虚拟机栈，然后虚拟机会开始执行虚拟机栈上最上面的栈桢</span>
</span></span><span class="line"><span class="cl">        <span class="mi">22</span><span class="p">:</span> <span class="n">invokevirtual</span> <span class="c1">#3                  // Method java/io/PrintStream.println:(I)V</span>
</span></span><span class="line"><span class="cl">        <span class="o">//</span> <span class="n">void</span> <span class="err">类型返回</span> <span class="n">main方法执行结束</span>
</span></span><span class="line"><span class="cl">        <span class="mi">25</span><span class="p">:</span> <span class="k">return</span>
</span></span><span class="line"><span class="cl"><span class="o">//</span> <span class="o">...</span>
</span></span></code></pre></div><h2 id="方法区演进细节">方法区演进细节</h2>
<p>只有<code>Hotspot</code>才有永久代（方法区具体实现）。<code>BEA JRockit、IBMJ9</code>等来说，是不存在永久代的概念的。</p>
<table>
<thead>
<tr>
<th>JDK版本</th>
<th>方法区变化</th>
</tr>
</thead>
<tbody>
<tr>
<td>JDK1.6及以前</td>
<td>有永久代，字符串常量池、静态变量存储在永久代上</td>
</tr>
<tr>
<td>JDK1.7</td>
<td>有永久代，但已经逐步 “去永久代”，字符串常量池，静态变量移除，保存在堆中</td>
</tr>
<tr>
<td>JDK1.8</td>
<td>无永久代，类型信息，字段，方法，常量保存在本地内存的元空间，但字符串常量池、静态变量仍然在堆中</td>
</tr>
</tbody>
</table>
<p><img alt="Jdk1.6方法区变化" src="/posts/annex/images/essays/Jdk1.6%E6%96%B9%E6%B3%95%E5%8C%BA%E5%8F%98%E5%8C%96.png"></p>
<p><img alt="Jdk1.7方法区变化" src="/posts/annex/images/essays/Jdk1.7%E6%96%B9%E6%B3%95%E5%8C%BA%E5%8F%98%E5%8C%96.png"></p>
<p><img alt="Jdk1.8方法区变化" src="/posts/annex/images/essays/Jdk1.8%E6%96%B9%E6%B3%95%E5%8C%BA%E5%8F%98%E5%8C%96.png"></p>
<p><strong>为什么永久代要被元空间替代？</strong></p>
<p>根据官方的解释，替代是<code>JRockit</code>和<code>HotSpot</code>融合后的结果，因为<code>JRockit</code>没有永久代，所以<code>hotspot</code>用元空间替代了永久代。</p>
<p>由于类的元数据分配在本地内存中，元空间的最大可分配空间就是系统可用内存空间，这项改动是很有必要的，原因有：</p>
<ul>
<li>因为永久代设置空间大小是很难确定的。 在某些场景下，如果动态加载类过多，容易产生方法区的OOM。
比如某个实际Web工程中，因为功能点比较多，在运行过程中，要不断动态加载很多类，经常出现致命错误。而元空间和永久代之间最大的区别在于：元空间并不在虚拟机中，而是使用本地内存。 因此，默认情况下，元空间的大小仅受本地内存限制。</li>
<li>对永久代进行调优是很困难的。 因为FullGC的花费时间是MinorGC的10倍，所以我们可以降低GC的频率，尽量不让方法区执行GC来提高效率。
方法区的垃圾收集主要回收两部分内容：常量池中废弃的常量和不在使用的类型。</li>
</ul>
<p><strong>字符串常量池为什么要调整位置？</strong></p>
<p>JDK7中将<code>StringTable</code>放到了堆空间中。因为对永久代的回收效率很低，只有在Full GC的时候才会触发。
Full GC 是老年代的空间不足、永久代不足时才会触发。</p>
<p>这就导致<code>StringTable</code>回收效率不高。而我们开发中会有大量的字符串被创建，回收效率低，导致永久代内存不足。
所以JDK7之后将字符串常量池放到堆里，能及时回收内存，避免出现错误。</p>
<h2 id="方法区的垃圾回收">方法区的垃圾回收</h2>
<p>有些人认为JVM的方法区（如 Hotspot 虚拟机中的元空间或者永久代）是没有垃圾收集行为的，其实不然。
《Java虚拟机规范》对方法区的约束是非常宽松的，提到过可以不要求虚拟机在方法区中实现垃圾收集。
事实上也确实有未实现或未能完整实现方法区类型卸载的收集器存在（如JDK11时期的ZGC收集器就不支持类卸载）。</p>
<p>一般来说这个区域的回收效果比较难令人满意，尤其是类型的卸载，条件相当苛刻。但是这部分区域的回收有时又确实是必要的。
以前sun公司的Bug列表中，曾出现过的若干个严重的Bug就是由于低版本的HotSpot虚拟机对此区域未完全回收而导致内存泄漏。</p>
<p>方法区的垃圾收集主要回收两部分内容：常量池中废弃的常量和不再使用的类型。</p>
<p>方法区内运行时常量池之中主要存放的两大类常量：<strong>字面量</strong>和<strong>符号引用</strong>。
HotSpot虚拟机对常量池的回收策略是很明确的，只要常量池中的常量没有被任何地方引用，就可以被回收。
判定一个常量是否“废弃”还是相对简单，而要判定一个类型是否属于“不再被使用的类”的条件就比较苛刻了，需要同时满足下面三个条件：</p>
<ul>
<li>该类所有的实例都已经被回收，也就是Java堆中不存在该类及其任何派生子类的实例。加载该类的类加载器已经被回收，这个条件除非是经过精心设计的可替换类加载器的场景，如osGi、JSP的重加载等，否则通常是很难达成的。</li>
<li>该类对应的<code>java.lang.C1ass</code>对象没有在任何地方被引用，无法在任何地方通过反射访问该类的方法。</li>
<li>加载该类的类加载器已经被回收，这个条件除非是经过精心设计可替换类加载器的场景，如JSP、OSGi，否则通常很难达成。</li>
</ul>
<p>Java虚拟机被允许对满足上述三个条件的无用类进行回收，这里说的仅仅是“被允许”，而并不是和对象一样，没有引用了就必然会回收。
关于是否要对类型进行回收，HotSpot虚拟机提供了<code>-Xnoclassgc</code>参数进行控制，还可以使用<code>-verbose:class</code> 以及 <code>-XX：+TraceClass-Loading、-XX：+TraceClassUnLoading</code>查看类加载和卸载信息。</p>
<p>在大量使用反射、动态代理、CGLib等字节码框架，动态生成JSP以及OSGi这类频繁自定义类加载器的场景中，
通常都需要Java虚拟机具备类型卸载的能力，以保证不会对方法区造成过大的内存压力。</p>
<p><strong>符号引用是什么？</strong></p>
<p>符号引用是编译原理中的概念，是相对于直接引用来说的，主要包括了以下三类常量：</p>
<ul>
<li>类和接口的全限定名；</li>
<li>字段的名称和描述符；</li>
<li>方法的名称和描述符；</li>
</ul>
<p>符号引用以一组符号来描述所引用的目标。符号引用可以是任何形式的字面量，只要使用时能无歧义地定位到目标即可，符号引用和虚拟机的布局无关。</p>
<p>在编译的时候每个java类都会被编译成一个class文件，但在编译的时候虚拟机并不知道所引用类的地址，所以就用符号引用来代替，而在这个解析阶段就是为了把这个符号引用转化成为真正的地址的阶段。</p>
<p><strong>字面量是什么？</strong></p>
<p>在计算机科学中，字面量（literal）是用于表达源代码中一个固定值的表示法（notation）。
几乎所有计算机编程语言都具有对基本值的字面量表示，诸如：整数、浮点数以及字符串；
而有很多也对布尔类型和字符类型的值也支持字面量表示；还有一些甚至对枚举类型的元素以及像数组、记录和对象等复合类型的值也支持字面量表示法。</p>
</div>
                    <div id="post_footer" class="post_footer">
                        <div class="meta">

                            <div id="post_footer_info" class="info">
                                <span class="field tags">
                                    <i class="ri-stack-line"></i>
                                    
                                        
                                        <a href="https://blog.lijizhi.website/tags/java/">Java</a>
                                        
                                        <a href="https://blog.lijizhi.website/tags/jvm/">JVM</a>
                                        
                                    
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                <div id="doc_comments" class="doc_comments"></div>
                
            </div>
        </div>
    </div>
    
<a id="search-btn" style="display: inline-block;" href="javascript:void(0);">
    <span class="ri-search-line"></span>
</a>
<div id="fastSearch">
    <input id="searchInput" tabindex="0" autocomplete="off">
    <ul id="searchResults"></ul>
</div>
<div class="side_nav">
    
    <a id="top_to_back" href="#" class="top_to_back">
        <svg t="1688614744062" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2152" width="16" height="16"><path d="M966.4 323.2c-9.6-9.6-25.6-9.6-35.2 0l-416 416-425.6-416c-9.6-9.6-25.6-9.6-35.2 0-9.6 9.6-9.6 25.6 0 35.2l441.6 432c9.6 9.6 25.6 9.6 35.2 0l435.2-432C976 345.6 976 332.8 966.4 323.2z" p-id="2153" fill="#424242"></path></svg>    </a>
    
    <div>
        <a id="content_display" class="content_display">
            <svg t="1688606941910" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="57753" width="18" height="18"><path d="M192 448c10.9 0 21.8-4.2 30.2-12.5L497 160.8c5.4-5.4 11.8-6.2 15.1-6.2 3.3 0 9.6 0.8 15.1 6.2l274.7 274.7c16.7 16.7 43.7 16.7 60.3 0 16.7-16.7 16.7-43.7 0-60.3L587.4 100.4c-41.6-41.6-109.3-41.6-150.9 0L161.8 375.2c-16.7 16.7-16.7 43.7 0 60.3 8.4 8.3 19.3 12.5 30.2 12.5zM801.8 588.5L527.1 863.2c-5.4 5.4-11.8 6.2-15.1 6.2-3.3 0-9.7-0.8-15.1-6.2L222.2 588.5c-16.7-16.7-43.7-16.7-60.3 0-16.7 16.7-16.7 43.7 0 60.3l274.8 274.8c20.8 20.8 48.1 31.2 75.4 31.2 27.3 0 54.6-10.4 75.4-31.2l274.7-274.8c16.7-16.7 16.7-43.7 0-60.3-16.7-16.7-43.7-16.7-60.4 0z" fill="#424242" p-id="57754"></path></svg>
        </a>
        <a id="content_hidden" class="content_hidden">
            <svg t="1688603143752" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15592" width="18" height="18"><path d="M479.004101 645.938677L165.25229 958.480465a37.510709 37.510709 0 0 0 0 54.059551 36.47863 36.47863 0 0 0 53.063061 0l293.679668-292.576411 293.715256 292.576411a36.443042 36.443042 0 0 0 53.063061 0 37.510709 37.510709 0 0 0 0-54.059551l-313.751811-312.541788c-21.210989-22.349834-36.514219-24.698702-66.017424 0z m66.053013-267.877709l312.577377-312.541789a37.510709 37.510709 0 0 0 0-54.059551 36.443042 36.443042 0 0 0-53.063061 0l-292.505234 292.576411L219.560963 11.459628a36.47863 36.47863 0 0 0-53.063061 0 37.510709 37.510709 0 0 0 0 54.059551l312.577377 312.541789a46.58588 46.58588 0 0 0 65.981835-0.035589z" p-id="15593" fill="#424242"></path></svg>
        </a>
    </div>
    
    <a id="back_to_top" href="#" class="back_to_top">
        <svg t="1688628374733" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3166" width="16" height="16"><path d="M966.4 668.8l-435.2-432c-9.6-9.6-25.6-9.6-35.2 0l-441.6 432c-9.6 9.6-9.6 25.6 0 35.2 9.6 9.6 25.6 9.6 35.2 0l425.6-416 416 416c9.6 9.6 25.6 9.6 35.2 0S976 678.4 966.4 668.8z" p-id="3167" fill="#424242"></path></svg>
    </a>
</div>
    <footer class="footer">
    <div id="footer_powered_by" class="powered_by">
        <a href="https://varkai.com">Designed by VarKai,</a>
        <a href="http://www.gohugo.io/">Proudly published with Hugo</a>
    </div>

    <div id="footer_slogan" class="footer_slogan">
        <span>from 2020</span>
    </div>
</footer>
    <script src="https://blog.lijizhi.website/js/jquery-3.5.1.min.js"></script>
<link href="https://blog.lijizhi.website/css/fancybox.min.css" rel="stylesheet">
<script src="https://blog.lijizhi.website/js/fancybox.min.js"></script>
<script src="https://blog.lijizhi.website/js/darkmode.js"></script>
<script src="https://blog.lijizhi.website/js/zozo.js"></script>

<script src="https://blog.lijizhi.website/js/busuanzi_2.3_busuanzi.pure.mini.js"></script>
<script src="https://blog.lijizhi.website/js/html2canvas.js"></script>
<script src="https://blog.lijizhi.website/js/utils.js"></script>
<script src="https://blog.lijizhi.website/js/html2md.js"></script>
<script src="https://blog.lijizhi.website/js/htmlexport.js"></script>

<script src="https://blog.lijizhi.website/js/fastsearch.js"></script>
<script src="https://blog.lijizhi.website/js/fuse.js"></script>


<script>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
</script>


<script>
    
    document.addEventListener("DOMContentLoaded", function () {
        const uvE = document.getElementById('busuanzi_value_site_uv');
        const pvE = document.getElementById('busuanzi_value_site_pv');
        const uvObs = new MutationObserver((mutationsList) => {
            for (let mutation of mutationsList) {
                if (mutation.type === 'childList') {
                    uvObs.disconnect();
                    mutation.target.innerHTML = parseInt(mutation.target.innerHTML) + 57030;
                    break;
                }
            }
        });
        const pvObs = new MutationObserver((mutationsList) => {
            for (let mutation of mutationsList) {
                if (mutation.type === 'childList') {
                    pvObs.disconnect();
                    mutation.target.innerHTML = parseInt(mutation.target.innerHTML) + 203040;
                    break;
                }
            }
        });
        const config = {
            childList: true
        };
        uvObs.observe(uvE, config);
        pvObs.observe(pvE, config);
    });
</script>


<script>
    
    document.addEventListener('DOMContentLoaded', function() {
        var links = document.querySelectorAll('.content a');
        links.forEach(function(link) {
            link.setAttribute('target', '_blank');
        });
    });
</script>







  






</body>

</html>