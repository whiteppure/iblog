<!DOCTYPE html>
<html lang="zh" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="google-site-verification" content="tVxoyWMeaEzEUV0EzY1STfJXZWaZ8WM-i-a8AWBri0o" />
    <meta name="msvalidate.01" content="48159A4EAF3C3F448369E581664B1A21" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="whitepure" />
	
	
	
	<title>分布式事务详解 ｜ 脚踏实地</title>
	
    
    
    <meta name="description" content="概览 什么是事务？举个例子，你去超市买东西，&amp;ldquo;一手交钱，一手交货&amp;quot;就是一个事务的例子。 交钱和交货必须同时成功，事务才算成功，其中有一个环节失" />
    

    
    
    <meta name="keywords" content="whitepure博客, whiteppure, whitepure, Java, 博客, 技术博客" />
    

	

    <link rel="shortcut icon" href="https://blog.lijizhi.website/images/favicon.ico" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://blog.lijizhi.website/css/normalize.css" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://blog.lijizhi.website/css/animate.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://blog.lijizhi.website/css/zozo.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://blog.lijizhi.website/css/remixicon.css" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://blog.lijizhi.website/css/highlight.css" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://blog.lijizhi.website/css/toc.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://blog.lijizhi.website/css/search.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://blog.lijizhi.website/css/img.css" />

    
    
</head>

<body>
    <div class="post-password">
        
    </div>

    
    
    









<div id="post_content_toc" class="toc">
    <div class="page-header"><strong></strong></div>
    <div id="page-scrollspy" class="toc-nav">

        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e6%a6%82%e8%a7%88">
                    概览
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e5%9f%ba%e7%a1%80">
                    分布式事务基础
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#cap%e7%90%86%e8%ae%ba">
                    CAP理论
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#base%e7%90%86%e8%ae%ba">
                    BASE理论
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e8%a7%a3%e5%86%b3%e6%96%b9%e6%a1%88">
                    分布式事务解决方案
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#2pc">
                    2PC
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#xa%e6%96%b9%e6%a1%88">
                    XA方案
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#seata%e6%96%b9%e6%a1%88">
                    Seata方案
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#tcc">
                    TCC
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#hmily%e6%96%b9%e6%a1%88">
                    Hmily方案
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e5%8f%af%e9%9d%a0%e6%b6%88%e6%81%af%e6%9c%80%e7%bb%88%e4%b8%80%e8%87%b4%e6%80%a7">
                    可靠消息最终一致性
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e6%9c%ac%e5%9c%b0%e6%b6%88%e6%81%af%e8%a1%a8%e6%96%b9%e6%a1%88">
                    本地消息表方案
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#rocketmq%e6%96%b9%e6%a1%88">
                    RocketMQ方案
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e6%9c%80%e5%a4%a7%e5%8a%aa%e5%8a%9b%e9%80%9a%e7%9f%a5">
                    最大努力通知
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#mq%e6%96%b9%e6%a1%881">
                    MQ方案1
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#mq%e6%96%b9%e6%a1%882">
                    MQ方案2
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        

    </div>
</div>



    

    
    <div class="main animate__animated animate__fadeInDown" id="main_content">
        <div class="nav_container animated fadeInDown">
    <div class="site_nav" id="site_nav">
        <ul><li class="">
                <a href="https://blog.lijizhi.website/">首页</a>
            </li><li class="">
                <a href="https://blog.lijizhi.website/posts/">归档</a>
            </li><li class="">
                <a href="https://blog.lijizhi.website/tags/">标签</a>
            </li><li class="">
                <a href="https://blog.lijizhi.website/about/">关于</a>
            </li>
        </ul>
    </div>
    <div class="menu_icon">
        <a id="menu_icon"><i class="ri-menu-line"></i></a>
    </div>
</div>
        <div id="post_header" class="header animated fadeInDown">
    <div class="site_title_container">
        <div class="site_title">
            <h1>
                <a href="https://blog.lijizhi.website/">
                    <span>脚踏实地</span>
                </a>
            </h1>
        </div>
        <div class="description">
            <p class="sub_title">
                
            </p>

            
            <div class="my_socials">
                
                    
                    <a href="https://github.com/whiteppure/" title="github" target="_blank">
                        <i class="ri-github-fill"></i>
                    </a>
                    
                
                <a href="https://blog.lijizhi.website/index.xml" type="application/rss+xml" title="rss" target="_blank">
                    <i class="ri-rss-fill"></i>
                </a>
                
                
                <span id="sys_function" class="sys_function display_none">
                    <a id="export_pdf"  title="导出pdf" style="border: none; cursor: pointer; margin-left: 10px">
                        <svg t="1688701481347" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3517" width="16" height="16"><path d="M425.610455 85.814544H149.05897A42.303635 42.303635 0 0 0 106.6274 128.075535V896.492068c0 23.326702 18.976933 42.26099 42.43157 42.26099h682.743143a42.559504 42.559504 0 0 0 42.431569-42.559504v-384.016365a42.644793 42.644793 0 0 1 85.289587 0v384.016365A127.849091 127.849091 0 0 1 831.802113 1024H149.05897A127.635867 127.635867 0 0 1 21.337813 896.449423V128.03289A127.593222 127.593222 0 0 1 149.101614 0.524957h276.466196a42.644793 42.644793 0 0 1 0 85.289587z m564.062683 158.08425l-170.579174 170.579173a42.644793 42.644793 0 1 1-60.299738-60.299738L856.578738 256.393718H618.364922a42.644793 42.644793 0 1 1 0-85.289587h238.213816l-97.784512-97.784511A42.644793 42.644793 0 1 1 819.093964 13.019882l170.579174 170.579174a42.644793 42.644793 0 0 1 0 60.299738zM149.272194 597.552066a42.644793 42.644793 0 0 1 42.644793-42.644794h51.514911c59.190973 0 107.891327 23.284057 107.976617 97.102195 0 71.003581-49.46796 102.347504-106.185536 102.347504h-31.343923v66.781747a32.282109 32.282109 0 0 1-64.606862 0V597.552066z m92.709781 100.215264c31.429213 0 46.568114-16.46089 46.568114-45.757863 0-30.064579-17.313786-40.512554-48.359196-40.512554h-26.311837v86.270417h28.145563z m232.414124-142.860058c81.878003 0 136.036891 43.710913 136.036891 147.67892S556.231457 853.420826 477.935617 853.420826h-38.16709a42.644793 42.644793 0 0 1-42.644794-42.644793v-213.223967a42.644793 42.644793 0 0 1 42.644794-42.644794h34.542282z m-4.008611 240.729859c43.32711 0 73.988717-22.047358 73.988717-93.050939 0-71.046226-30.704251-90.705476-73.988717-90.705476h-8.699538v183.79906h8.699538zM692.481573 853.420826a32.282109 32.282109 0 0 1-32.282109-32.282108V597.552066a42.644793 42.644793 0 0 1 42.644793-42.644794h99.063855a29.680776 29.680776 0 1 1 0 59.404197h-77.144431v65.374469h61.749661a29.894 29.894 0 1 1 0 59.788h-61.749661v81.66478a32.282109 32.282109 0 0 1-32.282108 32.282108z" fill="#5f5f5f" p-id="3518"></path></svg>
                    </a>
                    <a id="export_pic" title="导出图片" style="border: none; cursor: pointer; margin-left: 10px">
                        <svg t="1689071509720" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4564" width="16" height="16"><path d="M909.132886 0.037506h-184.960611a33.909445 33.909445 0 0 0-32.368107 33.909445 33.909445 33.909445 0 0 0 33.909445 33.395666h158.244078l-200.373995 199.346437a33.395666 33.395666 0 0 0 0 47.781491 31.854327 31.854327 0 0 0 23.633856 9.76181 33.909445 33.909445 0 0 0 24.147635-9.76181l198.832657-199.346437V272.340628a33.909445 33.909445 0 0 0 69.874009 0V88.921355A88.37007 88.37007 0 0 0 909.132886 0.037506zM216.558153 347.866211a107.37991 107.37991 0 1 0 107.37991-107.379911 107.89369 107.89369 0 0 0-107.37991 107.379911z m154.133843 0a51.377948 51.377948 0 0 1-97.618101 0 51.377948 51.377948 0 1 1 97.618101 0z" p-id="4565" fill="#424242"></path><path d="M963.079731 437.777619a34.423225 34.423225 0 0 0-33.909446 33.909445v265.110209a1811.07265 1811.07265 0 0 0-137.692899-193.181082 106.352351 106.352351 0 0 0-78.60826-36.478343 123.820854 123.820854 0 0 0-82.204716 35.964563l-3.596456 3.082677-188.557068 176.74014c-11.816928-13.358266-47.781491-51.377948-82.204716-87.856291a83.232275 83.232275 0 0 0-85.801172-21.578738 105.324792 105.324792 0 0 0-38.019681 19.52362l-141.289356 121.765736V89.948914a22.092517 22.092517 0 0 1 22.606297-22.606297h417.702713a33.395666 33.395666 0 0 0 33.395666-33.909445 33.395666 33.395666 0 0 0-33.395666-33.395666H113.802258A89.911408 89.911408 0 0 0 23.89085 89.948914v844.139678a89.911408 89.911408 0 0 0 89.911408 89.911408h793.27551a89.911408 89.911408 0 0 0 89.397629-89.911408v-462.401528a33.909445 33.909445 0 0 0-33.395666-33.909445z m-33.909446 496.310973a22.606297 22.606297 0 0 1-22.092517 22.606297H113.802258a22.606297 22.606297 0 0 1-22.606297-22.606297v-88.37007l183.933052-160.812976a43.157476 43.157476 0 0 1 15.413385-7.192912 15.927164 15.927164 0 0 1 17.982281 5.137794c37.505902 36.478343 78.60826 83.232275 82.718496 87.856291a61.653537 61.653537 0 0 0 42.643696 22.092517 62.681096 62.681096 0 0 0 51.377948-20.037399c8.220472-8.220472 134.610223-125.875971 194.208641-181.877935a57.029522 57.029522 0 0 1 34.423225-16.440943 45.212594 45.212594 0 0 1 29.79921 15.927164 2954.231982 2954.231982 0 0 1 186.501949 256.889738z" p-id="4566" fill="#424242"></path></svg>
                    </a>
                    <a id="export_markdown" title="导出markdown" style="border: none; cursor: pointer; margin-left: 10px">
                        <svg t="1689071035200" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="13570" width="16" height="16"><path d="M178.073367 843.957262V461.158929h107.121045l107.121045 140.734874 107.125433-140.734874h107.116657v382.798333h-107.116657v-219.54307l-107.125433 140.730486-107.116657-140.730486v219.54307zM737.783131 892.148786l-131.221196-209.156132h87.479334V461.158929h87.479335v221.833725h87.483722z" p-id="13571" fill="#424242"></path><path d="M911.9958 217.142709c10.672172 10.663395 19.812851 25.144549 27.430816 43.430297 7.617965 18.285748 11.431335 35.044392 11.431336 50.28471V969.140255c0 15.235929-5.336086 28.18998-15.999481 38.853375-10.667783 10.667783-23.621834 16.003869-38.857763 16.003869H127.994904c-15.240317 0-28.18998-5.336086-38.857763-16.003869-10.663395-10.663395-15.999481-23.617446-15.999481-38.853375V54.852856c0-15.240317 5.331698-28.18998 15.999481-38.857763C99.804925 5.336086 112.758975 0 127.999292 0h512.000944c15.235929 0 31.998962 3.808982 50.28471 11.426947 18.285748 7.622353 32.762514 16.763033 43.430297 27.426428zM658.290372 77.715526v214.856442h214.856442c-3.808982-11.049559-7.99974-18.856218-12.572275-23.43314l-178.855415-178.851027c-4.572534-4.572534-12.383581-8.763292-23.43314-12.572275z m219.428976 873.143369V365.71496h-237.714724c-15.240317 0-28.18998-5.336086-38.857763-15.999481-10.663395-10.667783-15.999481-23.621834-15.999481-38.857763V73.142992H146.28504v877.715903z" p-id="13572" fill="#424242"></path></svg>
                    </a>
                    <a id="export_doc" title="导出文档" style="border: none; cursor: pointer; margin-left: 10px">
                        <svg t="1689246982401" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6825" width="16" height="16"><path d="M270.76864 608.32h180.8a31.68 31.68 0 0 0 0-62.976H270.76864a31.68 31.68 0 0 0 0 62.976zM271.34464 458.56h457.92a33.472 33.472 0 0 0 31.552-34.752 33.28 33.28 0 0 0-31.552-34.624H271.34464a34.816 34.816 0 0 0 0 69.376zM271.34464 293.504h457.92a33.344 33.344 0 0 0 31.552-34.688 33.216 33.216 0 0 0-31.552-34.624H271.34464a33.28 33.28 0 0 0-31.616 34.624 33.28 33.28 0 0 0 31.616 34.688z" p-id="6826" fill="#424242"></path><path d="M869.87264 0H153.77664A70.4 70.4 0 0 0 84.65664 70.912V953.6A69.952 69.952 0 0 0 153.77664 1024h370.048a32 32 0 0 0 0-63.68H147.12064V64h729.6v468.672a31.296 31.296 0 1 0 62.528 0V70.912A70.4 70.4 0 0 0 869.87264 0z" p-id="6827" fill="#424242"></path><path d="M482.16064 730.624h337.664L715.82464 625.216a28.864 28.864 0 0 1-7.936-28.736 29.184 29.184 0 0 1 20.608-21.184 29.632 29.632 0 0 1 29.12 8.128l174.784 177.216-174.784 176.96a29.184 29.184 0 0 1-49.728-13.312 29.248 29.248 0 0 1 8-28.8l103.936-105.344H482.16064a29.696 29.696 0 0 1-29.504-29.76 29.632 29.632 0 0 1 29.504-29.76z" p-id="6828" fill="#424242"></path></svg>
                    </a>
                </span>
                <a  id="icon_more" title="更多" >
                    <svg t="1688715321313" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5356" width="16" height="16"><path d="M483.555556 199.111111m-85.333334 0a85.333333 85.333333 0 1 0 170.666667 0 85.333333 85.333333 0 1 0-170.666667 0Z" fill="#424242" p-id="5357"></path><path d="M483.555556 540.444444m-85.333334 0a85.333333 85.333333 0 1 0 170.666667 0 85.333333 85.333333 0 1 0-170.666667 0Z" fill="#424242" p-id="5358"></path><path d="M483.555556 881.777778m-85.333334 0a85.333333 85.333333 0 1 0 170.666667 0 85.333333 85.333333 0 1 0-170.666667 0Z" fill="#424242" p-id="5359"></path></svg>
                </a>
                <a  id="icon_less" class="display_none">
                    <svg t="1688723160472" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15872" width="16" height="16"><path d="M300.105143 592.676571h423.789714a80.676571 80.676571 0 1 0 0-161.353142H300.105143a80.676571 80.676571 0 0 0 0 161.353142z" fill="#8a8a8a" p-id="15873"></path></svg>
                </a>
                
            </div>

            
            <div class="post">
                <div class="post_title post_detail_title">
                    <span class="date" id="busuanzi_container_site_pv">访问量 <span id="busuanzi_value_site_pv">...</span> 次</span>
                </div>
                <div class="post_title post_detail_title">
                    <span class="date" id="busuanzi_container_site_uv">访客数 <span id="busuanzi_value_site_uv">...</span> 人</span>
                </div>
            </div>
            

            <div class="post">
                <div class="post_title post_detail_title">
                    
                    <span class="date">总文章数 190 篇</span>
                </div>
                <div class="post_title post_detail_title">
                    
                    
                    
                    
                    
                    <span class="date">博客已运行 2026 天</span>
                </div>
            </div>

        </div>
    </div>
</div>
        <div class="content">
            <div class="post_page">
                <div class="post animate__animated animate__fadeInDown">
                    <div class="post_title post_detail_title">
                        <h2 id="post_single_title">分布式事务详解</h2>
                        <span id="post_page_title_date" class="date">2021.08.02</span>





                    </div>
                    <div class="post_content markdown"><h2 id="概览">概览</h2>
<p>什么是事务？举个例子，你去超市买东西，&ldquo;一手交钱，一手交货&quot;就是一个事务的例子。
交钱和交货必须同时成功，事务才算成功，其中有一个环节失败，事务将会撤销所有已成功的活动。
所以事务可以看作是一次重大的活动，它由不同的小活动组成，这些活动要么全部成功，要么全部失败。</p>
<p>在计算机系统中，更多的是通过关系型数据库来控制事务，这是利用数据库本身的事务特性来实现的，因此叫做数据库事务。
由于应用程序主要靠关系型数据库来控制事务，而数据库通常和应用在同一个服务器上，所以基于关系型数据库的事务又叫做本地事务。</p>
<p>数据库事务的四大特性ACID：</p>
<ul>
<li>A（<code>Atomic</code>）：原子性，构成事务的所有操作，要么都执行完，要么全不执行，不可能出现部分成功部分失败的情况。</li>
<li>C（<code>Consistency</code>）：一致性，在事务执行前后，数据库的一致性约束没有被破坏。比如：张三向李四转100元，转账前和转账后的数据正确状态这叫一致性，如果出现张三转100元，李四账户没有增加100元这就出现了数据错误，就没有达到一致性。</li>
<li>I（<code>Isolation</code>）：隔离性，数据库中事务都是并发的，隔离性是指并发的两个事务的执行互不干扰，一个事务不能看到其他事务运行过程的中间状态。通过配置事务的隔离级别可以避免脏读、重复读等问题。</li>
<li>D（<code>Durability</code>）：持久性，事务执行完毕后，该事务对数据的更改会被持久化到数据库，且不会被回滚。</li>
</ul>
<p>数据库事务在实现时，会将一次事务涉及的所有操作全部纳入到一个不可分割的执行单元，该执行单元中的所有操作要么都成功，要么都失败，只要其中任一操作执行失败，都将会导致事务回滚。</p>
<p>随着互联网的发展，软件系统由原来的单体应用转变为分布式应用。分布式系统会把一个应用系统拆分为多个可独立部署的程序，因此需要服务与服务之间的远程协作才能完成事务操作，这种分布式系统环境下由不同服务之间通过网络协作完成的事务被称为分布式事务。
例如，用户注册送积分、创建订单减少库存、银行转账事务等。</p>
<p>本地事务与分布式事务：</p>
<ol>
<li>本地事务：
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">begin transation;
</span></span><span class="line"><span class="cl">// 1.本地数据库操作：张三减少金额
</span></span><span class="line"><span class="cl">// 2.本地数据库操作：李四增加金额
</span></span><span class="line"><span class="cl">commit transation;
</span></span></code></pre></div></li>
<li>分布式事务：
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">begin transation;
</span></span><span class="line"><span class="cl">// 1.本地数据库操作：张三减少金额
</span></span><span class="line"><span class="cl">// 2.远程调用：李四增加金额
</span></span><span class="line"><span class="cl">commit transation;
</span></span></code></pre></div></li>
</ol>
<p>在<code>2.分布式事务</code>中如果李四增加金额成功，但是由于网络原因，远程调用并没有返回，此时本地事务提交失败就会回滚张三减少金额的操作，张三李四的金额就不一致了。
因此在分布式架构的基础上，传统数据库事务就无法使用了，张三和李四的账户不在同一个数据库中甚至不在一个系统中，实现转账事务需要通过远程调用，但由于网络的问题就会导致分布式事务问题。</p>
<p>分布式事务产生场景：</p>
<ol>
<li>最典型的是微服务架构，微服务之间通过远程调用完成事务操作。比如，订单微服务和库存微服务，下单的同时订单微服务请求库存微服务减少库存。简而言之，就是跨JVM进程产生的分布式事务。</li>
<li>单体系统访问多个数据库实例，就会产生分布式事务。比如，用户和订单信息分别存储在两个MySQL中，用户管理系统删除用户信息，需要分别删除用户信息及用户的订单信息，由于数据分布在不同的数据库，就需要通过不同的数据库连接去操作数据，此时产生分布式事务。</li>
<li>多个微服务访问同一个数据库实例。比如，订单微服务和库存微服务即使访问同一个数据库也会产生分布式事务，原因是跨JVM进程，两个微服务持有了不同的数据库连接进行数据库操作，此时产生分布式事务。</li>
</ol>
<h2 id="分布式事务基础">分布式事务基础</h2>
<p>分布式事务之所以叫做分布式事务，是因为提供服务的各个结点分布在不同的机器上，相互之间通过网络交互。不能因为有网络问题就导致整个系统无法提供服务，网络因素成了分布式事务的考量标准之一。因此，分布式事务需要更进一步的理论支持。</p>
<h3 id="cap理论">CAP理论</h3>
<p>CAP是<code>Consistency</code>、<code>Availability</code>、<code>Partition tolerance</code>三个词语的缩写，分别表示一致性、可用性、分区容忍性。</p>
<p>为了方便对CAP理论的理解，结合电商系统中的一些业务场景来理解CAP，如下图是商品信息管理的执行流程：</p>
<ul>
<li>商品服务请求主数据库写入商品信息（增、删、改）；</li>
<li>主数据库向商品服务响应写入成功；</li>
<li>商品服务请求从数据库获取商品信息；</li>
</ul>
<p><img alt="分布式事务-001" src="/posts/annex/images/essays/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-001.png"></p>
<ul>
<li>C（<code>Consistency</code>）：一致性是指写操作后的读操作可以读取到最新的数据状态，当数据分布在多个结点上，从任意结点读取到的数据都是最新状态。
上图中，商品的信息的读写要满足一致性就是要实现如下目标：1.商品服务写入主数据库成功，则向从数据查询新数据也成功；2.商品服务写入主数据库失败，则向从数据查询新数据也失败；
这里一致性指的就是主从数据库数据的一致性。在写入主数据库后，将数据同步到从数据库，并在同步期间锁定从数据库，来防止在数据同步完成之前查询到旧数据。
分布式系统中，一致性的特点在于写操作的响应可能会有延迟，因为数据库同步的过程中需要暂时锁定资源，需要待同步完成后再释放锁定的资源。</li>
<li>A（<code>Availability</code>）：可用性是指任何事务操作都可以获得响应结果，且不会出现响应超时或响应错误。
上图中，商品信息的读取满足可用性就是要实现如下目标：1.从数据库接收到数据查询的请求则立即能够响应数据的查询结果；2.从数据库不允许出现响应超时或响应错误的情况；
写入主数据库后要将数据数据同步到从数据库，但由于要保证从数据库的可用性，不可将从数据库中的资源进行锁定。
即使数据还没有从主数据库同步过来，从数据库也要返回查询的数据，哪怕是旧数据，如果连旧数据也没有则可以按照约定返回一个默认信息，但不能返回错误或超时。
分布式系统可用性的特点就是所有请求都要有响应，且不会出现响应超时或响应错误。</li>
<li>P（<code>Partition tolerance</code>）：分布式系统的各个结点部署在不同的子网，这就是网络分区，不可避免的会出现由于网络问题而导致结点之间的通信失败，此时仍可以对外提供服务，这就是分区容忍性。
上图中，商品信息的读写满足分区容忍性就是要实现如下目标：1.主数据库向从数据库同步数据失败，不影响读写操作；2.其中一个结点挂掉不影响另外一个结点提供服务；
实现分区容忍性尽量使用异步取代同步操作，例如使用异步的方法将数据从数据库同步到从数据库，这样的结点之间才能有效的解耦合。添加从数据库结点，其中一个从数据结点挂掉其他从结点来提供服务。分区容忍性是分布式系统具备的基本的能力。</li>
</ul>
<p>在所有分布式事务场景中不会同时具备CAP三个特征，因为在具备了P的前提下C和A是不能共存的。</p>
<p>例如，下图满足了P分区容忍性
<img alt="分布式事务-001" src="/posts/annex/images/essays/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-001.png"></p>
<ul>
<li>主数据库通过网络向从数据库同步数据，可以认为是主从数据库部署在不同的网络分区，通过网络进行交互</li>
<li>当主数据库和从数据库之间网络出现问题，不影响主数据库和从数据库对外提供服务</li>
<li>其中一台结点挂掉后，不影响另外一个结点对外提供服务</li>
</ul>
<p>在分区容忍性存在的前提下，一致性和可用性存在矛盾：</p>
<ul>
<li>如果要实现一致性，则必须保证数据一致性，在数据同步的时候防止向从数据库查询不一致的数据则需要将从数据库数据锁定，待同步完成后解锁，如果同步失败，从数据库必须要返回错误信息或者超时信息。</li>
<li>如果要实现可用性则必须保证数据可用性，即不管任何时候都可以向从数据库查询数据，且不会响应超时信息或错误信息。</li>
</ul>
<p>在分布式的环境下，一致性和可用性只能存在一种，即AP、CP：</p>
<ul>
<li>AP：放弃一致性，追求分区容忍性和可用性。这是很多分布式系统设计时的选择。</li>
<li>CP：放弃可用性，追求一致性和分区容忍性。<code>zookeeper</code>就是一个追求强一致性的例子；例如，跨行转账，一次转账请求需要等待双方银行都完成整个事务才算完成。</li>
</ul>
<p>如果不在分布式的环境下，一致性和可用性其实是不矛盾的：</p>
<ul>
<li>CA：放弃分区容忍性，即不进行分区，不考虑网络结点不通畅或者结点挂掉的情况，则可以实现一致性和可用性。那么系统将不是一个标准的分布式系统，最常用的关系型数据库就满足了CA。</li>
</ul>
<p>CAP是一个已经被证实的理论，一个分布式系统最多只能同时满足一致性、可用性、分区容忍性中的两种。它可以作为我们进行架构设计、技术选型的考量标准。对于大型互联网应用场景来说，结点众多、部署分散，而且现在的集群规模越来越大，所以结点故障、网络故障是常态，而且要保证服务可用性达到N个9（99.99..%），并要达到良好的响应性能来提高用户的体验。
因此一般都会做出以下选择，保证可用性和分区容忍性即AP，舍弃C，强一致性，保证最终一致性。</p>
<h3 id="base理论">BASE理论</h3>
<p>CAP理论说明一个分布式系统最多能同时满足一致性、可用性、分区容忍性这三项中的两项。其中AP在实际应用中比较多，AP舍弃一致性，保证可用性和分区容忍性，但是在实际生产中很多场景都要实现一致性，比如主数据库向从数据库同步数据，即使不要一致性，但是最终也要将数据同步成功来保证数据一致，这种一致性和CAP中的一致性不同。
CAP中的一致性要求在任何时间查询每个结点数据都必须保证一致，但是最终一致性是允许在一段时间内每个结点数据不一致，经过一段时间后每个结点的数据必须一致，它强调的是数据的最终一致性。</p>
<p>BASE理论强调的就是最终一致性，BASE是<code>Basically Available</code>(基本可用)、<code>Soft state</code>(软状态)、<code>Eventually consistent</code>(最终一致性) 这三个短语的缩写。
BASE理论是对于CAP中AP的一个扩展，通过牺牲强一致性来获得可用性，当出现故障允许的部分不可用但要保证核心功能可用，允许数据在一段时间内是不一致的，但最终达到一致的状态。满足BASE理论的事务，我们称之为柔性事务。</p>
<ul>
<li>基本可用：分布式系统出现故障时，允许损失部分可用的功能，保证核心功能可用。例如，电商网站交易付款出现问题，商品依然可以正常浏览。</li>
<li>软状态：由于不要求强一致性，所以BASE允许系统中存在中间状态（软状态），这个状态不影响系统的可用性。例如，订单的&quot;支付中、数据同步中&quot;等状态，待数据最终一致后状态改为&quot;成功&quot;状态。</li>
<li>最终一致性：最终一致是指经过一段时间后，所有的结点数据将会达到一致。例如，订单的&quot;支付中&quot;状态，最终会变为&quot;支付成功&quot;或&quot;支付失败&rdquo;，使订单状态与交易结果达成一致，但需要一定的时间等待。</li>
</ul>
<h2 id="分布式事务解决方案">分布式事务解决方案</h2>
<p>针对不同的分布式场景常见的解决方案有2PC、TCC、可靠消息最终一致性、最大努力通知这几种。</p>
<table>
<thead>
<tr>
<th>解决方案</th>
<th>描述</th>
<th>优点</th>
<th>缺点</th>
<th>适用场景</th>
</tr>
</thead>
<tbody>
<tr>
<td>2PC (Two-Phase Commit)</td>
<td>一种经典的分布式事务协议，确保所有参与者要么全部提交，要么全部回滚。</td>
<td>确保了事务的原子性，事务一致性较强。</td>
<td>协调者崩溃或参与者崩溃可能导致事务不一致或阻塞。</td>
<td>需要强一致性保证的场景。</td>
</tr>
<tr>
<td>TCC (Try-Confirm-Cancel)</td>
<td>通过预留资源、确认提交或取消操作来保证分布式事务的一致性。</td>
<td>相比2PC更具弹性，支持更高的可用性和容错性。</td>
<td>实现复杂，需处理预留资源和取消操作的逻辑。</td>
<td>适用于需要灵活处理和补偿的场景。</td>
</tr>
<tr>
<td>可靠消息最终一致性</td>
<td>通过消息中间件保证消息可靠投递，最终实现数据一致性。</td>
<td>高可用性，适用于网络中断和系统崩溃情况，能够实现最终一致性。</td>
<td>消息处理可能会出现延迟，需要处理重复消息和消息丢失等问题。</td>
<td>数据一致性需求不那么强，但需容忍最终一致性的场景。</td>
</tr>
<tr>
<td>最大努力通知</td>
<td>通过尽最大努力发送消息，尝试确保消息到达，但不保证最终一致性。</td>
<td>实现简单，性能开销小，适用于不严格要求一致性的场景。</td>
<td>消息可能会丢失或重复处理，无法保证一致性。</td>
<td>不需要严格一致性的场景，如日志记录等。</td>
</tr>
</tbody>
</table>
<p>2PC最大的诟病是一个阻塞协议。RM在执行分支事务后需要等待MT决定，此时服务会堵塞并锁定资源，由于其堵塞机制和最差时间复杂度较高，因此这种设计不能适应随着事务涉及的服务数量增多而扩展的需要，很难用于并发较高以及事务生命周期较长的分布式服务中。</p>
<p>如果拿TCC的事务处理流程与2PC做比较，2PC通常都是在跨库的DB层面，而TCC则在应用层面的处理，需要通过业务逻辑来实现。这种分布式事务的实现方式优势在于，可以让应用自己定义数据库操作的粒度，使得降低锁冲突、提高吞吐量。不足之处是对应用的侵入性非常强，业务逻辑的每个分支都要实现try、confirm、cancel三个操作；此外实现难度也比较大，需要按照网络状态、系统故障的等不同失败原因进行不同回滚策略。</p>
<p>可靠消息最终一致性适合执行周期长且实时性要求不高的业务场景。引入消息机制后，同步的事务操作变为基于消息执行的异步操作，避免了分布式事务中同步堵塞操作的影响，并实现了两个服务之间的解耦。</p>
<p>最大努力通知是分布式事务中要求最低的一种，适用于一些最终一致性时间敏感度低的业务；允许发起通知方处理失败，在接收通知方收到失败通知后积极进行失败处理，无论发起通知方如何处理结果都不会影响到接收方的后续处理；发起通知方需要提供查询执行情况的接口，用于接收通知方校对结果。</p>
<p>在实际开发中，可靠消息最终一致性是较为常见的解决方案，特别是在微服务架构和高并发场景中，它能够提供较好的灵活性和扩展性。如果对于需要严格事务保证的系统，2PC和TCC可以提供更强的一致性保障。</p>
<h3 id="2pc">2PC</h3>
<p>2PC即两阶段提交协议，是将整个事务流程分为两个阶段：准备阶段（<code>Prepare</code>）、提交阶段（<code>Commit</code>）。</p>
<p>举例，张三、李四聚餐，饭店老板要求先买单才能出票。张三李四都不愿请客，只能AA。只有张三和李四都付款，老板才能出票安排就餐。
准备阶段，老板要求张三付款，张三付款；老板要求李四付款，李四付款；提交阶段：老板出票，两人拿票纷纷入座就餐。</p>
<p>例子中形成了一个事务，若张三或李四其中一人拒绝付款，或者钱不够，老板都不会出票，并且把已收的钱退回。
整个事务过程由事务管理器和参与者组成，老板就是事务管理器，张三、李四就是事务参与者，事务管理器负责抉择整个分布式事务的提交和回滚，事务参与者负责自己的本地事务提交和回滚。</p>
<p>在计算机中部分关系型数据库如Oracle、MySql支持两阶段提交协议：</p>
<ol>
<li>准备阶段：事务管理器给每个参与者发送<code>Prepare</code>消息，每个数据库参与者执行本地事务，并写本地的<code>Undo/Redo</code>日志，此时事务还没有提交。
<blockquote>
<p>Undo日志是记录修改前的数据，用于数据库回滚；Redo日志是记录修改后的数据，用于提交事务后写入数据文件。</p>
</blockquote>
</li>
<li>提交阶段：如果事务管理器收到了参与者的执行失败或超时的消息，那么直接给每个参与者发送回滚消息；否则，发送提交消息。参与者根据事务管理器的指令执行提交或回滚的操作，并释放事务处理过程中使用的锁资源。</li>
</ol>
<p>成功情况：
<img alt="分布式事务-002" src="/posts/annex/images/essays/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-002.png"></p>
<p>失败情况：
<img alt="分布式事务-003" src="/posts/annex/images/essays/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-003.png"></p>
<h4 id="xa方案">XA方案</h4>
<p>2PC的传统方案是在数据库层面实现的，如<code>Oracle</code>、<code>MySql</code>都支持2PC协议。为了统一标准减少行业内不必要的对接成本，需要制定标准化的处理模型即接口标准，国际开放标准组织<code>OpenGroup</code>定义了分布式处理模型DTP(<code>Distributed Transaction Processing Reference Model</code>)。</p>
<p>DTP模型定义如下角色：</p>
<ul>
<li>AP：<code>Application Program</code>即应用程序，可以理解为使用分布式事务的程序。</li>
<li>RM：<code>Resource Manager</code>即资源管理器，可理解为事务的参与者，一般情况是指一个数据库实例，通过资源管理器对该数据库进行控制，资源管理器控制这分支事务。</li>
<li>TM：<code>Transacition Manager</code>即事务管理器，负责协调事务和事务管理，它控制着<strong>全局的事务</strong>，管理事务的生命周期，并协调各个资源管理器。
<blockquote>
<p>全局事务是指分布式处理事务环境中，需要操作多个数据库共同完成一个动作，这个工作即是一个全局事务。</p>
</blockquote>
</li>
</ul>
<p>以新用户注册送积分为例：
<img alt="分布式事务-004" src="/posts/annex/images/essays/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-004.png"></p>
<p>执行流程如下：</p>
<ol>
<li>应用程序持有数据库和积分库两个数据源。</li>
<li>应用程序通过事务管理器通知用户库的资源管理器新增用户，同时也通知积分库的资源管理器为该用户增加积分，资源管理器此时并未提交事务，此时用户和积分资源锁定。</li>
<li>事务管理器收到执行回复，只要有一方失败则分别向其他方发起事务回滚，回滚完毕，资源释放锁；或事务管理器收到执行回复，全部成功，此时向所有资源管理器发起提交事务，提交完毕，资源释放。</li>
</ol>
<p>整个2PC的事务管理流程涉及到三个角色：AP、RM、TM。AP指的是使用2PC分布式事务的应用程序；RM指的是资源管理器，它控制这分支事务；TM指的是事务管理器，它控制着全局事务。三个角色之间的交互方式如下：</p>
<ul>
<li>TM向AP提供程序编程接口，AP通过TM提交或回滚事务；</li>
<li>TM交易中间件通过XA接口来通知RM数据库事务的开始、结束以及提交、回滚等；</li>
</ul>
<p>在准备阶段RM执行实际的业务操作，但是不提交事务，资源锁定。在提交阶段TM会接受RM在准备阶段的执行回复，只要任何一个RM执行失败，TM会通知所有的RM进行回滚操作，否则TM将会通知RM提交事务，提交阶段结束释放资源。</p>
<p>DTP模型定义TM和RM之间通讯的接口规范叫XA，简单理解为数据库提供的2PC接口协议，基于数据库的XA协议来实现2PC又称为XA方案。
XA方案需要本地数据库支持XA协议，资源锁需要等到准备阶段和提交阶段结束才释放，所以性能较差。</p>
<h4 id="seata方案">Seata方案</h4>
<p>Seata是由阿里中间件团队发起的开源项目Fescar，后更名为Seata，它是一个开源的分布式事务框架。</p>
<p>Seata的设计目标其一是对业务零侵入，因此从业务无侵入的2PC入手，在传统方案2PC的基础上演进，并解决2PC方案面临的问题。
Seata把一个分布式的事务理解为一个包含了若干分支事务的全局事务，它通过对本地关系型数据库的分支事务的协调来驱动完成全局事务，是工作在应用层的中间件。全局事务的职责是协调其下管辖的分支事务达成一致，要么一起成功提交事务，要么一起回滚失败。此外，通常分支事务本身就是一个关系型数据库的本地事务。
主要优点是性能较好，且不长时间占用连接资源，它以高效并对业务0入侵的方式解决微服务场景下面临的分布式事务问题，目前提供AT模式（即2PC）和TCC模式的分布式事务解决方案。</p>
<p><img alt="分布式事务-005" src="/posts/annex/images/essays/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-005.png"></p>
<p>与传统2PC的模型类似，Seata定义了3个组件来协调分布式事务的处理过程：
<img alt="分布式事务-006" src="/posts/annex/images/essays/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-006.png"></p>
<ul>
<li>TM：<code>Transaction Manager</code>事务管理器，需要嵌入（jar包）应用程序中工作，负责开启一个全局事务，并最终向TC发起全局提交或全局回滚的指令。</li>
<li>RM：<code>Resource Manager</code>资源管理器，控制分支事务，负责分支事务注册，状态回报，并接收事务调节器的指令，驱动分支事务的提交和回滚。</li>
<li>TC：<code>Transaction Coordinator</code>事务协调器，它是独立的中间件，需要独立运行部署，它维护全局事务的运行状态，接收TM指令发起全局事务的提交与回滚，负责与RM通信协调各个分支事务的提交回滚。</li>
</ul>
<p>以新用户注册送积分举例：
<img alt="分布式事务-007" src="/posts/annex/images/essays/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-007.png"></p>
<p>具体执行流程：</p>
<ol>
<li>用户服务器的事务管理器向事务协调器申请开启一个全局事务，全局事务的创建成功并生成一个全局唯一XID。</li>
<li>用户服务器的资源管理器向事务协调器注册分支事务，该分支事务在用户服务执行新增用户逻辑，并将其纳入XID对应全局事务的管辖。
<blockquote>
<p>在执行注册分支事务的时候，这里事务已经提交了，提交后可以释放资源，从而提升程序性能。</p>
</blockquote>
</li>
<li>用户服务器执行分支事务，向用户表插入一条记录。</li>
<li>逻辑执行到远程分布式调用积分服务时，XID在微服务调用链路的上下文中传播。积分服务的资源管理器向事务协调器注册了分支事务，该分支事务执行增加积分的逻辑，并将其纳入XID对应的全局事务的管辖。</li>
<li>积分服务执行分支事务，向积分记录表插入一条记录，执行完毕后，返回用户服务。</li>
<li>用户服务分支事务执行完毕。</li>
<li>事务管理器向事务协调器针对XID的全局提交或者回滚决策。</li>
<li>事务协调器调度XID下管辖的全部分支事务完成提交或回滚的请求。</li>
</ol>
<p>Seata实现2PC与传统2PC的差别：</p>
<ul>
<li>架构方面，传统2PC方案的RM实际上是在数据库层，RM本质上就是数据库自身，通过XA协议实现，而Seata的RM则是以jar包的形式作为中间件层部署在应用程序这一侧的。</li>
<li>两阶段提交方面，传统2PC无论第二阶段的决策是<code>commit</code>还是<code>rollback</code>，事务性资源的锁都要保持到第二阶段才释放。而Seata的做法是在第一阶段就将本地事务提交，这样可以省去第二阶段持有锁的时间，提高整体效率。</li>
</ul>
<p>Seata两阶段提交协议的演变：</p>
<ul>
<li>
<p>一阶段：Seata会拦截，解析SQL语义，找到SQL要更新的数据，在业务员数据更新前，将其保存为<code>before image</code>，随后执行业务SQL。在业务数据更新后，将其保存为<code>after image</code>，插入<code>UNDO LOG</code>回滚日志；提交前向TC注册分支并生成行锁。
随后本地事务提交，将本地事务提交的结果上报给TC，由TC协调。
<img alt="分布式事务-008" src="/posts/annex/images/essays/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-008.png"></p>
</li>
<li>
<p>二阶段-提交：执行提交操作，说明SQL执行顺利，因业务SQL在一阶段已经提交至数据库，所以Seata框架只需将一阶段保存的快照数据和行锁删掉，完成数据清理即可。
<img alt="分布式事务-009" src="/posts/annex/images/essays/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-009.png"></p>
</li>
<li>
<p>二阶段-回滚：要执行回滚操作，说明SQL执行不顺利，Seata需要回滚一阶段已经执行的业务SQL还原数据。回滚方式是用<code>before image</code>还原数据，但是在还原前还要校验脏写，对比数据库当前业务数据和<code>after image</code>。
对比数据库当前业务数据和<code>after image</code>。
<img alt="分布式事务-010" src="/posts/annex/images/essays/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-010.png"></p>
</li>
</ul>
<h3 id="tcc">TCC</h3>
<p>TCC是<code>Try</code>、<code>Confirm</code>、<code>Cancel</code>三个词语的缩写，TCC要求每个分支事务实现三个操作，预处理<code>Try</code>、确认<code>Confirm</code>、撤销<code>Cancel</code>。
<code>Try</code>操作做业务检查及资源预留，<code>Confirm</code>做业务确认操作，<code>Cancel</code>实现一个与<code>Try</code>相反的操作，即回滚操作。</p>
<p>TCC的三个阶段：</p>
<ul>
<li><code>Try</code>阶段是做业务检查一致性及资源预留，此阶段仅是一个初步操作，它和后续的<code>Confirm</code>一起才能真正的构成一个完整的业务逻辑。</li>
<li><code>Confirm</code>阶段是确认提交，<code>Try</code>阶段所有的分支事务执行成功后开始执行<code>Confirm</code>。通常情况下，采用TCC则认为<code>Confirm</code>阶段是不会出错的。即只要<code>Try</code>成功，<code>Confirm</code>一定成功。若<code>Confirm</code>阶段真的出错了，需要引入重试机制或进行人工处理。</li>
<li><code>Cancel</code>阶段是在业务执行错误需要回滚的状态下，执行分支事务的业务取消了，预留资源释放。通常情况下，采用TCC则认为<code>Cancel</code>阶段也是一定成功的。如果<code>Cancel</code>阶段真的出错了，需要引入重试机制或进行人工处理。</li>
</ul>
<p>TM首先发起所有分支事务的<code>Try</code>操作，任何一个分支事务的<code>Try</code>操作执行失败，TM将会发起所有分支事务的<code>Cancel</code>操作。
若<code>Try</code>操作全部成功，TM将发起所有分支事务的<code>Confirm</code>操作，其中<code>Confirm</code>或<code>Cancel</code>操作失败，TM会重试。</p>
<p>TM即事务管理器，TM事务管理器可以实现为独立的服务，也可以让全局事务发起方充当TM的角色。TM独立出来是为了成为公用的组件，为了考虑系统结构和软件复用。</p>
<p>TM发起全局事务时生成全局事务记录，全局事务ID贯穿整个分布式事务调用链，用来记录事务上下文，追踪和记录状态。
由于<code>Confirm</code>和<code>Cancel</code>失败需要进行重试或人工处理，因此需要实现幂等性，幂等性是指同一个操作无论请求多少次，其结果都相同。</p>
<p>分布式事务执行成功情况：</p>
<p><img alt="分布式事务-011" src="/posts/annex/images/essays/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-011.png"></p>
<p>分布式事务执行失败情况：</p>
<p><img alt="分布式事务-012" src="/posts/annex/images/essays/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-012.png"></p>
<h4 id="hmily方案">Hmily方案</h4>
<p>Hmily是一个高性能分布式事务TCC开源框架。基于Java语言来开发（JDK1.8），支持Dubbo，Spring Cloud等RPC框架进行分布式事务。</p>
<p>支持以下特性：</p>
<ul>
<li>支持嵌套事务；</li>
<li>采用<code>disruptor</code>框架进行事务日志的异步读写，与RPC框架的性能毫无差别；</li>
<li>支持<code>SpringBoot-Starter</code>项目启动，使用简单；</li>
<li>RPC框架支持：Dubbo，SpringCloud；</li>
<li>本地事务存储支持：Redis，Mongodb，ZooKeeper，MySql；</li>
<li>事务日志序列化支持：Java，Hessian，Kryo，Protostuff；</li>
<li>采用<code>Aspect AOP</code>切面思想与Spring无缝集成，天然支持集群；</li>
<li>RPC事务恢复，超时异常恢复等；</li>
</ul>
<p>Hmily是一个轻量级的TCC事务框架不需要部署独立的事务协调服务，但需要提供一个数据库来进行日志存储。
Hmily利用AOP对参与分布式事务的本地方法与远程方法进行拦截处理，通过多方拦截，事务参与者能透明的调用到另一方的<code>Try</code>、<code>Confirm</code>、<code>Cancel</code>方法，传递事务上下文；并记录事务日志，酌情进行补偿，重试等。</p>
<p>Hmily实现的TCC服务与普通的服务一样，只需要暴露一个接口，也就是它的<code>Try</code>业务。<code>Confirm/Cancel</code>业务逻辑，只是因为全局事务提交/回滚的需要才提供的，因此<code>Confirm/Cancel</code>业务只需要被Hmily TCC事务框架发现即可，不需要被调用它的其他业务服务所感知。</p>
<p>要实现TCC协议，必须要实现三个方法：<code>Try</code>、<code>Confirm</code>、<code>Cancel</code>，其中最关键的方法是<code>Try</code>方法，Try方法是一个事务的起点，三个方法会由不同的线程来分别调用。</p>
<p>TCC需要注意三种异常处理：</p>
<ol>
<li>空回滚：在没有调用TCC资源<code>Try</code>方法的情况下，调用了二阶段的<code>Cancel</code>方法，<code>Cancel</code>方法需要识别出这是一个空回滚，然后直接返回成功。
出现原因是当一个分支事务所在的服务器宕机或网络异常，分支事务调用记录为失败，这个时候其实是没有执行<code>Try</code>阶段，当故障恢复后，分布式事务进行回滚则会调用二阶段的<code>Cancel</code>方法，从而形成空回滚。
解决思路关键就是要标识这个空回滚，就是要知道<code>Try</code>阶段是否已经执行了，如果执行了那就是正常回滚；如果没执行，那就是空回滚。可以在try阶段执行完毕后向表里插入一条记录进行标识，如果记录存在则<code>Try</code>阶段执行了，如果不存在<code>Try</code>阶段则未执行。</li>
<li>幂等：为了保证TCC二阶段提交重试机制不会引发数据不一致，要求TCC二阶段<code>Try</code>、<code>Confirm</code>、<code>Cancel</code>接口保证幂等性，这样不会重复使用或示释放资源。如果幂等控制没有做好，很有可能导致数据不一致等严重问题。</li>
<li>悬挂：悬挂就是对于一个分布式事务，其二阶段<code>Cancel</code>接口对比<code>Try</code>接口先执行。
出现原因是在RPC调用分支事务时，先注册分支事务，在执行RPC调用。如果此时RPC调用的网络发生错误、RPC超时后，TM就会通知RM回滚该分布式事务，可能回滚完成后RPC请求才到达，然后执行，而一个<code>Try</code>方法预留的业务资源，只有该分布式事务才能使用，该分布式事务第一阶段预留的业务资源也就在也没有人能够处理，对于这种情况就称为悬挂，即业务资源预留后没办法处理。</li>
</ol>
<h3 id="可靠消息最终一致性">可靠消息最终一致性</h3>
<p>可靠消息最终一致性是指当事务发起方执行完本地事务后并发出一条消息，事务参与方（消息消费者）一定能接收到消息并成功处理事务，此方案强调的是只要消息发给事务参与方最终事务要达到一致。</p>
<p>此方案利用消息中间件完成，事务发起方将消息发送给消息中间件，事务参与方从消息中间件接收消息，事务发起方和消息中间件之间，事务参与方和消息中间件之间都是通过网络进行通信，由于网络通信的不稳定会导致分布式事务问题。</p>
<p><img alt="分布式事务-013" src="/posts/annex/images/essays/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-013.png"></p>
<p>此方案利用消息中间件完成，因此可靠消息最终一致性方案要解决几个问题：</p>
<ul>
<li>本地事务与消息发送的原子性：即事务发起方在本地事务执行成功后消息必须发出去，否则就丢弃消息。即实现本地事务和消息发送的原子性，要么都成功，要么都失败。本地事务与消息发送的原子性问题是实现可靠消息最终一致性方案的关键。</li>
<li>事务参与方接收消息的可靠性：事务参与方必须能够从消息队列接收消息，如果接收消息失败可以重复接收消息。</li>
<li>消息重复消费问题：由于网络存在问题，若某一个消费结点超时但是消费成功，此时消息中间件会重复投递此消息，就导致了消息重复消费问题。要解决消息重复消费问题就要实现事务参与方的方法的幂等性。</li>
</ul>
<h4 id="本地消息表方案">本地消息表方案</h4>
<p>本地消息表该方案最初是eBay提出，此方案的核心是通过本地事务保证数据业务操作和消息的一致性，然后通过定时任务将消息发送至消息中间件，待确认消息发送给消费方成功后在将消息删除。</p>
<p>以用户注册送积分举例，用户服务负责添加用户，积分服务负责添加积分。</p>
<p><img alt="分布式事务-014" src="/posts/annex/images/essays/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-014.png"></p>
<p>执行流程：</p>
<ul>
<li>用户注册，用户服务在本地新增用户和增加积分消息日志。用户表和消息表本地事务保持一致，这种情况下本地数据库操作与存储积分消息日志处于同一个事务中，本地数据库操作记录与记录消息日志操作具备原子性。</li>
<li>当消息已经写入到消息日志中去后，可以启动独立的线程，定时对消息日志表中的消息进行扫描并发送至消息中间件，在消息中间件反馈发送成功后删除该消息日志，否则等待定时任务下一周期重试。</li>
<li>使用MQ的ACK机制即消息确认机制，消费者监听MQ，如果消费者接收到消息并且业务处理完成后想MQ发送ACK，此时说明消费者正常消费消息完成，MQ将不再向消费者推送消息，否则生产者会不断重试向消费者发送消息。
由于消息会重复投递，因此积分服务的增加积分操作功能要实现幂等性。</li>
</ul>
<h4 id="rocketmq方案">RocketMQ方案</h4>
<p>RocketMQ是阿里巴巴的分布式消息中间件，于2012年开源并在2017年正式称为Apache的项目。ApacheRocketMQ4.3之后的版本正式支持事务消息，并为分布式事务提供了便利性支持。</p>
<p>RocketMQ事务消息设计则主要是为了解决生产者端的消息发送与本地事务执行的原子性问题。RockerMQ设计中<code>broker</code>与生产者端的双向通信能力，使得<code>broker</code>天生可以作为一个事务协调者存在。
RockerMQ的高可用机制以及可靠消息设计原则则为事务消息在系统发生异常时依然能够保证达成事务的最终一致性。</p>
<p><img alt="分布式事务-015" src="/posts/annex/images/essays/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-015.png"></p>
<p>执行流程：</p>
<ol>
<li>MQ的发起方会向MQ发送一条消息，MQ发起方会监听MQ是否响应；</li>
<li>MQ收到该消息会响应消息发起方，代表发送给MQ成功；但是此时MQ并未发送消息给消费者；</li>
<li>MQ发起方开始执行本地事务，执行完本地事务后，给MQ发送<code>commit</code>消息，此时MQ将该消息更改为可消费状态，消费者可以消费该消息；如果消费者执行本地事务失败，给MQ发送<code>rollbac</code>k消息，MQ会将该消息丢弃；</li>
<li>消费者方利用MQ的ACK机制来保证消息一定被消费到。
如果发起方与MQ之间的网络出现问题，但MQ里的消息不会一直存着。MQ服务会定回查消费者方本地事务状态（实现MQ事务回查接口），如果事务已经提交了消费者仍然可以接收到该消息，如果没有提交MQ则丢弃该消息；</li>
</ol>
<h3 id="最大努力通知">最大努力通知</h3>
<p>最大努力通知，顾名思义就是发起通知方通过一定机制，最大努力的将业务处理结果通知到接收方。</p>
<p>举个例子，账户系统调用充值系统接口，充值系统完成处理后向账户账户接口发起充值结果通知，如果通知失败则充值充值系统则按策略进行重复通知。
账户系统接收到充值系统的通知后修改充值状态，如果账户系统未接受到通知，账户系统会主动调用充值系统接口进行结果查询。</p>
<p><img alt="分布式事务-016" src="/posts/annex/images/essays/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-016.png"></p>
<p>最大努力通知特点：</p>
<ul>
<li>有一定的消息重复通知机制。因接收方可能没有收到通知，此时要有一定的机制对消息重复通知。</li>
<li>消息校对机制。如果发起方尽最大努力也没有通知到接收方，或接收方消费消息后要再次消费，此时可由接收方主动向通知方查询处理结果来满足需求。</li>
</ul>
<p>最大努力通知与可靠消息一致性方案不同点：</p>
<ol>
<li>解决方案思想不同：
<ul>
<li>可靠消息一致性，发起通知方需要保证将消息发送出去，并且将消息发送到接收方，消息的可靠性关键由发起方来保证。</li>
<li>最大努力通知，发起通知尽最大努力的将业务处理结果通知接收方，但是消息可能接收不到，此时需要接收通知方主动调用发起方的查询业务处理结果接口，通知的可靠性关键在接收方。</li>
</ul>
</li>
<li>业务场景不同：
<ul>
<li>可靠消息一致性关注的是交易过程事务的一致性，以异步的方式完成交易。</li>
<li>最大努力通知关注的是交易后的通知事务，即将交易结果可靠的通知出去。</li>
</ul>
</li>
<li>技术解决方向不同：
<ul>
<li>可靠消息一致性要解决消息从发出到接收的一致性，即发出消息并且被接收到。</li>
<li>最大努力通知无法保证发出到接收的一致性，只提供消息接收的可靠性机制。消息接收可靠机制指，最大努力的将通知发送给接收方，当消息无法被接收方接收时，由接收方主动查询该消息。</li>
</ul>
</li>
</ol>
<p>采用MQ的ACK机制可以实现最大努力通知。</p>
<h4 id="mq方案1">MQ方案1</h4>
<p><img alt="分布式事务-017" src="/posts/annex/images/essays/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-017.png"></p>
<p>执行流程：</p>
<ul>
<li>发起通知方将通知发送给MQ；</li>
<li>接收方监听MQ；</li>
<li>接收通知方接收消息，业务处理完成回应ACK，接收方若没有回应ACK则MQ重复通知；</li>
<li>如果消息没有发送出去可由接收方主动请求发起方查询业务结果接口，通过该接口校对消息的一致性；</li>
</ul>
<p>方案1中接收通知方MQ接口，即接收通知方监听MQ，此方案主要应用于应用与内部应用之间的通知。</p>
<h4 id="mq方案2">MQ方案2</h4>
<p><img alt="分布式事务-018" src="/posts/annex/images/essays/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1-018.png"></p>
<p>交互流程：</p>
<ul>
<li>发起通知方将消息通知给MQ。使用可靠消息一致方案中的事务消息保证本地事务与消息的原子性，最终将通知先发给MQ；</li>
<li>通知程序监听MQ，接收MQ消息。通知程序如果没有回应ACK则MQ会重复通知；</li>
<li>通知程序通过互联网接口协议调用接收通知方接口，完成通知。通知程序调用接收方接口成功就表示通知成功，即MQ消费成功，MQ将不再向通知程序投递消息；</li>
<li>接收通知方可通过消息校对接口来校对消息的一致性；</li>
</ul>
<p>方案2中由于通知程序与MQ接口，通知程序监听MQ，收到MQ消息后由通知程序通过互联网接口协议调用接收通知方，此方案主要应用于外部应用之间的通知。</p>
</div>
                    <div id="post_footer" class="post_footer">
                        <div class="meta">

                            <div id="post_footer_info" class="info">
                                <span class="field tags">
                                    <i class="ri-stack-line"></i>
                                    
                                        
                                        <a href="https://blog.lijizhi.website/tags/%E5%88%86%E5%B8%83%E5%BC%8F/">分布式</a>
                                        
                                        <a href="https://blog.lijizhi.website/tags/%E8%AF%A6%E8%A7%A3/">详解</a>
                                        
                                        <a href="https://blog.lijizhi.website/tags/%E4%BA%8B%E5%8A%A1/">事务</a>
                                        
                                    
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                <div id="doc_comments" class="doc_comments"></div>
                
            </div>
        </div>
    </div>
    
<a id="search-btn" style="display: inline-block;" href="javascript:void(0);">
    <span class="ri-search-line"></span>
</a>
<div id="fastSearch">
    <input id="searchInput" tabindex="0" autocomplete="off">
    <ul id="searchResults"></ul>
</div>
<div class="side_nav">
    
    <a id="top_to_back" href="#" class="top_to_back">
        <svg t="1688614744062" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2152" width="16" height="16"><path d="M966.4 323.2c-9.6-9.6-25.6-9.6-35.2 0l-416 416-425.6-416c-9.6-9.6-25.6-9.6-35.2 0-9.6 9.6-9.6 25.6 0 35.2l441.6 432c9.6 9.6 25.6 9.6 35.2 0l435.2-432C976 345.6 976 332.8 966.4 323.2z" p-id="2153" fill="#424242"></path></svg>    </a>
    
    <div>
        <a id="content_display" class="content_display">
            <svg t="1688606941910" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="57753" width="18" height="18"><path d="M192 448c10.9 0 21.8-4.2 30.2-12.5L497 160.8c5.4-5.4 11.8-6.2 15.1-6.2 3.3 0 9.6 0.8 15.1 6.2l274.7 274.7c16.7 16.7 43.7 16.7 60.3 0 16.7-16.7 16.7-43.7 0-60.3L587.4 100.4c-41.6-41.6-109.3-41.6-150.9 0L161.8 375.2c-16.7 16.7-16.7 43.7 0 60.3 8.4 8.3 19.3 12.5 30.2 12.5zM801.8 588.5L527.1 863.2c-5.4 5.4-11.8 6.2-15.1 6.2-3.3 0-9.7-0.8-15.1-6.2L222.2 588.5c-16.7-16.7-43.7-16.7-60.3 0-16.7 16.7-16.7 43.7 0 60.3l274.8 274.8c20.8 20.8 48.1 31.2 75.4 31.2 27.3 0 54.6-10.4 75.4-31.2l274.7-274.8c16.7-16.7 16.7-43.7 0-60.3-16.7-16.7-43.7-16.7-60.4 0z" fill="#424242" p-id="57754"></path></svg>
        </a>
        <a id="content_hidden" class="content_hidden">
            <svg t="1688603143752" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15592" width="18" height="18"><path d="M479.004101 645.938677L165.25229 958.480465a37.510709 37.510709 0 0 0 0 54.059551 36.47863 36.47863 0 0 0 53.063061 0l293.679668-292.576411 293.715256 292.576411a36.443042 36.443042 0 0 0 53.063061 0 37.510709 37.510709 0 0 0 0-54.059551l-313.751811-312.541788c-21.210989-22.349834-36.514219-24.698702-66.017424 0z m66.053013-267.877709l312.577377-312.541789a37.510709 37.510709 0 0 0 0-54.059551 36.443042 36.443042 0 0 0-53.063061 0l-292.505234 292.576411L219.560963 11.459628a36.47863 36.47863 0 0 0-53.063061 0 37.510709 37.510709 0 0 0 0 54.059551l312.577377 312.541789a46.58588 46.58588 0 0 0 65.981835-0.035589z" p-id="15593" fill="#424242"></path></svg>
        </a>
    </div>
    
    <a id="back_to_top" href="#" class="back_to_top">
        <svg t="1688628374733" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3166" width="16" height="16"><path d="M966.4 668.8l-435.2-432c-9.6-9.6-25.6-9.6-35.2 0l-441.6 432c-9.6 9.6-9.6 25.6 0 35.2 9.6 9.6 25.6 9.6 35.2 0l425.6-416 416 416c9.6 9.6 25.6 9.6 35.2 0S976 678.4 966.4 668.8z" p-id="3167" fill="#424242"></path></svg>
    </a>
</div>
    <footer class="footer">
    <div id="footer_powered_by" class="powered_by">
        <a href="https://varkai.com">Designed by VarKai,</a>
        <a href="http://www.gohugo.io/">Proudly published with Hugo</a>
    </div>

    <div id="footer_slogan" class="footer_slogan">
        <span>from 2020</span>
    </div>
</footer>
    <script src="https://blog.lijizhi.website/js/jquery-3.5.1.min.js"></script>
<link href="https://blog.lijizhi.website/css/fancybox.min.css" rel="stylesheet">
<script src="https://blog.lijizhi.website/js/fancybox.min.js"></script>
<script src="https://blog.lijizhi.website/js/darkmode.js"></script>
<script src="https://blog.lijizhi.website/js/zozo.js"></script>

<script src="https://blog.lijizhi.website/js/busuanzi_2.3_busuanzi.pure.mini.js"></script>
<script src="https://blog.lijizhi.website/js/html2canvas.js"></script>
<script src="https://blog.lijizhi.website/js/utils.js"></script>
<script src="https://blog.lijizhi.website/js/html2md.js"></script>
<script src="https://blog.lijizhi.website/js/htmlexport.js"></script>

<script src="https://blog.lijizhi.website/js/fastsearch.js"></script>
<script src="https://blog.lijizhi.website/js/fuse.js"></script>


<script>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
</script>


<script>
    
    document.addEventListener("DOMContentLoaded", function () {
        const uvE = document.getElementById('busuanzi_value_site_uv');
        const pvE = document.getElementById('busuanzi_value_site_pv');
        const uvObs = new MutationObserver((mutationsList) => {
            for (let mutation of mutationsList) {
                if (mutation.type === 'childList') {
                    uvObs.disconnect();
                    mutation.target.innerHTML = parseInt(mutation.target.innerHTML) + 57030;
                    break;
                }
            }
        });
        const pvObs = new MutationObserver((mutationsList) => {
            for (let mutation of mutationsList) {
                if (mutation.type === 'childList') {
                    pvObs.disconnect();
                    mutation.target.innerHTML = parseInt(mutation.target.innerHTML) + 203040;
                    break;
                }
            }
        });
        const config = {
            childList: true
        };
        uvObs.observe(uvE, config);
        pvObs.observe(pvE, config);
    });
</script>


<script>
    
    document.addEventListener('DOMContentLoaded', function() {
        var links = document.querySelectorAll('.content a');
        links.forEach(function(link) {
            link.setAttribute('target', '_blank');
        });
    });
</script>










</body>

</html>