<!-- toc.html -->
<!-- ignore empty links with + -->
{{ $headers := findRE "<h[1-5].*?>(.|\n])+?</h[1-5]>" .Content }}
<!-- at least one header to link to -->
{{ if ge (len $headers) 1 }}
{{ $h1_n := len (findRE "(.|\n])+?" .Content) }}
{{ $re := (cond (eq $h1_n 0) "<h[2-5]" "<h[1-5]") }}
{{ $renum := (cond (eq $h1_n 0) "[2-5]" "[1-5]") }}

<!-- 移动端目录触发按钮 -->
<button id="mobile-toc-toggle" class="mobile-toc-toggle" aria-label="打开目录">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M3 12h18M3 6h18M3 18h18"/>
    </svg>
    <span>目录</span>
</button>

<!-- 移动端遮罩层 -->
<div id="mobile-toc-overlay" class="mobile-toc-overlay"></div>

<!--Scrollspy-->
<div id="post_content_toc" class="toc">
    <div class="toc-header">
        <div class="page-header"><strong>目录</strong></div>
        <button id="toc-close" class="toc-close" aria-label="关闭目录">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 6L6 18M6 6l12 12"/>
            </svg>
        </button>
    </div>
    <div id="page-scrollspy" class="toc-nav">

        {{ range $headers }}
        {{ $header := . }}
        {{ range first 1 (findRE $re $header 1) }}
        {{ range findRE $renum . 1 }}
        {{ $next_heading := (cond (eq $h1_n 0) (sub (int .) 1 ) (int . ) ) }}
        {{ range seq $next_heading }}
        <ul class="nav">
            {{end}}
            {{ $anchorId := (replaceRE ".* id=\"(.*?)\".*" "$1" $header ) }}
            <li class="nav-item">
                <a class="nav-link text-left" href="#{{ $anchorId }}">
                    {{ $header | plainify | htmlUnescape }}
                </a>
            </li>
            <!-- close list -->
            {{ range seq $next_heading }}
        </ul>
        {{ end }}
        {{ end }}
        {{ end }}
        {{ end }}

    </div>
</div>
<!--Scrollspy-->

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const toc = document.getElementById('post_content_toc');
        const mobileToggle = document.getElementById('mobile-toc-toggle');
        const tocClose = document.getElementById('toc-close');
        const overlay = document.getElementById('mobile-toc-overlay');
        const tocLinks = document.querySelectorAll('.toc-nav .nav-link');

        // 切换移动端目录
        function toggleMobileToc() {
            toc.classList.toggle('mobile-active');
            overlay.classList.toggle('active');
            document.body.classList.toggle('toc-open');
        }

        // 移动端按钮点击事件
        mobileToggle.addEventListener('click', toggleMobileToc);
        tocClose.addEventListener('click', toggleMobileToc);
        overlay.addEventListener('click', toggleMobileToc);

        // 移动端点击目录项后自动关闭目录
        tocLinks.forEach(link => {
            link.addEventListener('click', function() {
                if (window.innerWidth <= 1450) {
                    toggleMobileToc();
                }
            });
        });

        // 监听窗口大小变化
        window.addEventListener('resize', function() {
            if (window.innerWidth > 1450) {
                toc.classList.remove('mobile-active');
                overlay.classList.remove('active');
                document.body.classList.remove('toc-open');
            }
        });
    });
</script>

{{ end }}