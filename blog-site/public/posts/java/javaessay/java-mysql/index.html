<!DOCTYPE html>






<html lang="zh" >
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="google-site-verification" content="tVxoyWMeaEzEUV0EzY1STfJXZWaZ8WM-i-a8AWBri0o" />
    <meta name="msvalidate.01" content="48159A4EAF3C3F448369E581664B1A21" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="whitepure" />
	
	
	
	<title>MySQL详解 ｜ 脚踏实地</title>
	
    
    
    <meta name="description" content="概述 MySQL是一种关系型数据库，主要用于持久化存储我们系统中的一些数据。MySQL如此流行的原因，主要具有下面这些优点： 成熟稳定，功能完善。 开源免费。 文档丰富" />
    

    
    
    <meta name="keywords" content="whitepure博客, whiteppure, whitepure, Java, 博客, 技术博客" />
    

	

    <link rel="shortcut icon" href="http://localhost:1313/images/favicon.ico" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/gh/whiteppure/iblog@main/docs/css/normalize.css" />
    
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/gh/whiteppure/iblog@main/docs/css/animate.min.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/gh/whiteppure/iblog@main/docs/css/zozo.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/gh/whiteppure/iblog@main/docs/css/remixicon.css" />
    
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/gh/whiteppure/iblog@main/docs/css/highlight.css" />

    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/gh/whiteppure/iblog@main/docs/css/toc.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/gh/whiteppure/iblog@main/docs/css/search.css" />
    <link rel="stylesheet" type="text/css" media="screen" href="https://cdn.jsdelivr.net/gh/whiteppure/iblog@main/docs/css/img.css" />
</head>

<body>
    <div class="post-password">
        
    </div>

    
    
    









<div id="post_content_toc" class="toc">
    <div class="page-header"><strong></strong></div>
    <div id="page-scrollspy" class="toc-nav">

        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e6%a6%82%e8%bf%b0">
                    概述
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#mysql%e5%ad%98%e5%82%a8%e5%bc%95%e6%93%8e">
                    MySQL存储引擎
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#mysql%e4%ba%8b%e5%8a%a1">
                    MySQL事务
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#mysql%e4%b8%ad%e7%9a%84%e6%97%a5%e5%bf%97">
                    MySQL中的日志
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#atomicity%e5%8e%9f%e5%ad%90%e6%80%a7">
                    Atomicity原子性
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#consistency%e4%b8%80%e8%87%b4%e6%80%a7">
                    Consistency一致性
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#isolation%e9%9a%94%e7%a6%bb%e6%80%a7">
                    Isolation隔离性
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#durability%e6%8c%81%e4%b9%85%e6%80%a7">
                    Durability持久性
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#mvcc%e5%b9%b6%e5%8f%91%e6%8e%a7%e5%88%b6%e6%9c%ba%e5%88%b6">
                    MVCC并发控制机制
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e6%93%8d%e4%bd%9c%e4%ba%8b%e7%89%a9">
                    操作事物
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#mysql%e7%b4%a2%e5%bc%95">
                    MySQL索引
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e7%b4%a2%e5%bc%95%e6%95%b0%e6%8d%ae%e7%bb%93%e6%9e%84">
                    索引数据结构
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e7%b4%a2%e5%bc%95%e7%9a%84%e5%ae%9e%e7%8e%b0">
                    索引的实现
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#myisam%e7%b4%a2%e5%bc%95%e7%9a%84%e5%ae%9e%e7%8e%b0">
                    MyISAM索引的实现
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#innodb%e7%b4%a2%e5%bc%95%e7%9a%84%e5%ae%9e%e7%8e%b0">
                    InnoDB索引的实现
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e7%b4%a2%e5%bc%95%e5%88%86%e7%b1%bb">
                    索引分类
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e6%93%8d%e4%bd%9c%e7%b4%a2%e5%bc%95">
                    操作索引
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e6%9c%80%e5%b7%a6%e5%89%8d%e7%bc%80%e5%8c%b9%e9%85%8d%e5%8e%9f%e5%88%99">
                    最左前缀匹配原则
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e7%b4%a2%e5%bc%95%e8%a6%86%e7%9b%96">
                    索引覆盖
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e7%b4%a2%e5%bc%95%e5%bb%ba%e7%ab%8b%e5%8e%9f%e5%88%99">
                    索引建立原则
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e9%81%bf%e5%85%8d%e7%b4%a2%e5%bc%95%e5%a4%b1%e6%95%88%e5%8e%9f%e5%88%99">
                    避免索引失效原则
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#mysql%e6%89%a7%e8%a1%8c%e8%ae%a1%e5%88%92">
                    MySQL执行计划
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#idtable">
                    id、table
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#select_type">
                    select_type
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#type">
                    type
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#possible_keyskey">
                    possible_keys、key
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#key_len">
                    key_len
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#ref">
                    ref
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#rows">
                    rows
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#extra">
                    Extra
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#mysql%e4%bc%98%e5%8c%96">
                    MySQL优化
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#sql%e6%89%a7%e8%a1%8c%e8%bf%87%e7%a8%8b">
                    SQL执行过程
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e4%bc%98%e5%8c%96%e6%80%9d%e8%b7%af">
                    优化思路
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e6%8e%92%e6%9f%a5%e6%85%a2sql">
                    排查慢SQL
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e6%85%a2sql%e6%97%a5%e5%bf%97%e8%ae%be%e7%bd%ae">
                    慢SQL日志设置
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e6%9f%a5%e7%9c%8b%e6%85%a2sql%e6%97%a5%e5%bf%97">
                    查看慢SQL日志
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e6%a8%a1%e6%8b%9f%e6%95%b0%e6%8d%ae%e5%b9%b6%e5%88%86%e6%9e%90sql">
                    模拟数据并分析SQL
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e5%85%a8%e5%b1%80%e6%9f%a5%e8%af%a2%e6%97%a5%e5%bf%97">
                    全局查询日志
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#exist%e5%92%8cin%e9%80%89%e6%8b%a9">
                    exist和in选择
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#order-by%e4%bc%98%e5%8c%96">
                    order by优化
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#sql%e4%bc%98%e5%8c%96%e6%a1%88%e4%be%8b">
                    SQL优化案例
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e5%8d%95%e8%a1%a8%e4%bc%98%e5%8c%96">
                    单表优化
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e4%b8%a4%e8%a1%a8%e4%bc%98%e5%8c%96">
                    两表优化
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#mysql%e9%94%81%e6%9c%ba%e5%88%b6">
                    MySQL锁机制
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e8%a1%a8%e9%94%81">
                    表锁
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e8%a1%8c%e9%94%81">
                    行锁
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e5%88%86%e5%ba%93%e5%88%86%e8%a1%a8">
                    分库分表
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e6%8b%86%e5%88%86%e6%96%b9%e6%a1%88">
                    拆分方案
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e6%95%b0%e6%8d%ae%e8%bf%81%e7%a7%bb%e6%96%b9%e6%a1%88">
                    数据迁移方案
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e5%88%86%e5%ba%93%e5%88%86%e8%a1%a8%e4%b8%ad%e9%97%b4%e4%bb%b6">
                    分库分表中间件
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        </ul>
        
        
        
        
        
        
        
        
        
        <ul class="nav">
            
        <ul class="nav">
            
            
            <li class="nav-item">
                <a class="nav-link text-left" href="#%e5%8f%82%e8%80%83%e6%96%87%e7%ab%a0">
                    参考文章
                </a>
            </li>
            
            
        </ul>
        
        </ul>
        
        
        
        

    </div>
</div>



    

    
    <div class="main animate__animated animate__fadeInDown" id="main_content">
        <div class="nav_container animated fadeInDown">
    <div class="site_nav" id="site_nav">
        <ul><li class="">
                <a href="http://localhost:1313/">首页</a>
            </li><li class="">
                <a href="http://localhost:1313/posts/">归档</a>
            </li><li class="">
                <a href="http://localhost:1313/tags/">标签</a>
            </li><li class="">
                <a href="http://localhost:1313/about/">关于</a>
            </li>
        </ul>
    </div>
    <div class="menu_icon">
        <a id="menu_icon"><i class="ri-menu-line"></i></a>
    </div>
</div>
        <div id="post_header" class="header animated fadeInDown">
    <div class="site_title_container">
        <div class="site_title">
            <h1>
                <a href="http://localhost:1313/">
                    <span>脚踏实地</span>
                </a>
            </h1>
        </div>
        <div class="description">
            <p class="sub_title">
                
            </p>

            
            <div class="my_socials">
                
                    
                    <a href="https://github.com/whiteppure/" title="github" target="_blank">
                        <i class="ri-github-fill"></i>
                    </a>
                    
                
                <a href="" type="application/rss+xml" title="rss" target="_blank">
                    <i class="ri-rss-fill"></i>
                </a>
                
                
                <span id="sys_function" class="sys_function display_none">
                    <a id="export_pdf"  title="导出pdf" style="border: none; cursor: pointer; margin-left: 10px">
                        <svg t="1688701481347" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3517" width="16" height="16"><path d="M425.610455 85.814544H149.05897A42.303635 42.303635 0 0 0 106.6274 128.075535V896.492068c0 23.326702 18.976933 42.26099 42.43157 42.26099h682.743143a42.559504 42.559504 0 0 0 42.431569-42.559504v-384.016365a42.644793 42.644793 0 0 1 85.289587 0v384.016365A127.849091 127.849091 0 0 1 831.802113 1024H149.05897A127.635867 127.635867 0 0 1 21.337813 896.449423V128.03289A127.593222 127.593222 0 0 1 149.101614 0.524957h276.466196a42.644793 42.644793 0 0 1 0 85.289587z m564.062683 158.08425l-170.579174 170.579173a42.644793 42.644793 0 1 1-60.299738-60.299738L856.578738 256.393718H618.364922a42.644793 42.644793 0 1 1 0-85.289587h238.213816l-97.784512-97.784511A42.644793 42.644793 0 1 1 819.093964 13.019882l170.579174 170.579174a42.644793 42.644793 0 0 1 0 60.299738zM149.272194 597.552066a42.644793 42.644793 0 0 1 42.644793-42.644794h51.514911c59.190973 0 107.891327 23.284057 107.976617 97.102195 0 71.003581-49.46796 102.347504-106.185536 102.347504h-31.343923v66.781747a32.282109 32.282109 0 0 1-64.606862 0V597.552066z m92.709781 100.215264c31.429213 0 46.568114-16.46089 46.568114-45.757863 0-30.064579-17.313786-40.512554-48.359196-40.512554h-26.311837v86.270417h28.145563z m232.414124-142.860058c81.878003 0 136.036891 43.710913 136.036891 147.67892S556.231457 853.420826 477.935617 853.420826h-38.16709a42.644793 42.644793 0 0 1-42.644794-42.644793v-213.223967a42.644793 42.644793 0 0 1 42.644794-42.644794h34.542282z m-4.008611 240.729859c43.32711 0 73.988717-22.047358 73.988717-93.050939 0-71.046226-30.704251-90.705476-73.988717-90.705476h-8.699538v183.79906h8.699538zM692.481573 853.420826a32.282109 32.282109 0 0 1-32.282109-32.282108V597.552066a42.644793 42.644793 0 0 1 42.644793-42.644794h99.063855a29.680776 29.680776 0 1 1 0 59.404197h-77.144431v65.374469h61.749661a29.894 29.894 0 1 1 0 59.788h-61.749661v81.66478a32.282109 32.282109 0 0 1-32.282108 32.282108z" fill="#5f5f5f" p-id="3518"></path></svg>
                    </a>
                    <a id="export_pic" title="导出图片" style="border: none; cursor: pointer; margin-left: 10px">
                        <svg t="1689071509720" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4564" width="16" height="16"><path d="M909.132886 0.037506h-184.960611a33.909445 33.909445 0 0 0-32.368107 33.909445 33.909445 33.909445 0 0 0 33.909445 33.395666h158.244078l-200.373995 199.346437a33.395666 33.395666 0 0 0 0 47.781491 31.854327 31.854327 0 0 0 23.633856 9.76181 33.909445 33.909445 0 0 0 24.147635-9.76181l198.832657-199.346437V272.340628a33.909445 33.909445 0 0 0 69.874009 0V88.921355A88.37007 88.37007 0 0 0 909.132886 0.037506zM216.558153 347.866211a107.37991 107.37991 0 1 0 107.37991-107.379911 107.89369 107.89369 0 0 0-107.37991 107.379911z m154.133843 0a51.377948 51.377948 0 0 1-97.618101 0 51.377948 51.377948 0 1 1 97.618101 0z" p-id="4565" fill="#424242"></path><path d="M963.079731 437.777619a34.423225 34.423225 0 0 0-33.909446 33.909445v265.110209a1811.07265 1811.07265 0 0 0-137.692899-193.181082 106.352351 106.352351 0 0 0-78.60826-36.478343 123.820854 123.820854 0 0 0-82.204716 35.964563l-3.596456 3.082677-188.557068 176.74014c-11.816928-13.358266-47.781491-51.377948-82.204716-87.856291a83.232275 83.232275 0 0 0-85.801172-21.578738 105.324792 105.324792 0 0 0-38.019681 19.52362l-141.289356 121.765736V89.948914a22.092517 22.092517 0 0 1 22.606297-22.606297h417.702713a33.395666 33.395666 0 0 0 33.395666-33.909445 33.395666 33.395666 0 0 0-33.395666-33.395666H113.802258A89.911408 89.911408 0 0 0 23.89085 89.948914v844.139678a89.911408 89.911408 0 0 0 89.911408 89.911408h793.27551a89.911408 89.911408 0 0 0 89.397629-89.911408v-462.401528a33.909445 33.909445 0 0 0-33.395666-33.909445z m-33.909446 496.310973a22.606297 22.606297 0 0 1-22.092517 22.606297H113.802258a22.606297 22.606297 0 0 1-22.606297-22.606297v-88.37007l183.933052-160.812976a43.157476 43.157476 0 0 1 15.413385-7.192912 15.927164 15.927164 0 0 1 17.982281 5.137794c37.505902 36.478343 78.60826 83.232275 82.718496 87.856291a61.653537 61.653537 0 0 0 42.643696 22.092517 62.681096 62.681096 0 0 0 51.377948-20.037399c8.220472-8.220472 134.610223-125.875971 194.208641-181.877935a57.029522 57.029522 0 0 1 34.423225-16.440943 45.212594 45.212594 0 0 1 29.79921 15.927164 2954.231982 2954.231982 0 0 1 186.501949 256.889738z" p-id="4566" fill="#424242"></path></svg>
                    </a>
                    <a id="export_markdown" title="导出markdown" style="border: none; cursor: pointer; margin-left: 10px">
                        <svg t="1689071035200" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="13570" width="16" height="16"><path d="M178.073367 843.957262V461.158929h107.121045l107.121045 140.734874 107.125433-140.734874h107.116657v382.798333h-107.116657v-219.54307l-107.125433 140.730486-107.116657-140.730486v219.54307zM737.783131 892.148786l-131.221196-209.156132h87.479334V461.158929h87.479335v221.833725h87.483722z" p-id="13571" fill="#424242"></path><path d="M911.9958 217.142709c10.672172 10.663395 19.812851 25.144549 27.430816 43.430297 7.617965 18.285748 11.431335 35.044392 11.431336 50.28471V969.140255c0 15.235929-5.336086 28.18998-15.999481 38.853375-10.667783 10.667783-23.621834 16.003869-38.857763 16.003869H127.994904c-15.240317 0-28.18998-5.336086-38.857763-16.003869-10.663395-10.663395-15.999481-23.617446-15.999481-38.853375V54.852856c0-15.240317 5.331698-28.18998 15.999481-38.857763C99.804925 5.336086 112.758975 0 127.999292 0h512.000944c15.235929 0 31.998962 3.808982 50.28471 11.426947 18.285748 7.622353 32.762514 16.763033 43.430297 27.426428zM658.290372 77.715526v214.856442h214.856442c-3.808982-11.049559-7.99974-18.856218-12.572275-23.43314l-178.855415-178.851027c-4.572534-4.572534-12.383581-8.763292-23.43314-12.572275z m219.428976 873.143369V365.71496h-237.714724c-15.240317 0-28.18998-5.336086-38.857763-15.999481-10.663395-10.667783-15.999481-23.621834-15.999481-38.857763V73.142992H146.28504v877.715903z" p-id="13572" fill="#424242"></path></svg>
                    </a>
                    <a id="export_doc" title="导出文档" style="border: none; cursor: pointer; margin-left: 10px">
                        <svg t="1689246982401" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="6825" width="16" height="16"><path d="M270.76864 608.32h180.8a31.68 31.68 0 0 0 0-62.976H270.76864a31.68 31.68 0 0 0 0 62.976zM271.34464 458.56h457.92a33.472 33.472 0 0 0 31.552-34.752 33.28 33.28 0 0 0-31.552-34.624H271.34464a34.816 34.816 0 0 0 0 69.376zM271.34464 293.504h457.92a33.344 33.344 0 0 0 31.552-34.688 33.216 33.216 0 0 0-31.552-34.624H271.34464a33.28 33.28 0 0 0-31.616 34.624 33.28 33.28 0 0 0 31.616 34.688z" p-id="6826" fill="#424242"></path><path d="M869.87264 0H153.77664A70.4 70.4 0 0 0 84.65664 70.912V953.6A69.952 69.952 0 0 0 153.77664 1024h370.048a32 32 0 0 0 0-63.68H147.12064V64h729.6v468.672a31.296 31.296 0 1 0 62.528 0V70.912A70.4 70.4 0 0 0 869.87264 0z" p-id="6827" fill="#424242"></path><path d="M482.16064 730.624h337.664L715.82464 625.216a28.864 28.864 0 0 1-7.936-28.736 29.184 29.184 0 0 1 20.608-21.184 29.632 29.632 0 0 1 29.12 8.128l174.784 177.216-174.784 176.96a29.184 29.184 0 0 1-49.728-13.312 29.248 29.248 0 0 1 8-28.8l103.936-105.344H482.16064a29.696 29.696 0 0 1-29.504-29.76 29.632 29.632 0 0 1 29.504-29.76z" p-id="6828" fill="#424242"></path></svg>
                    </a>
                </span>
                <a  id="icon_more" title="更多" >
                    <svg t="1688715321313" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5356" width="16" height="16"><path d="M483.555556 199.111111m-85.333334 0a85.333333 85.333333 0 1 0 170.666667 0 85.333333 85.333333 0 1 0-170.666667 0Z" fill="#424242" p-id="5357"></path><path d="M483.555556 540.444444m-85.333334 0a85.333333 85.333333 0 1 0 170.666667 0 85.333333 85.333333 0 1 0-170.666667 0Z" fill="#424242" p-id="5358"></path><path d="M483.555556 881.777778m-85.333334 0a85.333333 85.333333 0 1 0 170.666667 0 85.333333 85.333333 0 1 0-170.666667 0Z" fill="#424242" p-id="5359"></path></svg>
                </a>
                <a  id="icon_less" class="display_none">
                    <svg t="1688723160472" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15872" width="16" height="16"><path d="M300.105143 592.676571h423.789714a80.676571 80.676571 0 1 0 0-161.353142H300.105143a80.676571 80.676571 0 0 0 0 161.353142z" fill="#8a8a8a" p-id="15873"></path></svg>
                </a>
                
            </div>

            
            <div class="post">
                <div class="post_title post_detail_title">
                    <span class="date" id="busuanzi_container_site_pv">访问量 <span id="busuanzi_value_site_pv">...</span> 次</span>
                </div>
                <div class="post_title post_detail_title">
                    <span class="date" id="busuanzi_container_site_uv">访客数 <span id="busuanzi_value_site_uv">...</span> 人</span>
                </div>
            </div>
            

            <div class="post">
                <div class="post_title post_detail_title">
                    
                    <span class="date">总文章数 196 篇</span>
                </div>
                <div class="post_title post_detail_title">
                    
                    
                    
                    
                    
                    <span class="date">博客已运行 2092 天</span>
                </div>
            </div>

        </div>
    </div>
</div>
        <div class="content">
            <div class="post_page">
                <div class="post animate__animated animate__fadeInDown">
                    <div class="post_title post_detail_title">
                        <h2 id="post_single_title">MySQL详解</h2>
                        <span id="post_page_title_date" class="date">2024.05.30</span>





                    </div>
                    <div class="post_content markdown"><h2 id="概述">概述</h2>
<p>MySQL是一种关系型数据库，主要用于持久化存储我们系统中的一些数据。MySQL如此流行的原因，主要具有下面这些优点：</p>
<ul>
<li>成熟稳定，功能完善。</li>
<li>开源免费。</li>
<li>文档丰富，既有详细的官方文档，又有非常多优质文章可供参考学习。</li>
<li>开箱即用，操作简单，维护成本低。</li>
<li>兼容性好，支持常见的操作系统，支持多种开发语言。</li>
<li>社区活跃，生态完善。</li>
<li>事务支持优秀，<code>InnoDB</code>存储引擎默认使用<code>REPEATABLE-READ</code>并不会有任何性能损失，并且<code>InnoDB</code>实现的<code>REPEATABLE-READ</code>隔离级别其实是可以解决幻读问题发生的。</li>
<li>支持分库分表、读写分离、高可用。</li>
</ul>
<p>MySQL逻辑架构，主要分为：连接层，服务层，引擎层，存储层。客户端执行一条<code>select</code>命令的流程如下：</p>
<p><img alt="MySqlSQL优化及锁机制-001" src="/posts/annex/images/essays/MySqlSQL%E4%BC%98%E5%8C%96%E5%8F%8A%E9%94%81%E6%9C%BA%E5%88%B6-001.png"></p>
<ul>
<li>连接层：最上层是一些客户端和连接服务，包含本地<code>socket</code>通信和大多数基于客户端/服务端工具实现的类似于<code>tcpIp</code>的通信。主要完成一些类似于连接处理、授权认证、及相关的安全方案。在该层上引入了线程池的概念，为通过认证安全接入的客户端提供线程。同样在该层上可以实现基于SSL的安全链接。服务器也会为安全接入的每个客户端验证它所具有的操作权限。</li>
<li>服务层：第二层架构主要完成大多少的核心服务功能，如<code>SQL</code>接口，并完成缓存的查询，<code>SQL</code>的分析和优化及部分内置函数的执行。所有跨存储引擎的功能也在这一层实现，如过程、函数等。在该层，服务器会解析查询并创建相应的内部解析树，并对其完成相应的优化如确定查询表的顺序是否利用索引等，最后生成相应的执行操作。如果是<code>select</code>语句，服务器还会查询内部的缓存。如果缓存空间足够大，这样在解决大量读操作的环境中能够很好的提升系统的性能。</li>
<li>引擎层：存储引擎层，存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过API与存储引擎进行通信。不同的存储引擎具有的功能不同这样我们可以根据自己的实际需要进行选取，后面介绍<code>MyISAM</code>和<code>InnoDB</code>。</li>
<li>存储层：数据存储层，主要是将数据存储在运行于裸设备的文件系统之上，并完成与存储引擎的交互。</li>
</ul>
<h2 id="mysql存储引擎">MySQL存储引擎</h2>
<p>MySQL核心在于存储引擎，MySQL5.5.5之前，<code>MyISAM</code>是MySQL的默认存储引擎。5.5.5版本之后，<code>InnoDB</code>是MySQL的默认存储引擎。
可以使用<code>show engines;</code>命令来查看存储引擎。</p>
<p><img alt="MySQL存储引擎" src="/posts/annex/images/essays/MySQL%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E.png"></p>
<p>MySQL存储引擎有很多，但最主要的就是<code>InnoDB</code>和<code>MyISAM</code>。</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>InnoDB</th>
<th>MyISAM</th>
</tr>
</thead>
<tbody>
<tr>
<td>事务支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>锁类型</td>
<td>行级锁</td>
<td>表级锁</td>
</tr>
<tr>
<td>外键支持</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>崩溃恢复</td>
<td>支持</td>
<td>不支持</td>
</tr>
<tr>
<td>数据存储</td>
<td>表和索引存储在表空间中</td>
<td>数据和索引存储在不同文件中</td>
</tr>
<tr>
<td>全文索引</td>
<td>MySQL 5.6及以上版本支持</td>
<td>支持</td>
</tr>
<tr>
<td>适用场景</td>
<td>高并发和事务性要求高的应用</td>
<td>读操作多、写操作少的应用</td>
</tr>
<tr>
<td>性能</td>
<td>写性能较好，读性能较好</td>
<td>读性能高，写性能相对较差</td>
</tr>
<tr>
<td>数据完整性</td>
<td>高</td>
<td>低</td>
</tr>
</tbody>
</table>
<p>选择<code>InnoDB</code>还是<code>MyISAM</code>取决于具体的应用需求。<code>InnoDB</code>适合需要高并发、高数据完整性和事务支持的应用，而<code>MyISAM</code>适合读操作多、数据一致性要求不高的应用。
尽管<code>MyISAM</code>在特定场景下仍然有其应用价值，但随着<code>MySQL</code>版本的更新和<code>InnoDB</code>性能的不断提升，大多数新应用和系统都选择了<code>InnoDB</code>作为主要存储引擎。
遗留系统可能继续使用<code>MyISAM</code>，但在新开发中，使用<code>InnoDB</code>已成为主流和最佳实践。</p>
<h2 id="mysql事务">MySQL事务</h2>
<p>什么是事务？举个例子：你去超市买东西，&ldquo;一手交钱，一手交货&quot;就是一个事务的例子。
交钱和交货必须同时成功，事务才算成功，其中有一个环节失败，事务将会撤销所有已成功的活动。</p>
<p>所以事务可以看作是一次重大的活动，它由不同的小活动组成，这些活动要么全部成功，要么全部失败。
在MySQL中所有的存储引擎中只有<code>InnoDB</code>、<code>NDB</code>是事务性存储引擎，也就是说只有<code>InnoDB</code>、<code>NDB</code>支持事务。</p>
<p>只要对数据库稍有了解的人都知道事务具有ACID四个基本属性，而我们不知道的可能就是数据库是如何实现这四个属性的。
简单来说，事务是通过事务日志来实现的，事务日志包括：<code>redo log</code>和<code>undo log</code>，下面详细介绍。</p>
<h3 id="mysql中的日志">MySQL中的日志</h3>
<p>MySQL中的日志主要包括错误日志、查询日志、慢查询日志、事务日志、二进制日志几大类。
其中，比较重要的还要属二进制日志 <code>binlog</code>（归档日志）和<code>redo log</code>（重做|事物日志）和<code>undo log</code>（回滚日志）。</p>
<p>简单来说，MySQL<code>InnoDB</code>引擎使用 <code>redo log</code>(重做日志) 保证事务的持久性，使用 <code>undo log</code>(回滚日志)来保证事务的原子性。
MySQL的数据备份、主备、主主、主从都离不开<code>binlog</code>，需要依靠<code>binlog</code>来同步数据，保证数据一致性。</p>
<h3 id="atomicity原子性">Atomicity原子性</h3>
<p>要么全部都执行，要都不执行，不可能出现部分成功部分失败的情况，这是对原子性最简单的描述。</p>
<p>事务其实和一个操作没有什么太大的区别，它是一系列的数据库操作（可以理解为<code>SQL</code>）的集合，如果事务不具备原子性，那么就没办法保证同一个事务中的所有操作都被执行或者未被执行了，整个数据库系统就既不可用也不可信。</p>
<p>想要保证事务的原子性，就需要在异常发生时，对已经执行的操作进行回滚，而在MySQL中，恢复机制是通过回滚日志实现的。
为了能够在发生错误时撤销之前的全部操作，需要将之前的操作都记录下来的，所以所有事务进行的修改都会先记录到这个回滚日志中，然后再对数据库中的对应行进行操作。</p>
<p>回滚日志中保存的是逻辑日志，当回滚日志被使用时，它只会按照日志逻辑地将数据库中的修改撤销，相当于每一条<code>INSERT</code>都对应了一条<code>DELETE</code>，每一条<code>UPDATE</code>也都对应一条相反的<code>UPDATE</code>语句。</p>
<h3 id="consistency一致性">Consistency一致性</h3>
<p>数据库对于ACID中的一致性的定义是这样的：如果一个事务原子地在一个一致地数据库中独立运行，那么在它执行之后，数据库的状态一定是一致的。</p>
<p>对于这个概念，它的第一层意思就是对于数据完整性的约束，包括主键约束、引用约束以及一些约束检查等等，在事务的执行的前后以及过程中，不会违背对数据完整性的约束，所有对数据库写入的操作都应该是合法的，并不能产生不合法的数据状态。
第二层意思其实是指逻辑上的对于开发者的要求，我们要在代码中写出正确的事务逻辑，比如银行转账，事务中的逻辑不可能只扣钱或者只加钱，这是应用层面上对于数据库一致性的要求。</p>
<p>数据库ACID中的一致性，对事务的要求不止包含对数据完整性以及合法性的检查，还包含应用层面逻辑的正确。</p>
<h3 id="isolation隔离性">Isolation隔离性</h3>
<p>当事务都只是串行执行的时候是不会发生问题的，然而在实际工作中，并行执行的事务才是常态，并行执行下，可能出现非常复杂的问题：</p>
<p>当<code>Transaction1</code>在执行的过程中对 <code>id = 1</code> 的用户进行了读写，但是没有将修改的内容进行提交或者回滚，在这时<code>Transaction2</code>对同样的数据进行了读操作并提交了事务；
也就是说<code>Transaction2</code>是依赖于<code>Transaction1</code>的，当<code>Transaction1</code>由于一些错误需要回滚时，因为要保证事务的原子性，需要对<code>Transaction2</code>进行回滚，但是由于我们已经提交了<code>Transaction2</code>，所以我们已经没有办法进行回滚操作。
这种现象称为不可恢复安排，这种情况是我们难以接受的，如果相关的事物都回滚，这会造成性能上的巨大损失。</p>
<p>其实这里可以使用互斥锁来解决这个问题，在MySQL中，想要对读取的数据进行更新时需要使用<code>SELECT ... FOR UPDATE</code>尝试获取对应行的互斥锁，保证不同事务可以正常运行。</p>
<p>当多个事务同时并发执行时，事务的隔离性可能就会被违反，虽然单个事务的执行可能没有任何错误，但是从总体来看就会造成数据库的一致性出现问题，而串行虽然能够允许开发者忽略并行造成的影响，能够很好地维护数据库的一致性，但是却会影响事务执行的性能。
所以为数据库提供什么样的隔离性，也就决定了数据库的性能以及可以达到什么样的一致性。</p>
<p>在<code>SQL</code>标准中定义了四种数据库的事务的隔离级别：</p>
<ul>
<li><code>RAED UNCOMMITED</code>：使用查询语句不会加锁，可能会读到未提交的行；</li>
<li><code>READ COMMITED</code>：只对记录加记录锁，而不会在记录之间加间隙锁，所以允许新的记录插入到被锁定记录的附近，所以再多次使用查询语句时，可能得到不同的结果；</li>
<li><code>REPEATABLE READ</code>：多次读取同一范围的数据会返回第一次查询的快照，不会返回不同的数据行，但是可能发生幻读；</li>
<li><code>SERIALIZABLE</code>：<code>InnoDB</code>隐式地将全部的查询语句加上共享锁，解决了幻读的问题。最高的隔离级别，完全服从ACID的隔离级别，所有的事务依次逐个执行，这样事务之间就完全不可能产生干扰；</li>
</ul>
<p>从<code>RAED UNCOMMITED</code>到<code>SERIALIZABLE</code>，随着事务隔离级别变得越来越严格，每个事务的隔离级别其实都比上一级多解决了一个问题，但是数据库对于并发执行事务的性能也逐渐下降。</p>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
</tr>
</thead>
<tbody>
<tr>
<td>READ-UNCOMMITTED</td>
<td>√</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>READ-COMMITTED</td>
<td>×</td>
<td>√</td>
<td>√</td>
</tr>
<tr>
<td>REPEATABLE-READ</td>
<td>×</td>
<td>×</td>
<td>√</td>
</tr>
<tr>
<td>SERIALIZABLE</td>
<td>×</td>
<td>×</td>
<td>×</td>
</tr>
</tbody>
</table>
<p>数据库对于隔离级别的实现，就是使用并发控制机制对在同一时间执行的事务进行控制，限制不同的事务对于同一资源的访问和更新。</p>
<p>锁是一种最为常见的并发控制机制，在一个事务中，并不会将整个数据库都加锁，而是只会锁住那些需要访问的数据，MySQL和常见数据库中的锁都分为两种：读锁（共享锁）、写锁（互斥锁）。
读锁保证了读操作可以并发执行，相互不会影响，而写锁保证了在更新数据库数据时，不会有其他的事务访问或者更改同一条记录造成不可预知的问题。</p>
<p>除了锁，另一种实现事务隔离性的方式就是通过时间戳，但实际上就是一种乐观锁思想，PostgreSQL就是使用这种方式实现事务的数据库。
乐观锁在读取数据时不进行加锁操作，它“乐观”地认为在此期间数据不会被其他事务修改。
为了确保数据的一致性，在数据更新时验证数据的版本或者时间戳等标志信息，以此来判断数据是否被其他事务修改过。如果数据确实被修改过，则乐观锁的更新操作会失败，此时可以根据应用需求选择回滚事务。</p>
<p>再有就是多版本快照隔离思想。通过维护多个版本的数据，数据库可以允许事务在数据被其他事务更新时，对旧版本的数据进行读取，很多数据库都对这一机制进行了实现，也就是MVCC。
MySQL和PostgreSQL都对这一机制进行自己的实现。</p>
<h3 id="durability持久性">Durability持久性</h3>
<p>数据被写入到数据库中，那么数据一定是存储在磁盘上。事务的持久性就体现在，一旦事务被提交，那么数据一定会被写入到数据库中并持久存储起来。</p>
<p>当事务已经被提交之后，就无法再次回滚了，唯一能够撤回已经提交的事务的方式就是创建一个相反的事务对原操作进行撤销，这也是事务持久性的体现之一。</p>
<p>与原子性一样，事务的持久性也是通过日志来实现的，MySQL使用重做日志（redo log）实现事务的持久性。
重做日志由两部分组成，一是内存中的重做日志缓冲区，因为它保存在内存中，所以它是易失的，另一个就是在磁盘上的重做日志文件，它是持久的。</p>
<p>当我们在一个事务中尝试对数据进行修改时，首先会先将数据从磁盘读入内存，并更新内存中缓存的数据，然后生成一条重做日志并写入重做日志缓存。
当事务真正提交时，MySQL会将重做日志缓存中的内容，刷新到重做日志文件，即将内存中的数据更新到磁盘上。</p>
<p>在<code>InnoDB</code>中，重做日志都是以512字节的块的形式进行存储的，因为块的大小与磁盘扇区大小相同，所以重做日志的写入可以保证原子性，不会由于机器断电导致重做日志仅写入一半并留下脏数据。</p>
<h3 id="mvcc并发控制机制">MVCC并发控制机制</h3>
<p>MVCC是一种并发控制机制，解决多个并发事务同时读写数据库产生的一些问题，用于保持数据的一致性和隔离性。</p>
<p>它是通过在每个数据行上维护多个版本的数据来实现的。当一个事务要对数据库中的数据进行修改时，MVCC会为该事务创建一个数据快照，而不是直接修改实际的数据行。
读操作使用旧版本数据的快照，写操作创建新版本，并确保原版本仍可用。这样，不同的事务可以在一定程度上并发执行，而不会相互干扰。</p>
<p>当一个事务执行读操作时，它会使用快照读取。因为是快照读取，因此其他并发事务对数据行的修改不会影响当前事务的读取操作。
事务会查找符合条件的数据快照，并选择符合其事务开始时间的数据版本进行读取，读的是旧快照。
如果某个数据快照有多个版本，事务会选择不晚于其开始时间的最新版本，确保事务只读取在它开始之前已经存在的数据。</p>
<p>当一个事务执行写操作时，它会先生成一个新的数据版本快照。原始版本的数据仍然存在，供其他事务使用快照读取，这保证了其他事务不受当前事务的写操作影响。
新版本的数据会带有当前事务的版本号，以便其他事务能够正确读取相应版本的数据。然后将修改后的数据写入新版本。</p>
<p>当一个事务提交时，它所做的修改将成为数据库的最新版本，并且对其他事务可见。
当一个事务回滚时，它所做的修改将被撤销，对其他事务不可见。
为了防止数据库中的版本无限增长，MVCC会定期进行版本的回收。回收机制会删除已经不再需要的旧版本数据，从而释放空间。</p>
<p><code>InnoDB</code>对MVCC的实现主要是依赖于：隐藏字段、<code>Read View</code>、<code>undo log</code>。</p>
<ol>
<li>隐藏字段：
<ul>
<li><code>DB_TRX_ID（6字节）</code>：表示最后一次插入或更新该行的事务<code>id</code>。此外，<code>delete</code>操作在内部被视为更新，只不过会在记录头<code>Record header</code>中的<code>deleted_flag</code>字段将其标记为已删除；</li>
<li><code>DB_ROLL_PTR（7字节）</code> 回滚指针，指向该行的<code>undo log</code>。如果该行未被更新，则为空；</li>
<li><code>DB_ROW_ID（6字节）</code>：如果没有设置主键且该表没有唯一非空索引时，<code>InnoDB</code>会使用该<code>id</code>来生成聚簇索引；</li>
</ul>
</li>
<li><code>Read View</code>主要是用来做可见性判断，里面保存了 “当前对本事务不可见的其他活跃事务”。</li>
<li><code>undo log</code>作用是，当读取记录时，若该记录被其他事务占用或当前版本对该事务不可见，则可以通过<code>undo log</code>读取之前的版本数据，以此实现<strong>非锁定读</strong>。</li>
</ol>
<p>非锁定读是什么？</p>
<p>在<code>InnoDB</code>存储引擎中，多版本控制就是对非锁定读的实现。
如果读取的行正在执行<code>DELETE</code>或<code>UPDATE</code>操作，这时读取操作不会去等待行上锁的释放。相反地，<code>InnoDB</code>存储引擎会去读取行的一个快照数据，对于这种读取历史数据的方式，我们叫它快照读，就是对非锁定读的实现。
具体一点，在<code>Repeatable Read</code>和<code>Read Committed</code>两个隔离级别下，如果是执行普通的<code>select</code>语句，不包括 <code>select ... lock in share mode</code>、<code>select ... for update</code>则会使用一致性非锁定读。</p>
<h3 id="操作事物">操作事物</h3>
<p>所有的存储引擎中只有 <code>InnoDB</code>、<code>NDB</code> 是事务性存储引擎，也就是说只有 <code>InnoDB</code>、<code>NDB</code> 支持事务。
不支持的存储引擎，比如在<code>MyISAM</code>上操作事务，事务不会生效，SQL语句直接自动执行提交，所以回滚对于不支持事务的存储引擎是无效的。</p>
<p>启动事务的方式：</p>
<ul>
<li><code>begin</code>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">mysql&gt; begin;
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (0.00 sec)
</span></span><span class="line"><span class="cl">mysql&gt; 事务操作SQL......
</span></span></code></pre></div></li>
<li><code>start transaction [修饰符]</code>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">修饰符：
</span></span><span class="line"><span class="cl">1. read only //只读
</span></span><span class="line"><span class="cl">2. read write //读写 默认
</span></span><span class="line"><span class="cl">3. WITH CONSISTENT SNAPSHOT //一致性读
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- 例如
</span></span><span class="line"><span class="cl">mysql&gt; start transaction read only;
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (0.00 sec)
</span></span><span class="line"><span class="cl">mysql&gt; 事务操作SQL......
</span></span></code></pre></div></li>
</ul>
<p>提交事物完整示例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">mysql&gt; begin;
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (0.01 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; update account set balance=balance-20 where id = 1;
</span></span><span class="line"><span class="cl">Query OK, 1 row affected (0.00 sec)
</span></span><span class="line"><span class="cl">Rows matched: 1  Changed: 1  Warnings: 0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; update account set balance=balance+20 where id = 2;
</span></span><span class="line"><span class="cl">Query OK, 1 row affected (0.00 sec)
</span></span><span class="line"><span class="cl">Rows matched: 1  Changed: 1  Warnings: 0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; commit;
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (0.01 sec)
</span></span></code></pre></div><p>回滚事物完整示例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">mysql&gt; begin;
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; update account set balance=balance-25 where id = 1;
</span></span><span class="line"><span class="cl">Query OK, 1 row affected (0.00 sec)
</span></span><span class="line"><span class="cl">Rows matched: 1  Changed: 1  Warnings: 0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; update account set balance=balance+25 where id = 2;
</span></span><span class="line"><span class="cl">Query OK, 1 row affected (0.00 sec)
</span></span><span class="line"><span class="cl">Rows matched: 1  Changed: 1  Warnings: 0
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; rollback;
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (0.00 sec)
</span></span></code></pre></div><p>默认是事务自动提交的，每执行一条<code>SQL</code>就自动提交。此时需要操作事务，则需要显式开启和提交或回滚。
如设置成<code>OFF</code>，则需要执行提交或回滚操作时才会真正执行事务。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-txt" data-lang="txt"><span class="line"><span class="cl">--查看事务开启情况：
</span></span><span class="line"><span class="cl">mysql&gt; SHOW VARIABLES LIKE &#39;autocommit&#39;;
</span></span><span class="line"><span class="cl">+---------------+-------+
</span></span><span class="line"><span class="cl">| Variable_name | Value |
</span></span><span class="line"><span class="cl">+---------------+-------+
</span></span><span class="line"><span class="cl">| autocommit | ON |
</span></span><span class="line"><span class="cl">+---------------+-------+
</span></span></code></pre></div><h2 id="mysql索引">MySQL索引</h2>
<p>MySQL官方对索引的定义为，索引是帮助MySQL高效获取数据的数据结构，所以索引的本质是数据结构。
我们平常所说的索引，如果没有特别指明，都是指B树结构组织的索引。当然，除了B+树这种类型的索引之外，还有哈稀索引等。</p>
<p>索引相当于一本书的目录或者字典。比如，要查“mysql”这个单词，我们肯定需要定位到m字母，然后从下往下找到y字母，再找到剩下的sql；如果没有索引，那么你可能需要逐个逐个寻找。
可以简单理解为，索引维护的就是一组排好序的数据，通过这种有序的数据结构能快速的查找到想要的数据，索引这种数据结构就是以空间换取时间。</p>
<h3 id="索引数据结构">索引数据结构</h3>
<p>目前大部分数据库系统及文件系统都采用B-树或其变种B+树作为索引结构。那为什么使用B-树、B+树作为索引的数据结构呢？</p>
<p>一般来说，索引本身也很大，不可能全部存储在内存中，因此索引往往以索引文件的形式存储的磁盘上。
这样的话，索引查找过程中就要产生磁盘IO消耗，相对于内存存取，IO存取的消耗要高几个数量级，所以评价一个数据结构作为索引的优劣最重要的指标，就是在查找过程中磁盘IO操作次数的渐进复杂度。
换句话说，索引的结构组织要尽量减少查找过程中磁盘IO的存取次数。</p>
<p>B树即<code>B-tree</code>树，B即<code>Balanced</code>平衡的意思。B树通过重新组织节点，降低树的高度，并且减少IO读写次数来提升效率。
文件系统及数据库系统的设计者，利用了<strong>磁盘预读原理</strong>，将一个节点的大小设为一个页，这样每个节点只需要一次IO就可以完全载入。</p>
<p>磁盘预读原理是什么？</p>
<p>主存即主存储器，是计算机中最重要的存储层次之一，它直接与CPU进行数据交换。主存的访问速度很快，但价格较高，且容量有限。主存用于存储当前正在被CPU处理的数据和程序代码。
磁盘是计算机中重要的辅助存储设备之一，磁盘的容量较大，价格较低，但访问速度较慢。磁盘通常用于长期存储大量的数据和程序代码。</p>
<p>在存储层次结构中，磁盘通常被用作主存的扩展。当主存空间不足时，操作系统会将一些不常用的数据和程序代码从主存中移到磁盘上，以释放主存空间。
当这些数据和程序代码再次被需要时，操作系统会将其从磁盘中读取回主存。这就是所谓的磁盘缓存。</p>
<p>在计算机中，磁盘的读写速度远低于主存和高速缓存，但它的容量较大，可以长期保存大量的数据和程序代码，因此为了提高效率，尽量减少磁盘IO。
为了达到这个目的，磁盘往往不是严格按需读取，而是每次都会预读，即使只需要一个字节，磁盘也会从这个位置开始，顺序向后读取一定长度的数据放入内存，这个过程是磁盘预读。
磁盘预读的理论依据是<strong>局部性原理</strong>，即当一个数据被用到时，其附近的数据也通常会马上被使用。</p>
<p>磁盘预读的长度一般为页的整倍数。页是计算机管理存储器的逻辑块，硬件及操作系统往往将主存和磁盘存储区分割为连续的大小相等的块，每个存储块称为一页（在许多操作系统中，页得大小通常为4k），主存和磁盘以页为单位交换数据。
当程序要读取的数据不在主存中时，会触发一个缺页异常，此时系统会向磁盘发出读盘信号，磁盘会找到数据的起始位置并向后连续读取一页或几页载入内存中，然后异常返回，程序继续运行。</p>
<h3 id="索引的实现">索引的实现</h3>
<p>在MySQL中，索引属于存储引擎级别的概念，不同存储引擎对索引的实现方式是不同的，这里主要讨论<code>MyISAM</code>、<code>InnoDB</code>两个不同的存储引擎对索引实现方式。</p>
<h4 id="myisam索引的实现">MyISAM索引的实现</h4>
<p>在<code>MyISAM</code>引擎中，建立的索引文件和数据文件是分离的，<code>B+Tree</code>叶节点存放的是数据记录的地址。</p>
<p><img alt="MyISAM索引结构" src="/posts/annex/images/essays/MyISAM%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84.png"></p>
<p>在索引检索的时候，首先按照<code>B+Tree</code>搜索算法搜索索引，如果指定的<code>Key</code>存在，则取出其叶子结点的值，然后以叶子结点的值为地址读取相应的数据记录。
这种表示索引结构与数据行存储顺序无关的索引，叫做非聚集索引。</p>
<p><code>MyISAM</code>中的主索引和辅助索引在结构上是类似的，都是采用<code>B-Tree</code>结构。它们之间的主要区别在于，主索引要求索引列的值必须唯一，而辅助索引则可以包含重复值。
但是无论主索引还是辅助索引，它们的叶子节点存储的都是指向数据行实际存储位置的指针，而不是数据本身。
因此，当通过索引访问数据时，<code>MyISAM</code>需要进行两次查找：首先在索引中找到对应记录的位置，然后根据该位置读取实际的数据行。</p>
<h4 id="innodb索引的实现">InnoDB索引的实现</h4>
<p>在<code>InnoDB</code>引擎中，其数据文件本身就是索引文件。</p>
<p><img alt="Innodb索引结构" src="/posts/annex/images/essays/Innodb%E7%B4%A2%E5%BC%95%E7%BB%93%E6%9E%84.png"></p>
<p>表数据文件本身就是按<code>B+Tree</code>组织的一个索引结构，这棵树的叶节点<code>data</code>域保存了完整的数据记录。这个索引的<code>key</code>是数据表的主键，因此<code>InnoDB</code>表数据文件本身就是<strong>主索引</strong>。
索引的键值决定了表中数据的物理顺序，这种被称为聚簇索引或聚集索引。</p>
<p>因为<code>InnoDB</code>的数据文件本身要按主键聚集，所以<code>InnoDB</code>要求表必须有主键，<code>MyISAM</code>可以没有。如果没有显式指定，则MySQL系统会自动选择一个可以唯一标识数据记录的列作为主键。
如果不存在这种列，则MySQL自动为<code>InnoDB</code>表生成一个隐含字段作为主键，这个字段长度为6个字节，类型为长整形。</p>
<p>与<code>MyISAM</code>索引的不同是，<code>InnoDB</code>的<strong>辅助索引</strong><code>data</code>域，存储相应记录主键的值而不是地址。换句话说，辅助索引的叶节点存储的是主键值，加上一个指向主键的指针，而不是实际的数据行。
这意味着，当通过辅助索引查询数据时，数据库首先通过辅助索引找到主键，然后用主键到聚簇索引中去查找对应的完整数据行，这个过程称为回表查询。</p>
<p>知道了<code>InnoDB</code>的索引实现后，就很容易明白为什么不建议使用过长的字段作为主键，因为所有辅助索引都引用主索引，过长的主索引会令辅助索引变得过大。
再例如，用非单调递增或递减的字段作为主键在<code>InnoDB</code>中也不是个好主意，因为<code>InnoDB</code>数据文件本身是一颗<code>B+Tree</code>，非单调的主键会造成在插入新记录时数据文件为了维持<code>B+Tree</code>的特性而频繁的分裂调整，十分低效，而使用自增字段作为主键则是一个很好的选择。</p>
<p>主索引、辅助索引是什么？</p>
<ul>
<li>主索引通常是基于表的主键建立的索引，保证了索引列值的唯一性。在<code>InnoDB</code>存储引擎中，主索引实际上是一个聚簇索引，这意味着主键不仅提供唯一性约束，还决定了数据行的物理排列顺序。
在<code>MyISAM</code>中，主索引通常是基于表的一个唯一键创建的，最常见的是基于主键。如果未明确定义主键，<code>MyISAM</code>会尽可能选择一个唯一的非空索引作为主索引。</li>
<li>辅助索引是相对于主索引而言，指除主索引之外的其他索引，可以是基于非主键列创建的索引，用于加速对这些列的查询。
在<code>InnoDB</code>存储引擎中辅助索引的叶子结点存储的是主键值。在<code>MyISAM</code>中，叶子节点存储的是指向数据行实际存储位置的指针。</li>
</ul>
<h3 id="索引分类">索引分类</h3>
<p>按照应用维度划分：</p>
<ul>
<li>主键索引：属于唯一索引的一种，但是值不能为<code>null</code>；</li>
<li>唯一索引：索引列的值必须唯一，但允许有空值；</li>
<li>单值索引：即一个索引只包含单个列，一个表可以有多个单列索引；</li>
<li>复合索引：一个索引包含多个列；</li>
</ul>
<p>按照底层存储方式角度划分：</p>
<ul>
<li>聚簇索引（聚集索引）：索引结构和数据一起存放的索引，<code>InnoDB</code>中的主键索引就属于聚簇索引。</li>
<li>非聚簇索引（非聚集索引）：索引结构和数据分开存放的索引，二级索引(辅助索引)就属于非聚簇索引。MySQL的<code>MyISAM</code>引擎，不管主键还是非主键，使用的都是非聚簇索引。</li>
</ul>
<h3 id="操作索引">操作索引</h3>
<p>创建索引：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="p">[</span><span class="k">UNIQUE</span><span class="p">]</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">indexName</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">mytable</span><span class="p">(</span><span class="n">columnName</span><span class="p">(</span><span class="k">length</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">ALTER</span><span class="w"> </span><span class="n">mytable</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="p">[</span><span class="k">UNIQUE</span><span class="p">]</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="p">[</span><span class="n">indexName</span><span class="p">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">(</span><span class="n">columnName</span><span class="p">(</span><span class="k">length</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></div><p>删除索引：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="k">DROP</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="p">[</span><span class="n">indexName</span><span class="p">]</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="p">[</span><span class="n">tableName</span><span class="p">];</span><span class="w">
</span></span></span></code></pre></div><p>修改索引：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 该语句添加一个主键，这意味着索引值必须是唯一的，且不能为NULL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">tableName</span><span class="p">]</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">column_list</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 这条语句创建索引的值必须是唯一的(除了NULL外，NULL可能会出现多次)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">tableName</span><span class="p">]</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="p">[</span><span class="n">indexName</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">column_list</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 添加普通索引，索引值可出现多次
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">tableName</span><span class="p">]</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="p">[</span><span class="n">indexName</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">column_list</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 该语句指定了索引为FULLTEXT，用于全文索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="p">[</span><span class="n">tableName</span><span class="p">]</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="n">FULLTEXT</span><span class="w"> </span><span class="p">[</span><span class="n">indexName</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="n">column_list</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>查看索引：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="k">SHOW</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">[</span><span class="n">tableName</span><span class="p">];</span><span class="w">
</span></span></span></code></pre></div><h3 id="最左前缀匹配原则">最左前缀匹配原则</h3>
<p>最左前缀匹配原则是指在使用复合索引，即包含多个列的索引时，MySQL优化器会尽可能地根据索引中的字段顺序，从左到右依次匹配查询条件中的字段。
如果查询条件与索引中的最左侧字段相匹配，那么MySQL就会使用索引来过滤数据，这样可以提高查询效率。</p>
<p>想要发挥最左前缀匹配的效果，你的查询条件应该至少从复合索引的第一列开始，并且尽可能地包含更多连续的索引列。
如果查询条件没有从第一列开始或者跳过了中间的列，那么索引的部分或全部效果就可能没法用了。</p>
<p>现在有一个<code>students</code>表，它有三个列(<code>id</code>、<code>first_name</code>、<code>last_name</code>)，并且针对这三个列创建了一个复合索引(<code>id</code>、<code>first_name</code>、<code>last_name</code>)。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 可以命中索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">student</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;lisa&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;liu&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 无法命中索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">student</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;lisa&#39;</span><span class="w">
</span></span></span></code></pre></div><p>联合索引的最左匹配原则，在遇到范围查询（如 <code>&gt;</code>、<code>&lt;</code>）的时候，就会停止匹配，也就是范围查询的字段可以用到联合索引，但是在范围查询字段后面的字段无法用到联合索引。
但是对于<code>&gt;=</code>、<code>&lt;=</code>、<code>BETWEEN</code>、<code>like</code>前缀匹配这四种范围查询，并不会停止匹配。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 可以命中 id、first_name列，没命中last_name 列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">student</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;%123%&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%lisa%&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;liu&#39;</span><span class="w">
</span></span></span></code></pre></div><h3 id="索引覆盖">索引覆盖</h3>
<p>覆盖索引也被称为索引覆盖，如果一个索引包含或者说覆盖所有需要查询的字段的值，就称为索引覆盖。</p>
<p>查询的数据列从索引文件中就能够取得，不必读取原数据、回表查询。
MySQL可以利用索引返回<code>select</code>列表中的字段，而不用根据索引再次读取数据文件，换句话说查询到的列全部都在索引列中就是索引覆盖。</p>
<p>如果要使用覆盖索引，一定要注意<code>select</code>列表中只取出需要的列，不可<code>select *</code>，因为如果将所有字段一起做索引会导致索引文件过大，查询性能下降。</p>
<p>覆盖索引举例，<code>(id, first_name, last_name)</code>为一个复合索引。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">--  覆盖索引，全部命中
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">select</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="n">first_name</span><span class="p">,</span><span class="n">last_name</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">student</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;%123%&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">first_name</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%lisa%&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">last_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;liu&#39;</span><span class="w">
</span></span></span></code></pre></div><h3 id="索引建立原则">索引建立原则</h3>
<p>既然索引可以加快查询速度，那么是不是只要是查询语句需要，就建上索引？
答案肯定是不可以。索引虽然加快了查询速度，但索引也是有代价的，索引文件本身要消耗存储空间，同时索引会加重插入、删除和修改记录时的负担。另外MySQL在运行时也要消耗资源维护索引，因此索引并不是越多越好。</p>
<p>以下是建立索引的一些原则：</p>
<ul>
<li>数据量很小则不适合建立：如果数据库的数据量不大，那么使用索引也不一定能够带来很大提升，所以没有必要建立索引；</li>
<li>不要建立太多的索引：因为维护索引是需要耗费空间和性能的，MySQl会为了每一个索引维护一个B树，如果索引过多，这无疑是增加了MySQL的负担；</li>
<li>频繁增删改的字段不要建立索引：如果某个字段频繁修改，那就意味着也需要修改索引，这必然影响MySQL的性能；</li>
<li>为频繁查询的字段建立索引：建立索引要为经常作为查询条件的字段建立索引，这样能提高<code>SQL</code>的查询效率，与之相反的不要为很少使用的字段建立索引；</li>
<li>避免为”大字段”建立索引：就是尽量使用字段长度小的字段作为索引；例如，要为<code>varchar(5)</code>和<code>varchar(200)</code>的字段建立索引，则优先考虑为<code>varchar(5)</code>的建立；如果非要为<code>varchar(200)</code>的字段建立索引那么可以这样：
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 为varchar(200)的字段建立索引，将其长度设置为 20  
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">index</span><span class="w">  </span><span class="n">tbl_001</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">dual</span><span class="p">(</span><span class="n">address</span><span class="p">(</span><span class="mi">20</span><span class="p">));</span><span class="w">
</span></span></span></code></pre></div></li>
<li>选择数据区分大的列建立索引：如果某个字段包含许多重复的数据则不适合建立索引。假设现在有一个”性别”字段，里面存放的数据的值要么是男，要么是女，这样的字段很不适合作为索引。
因为如果值出现的几率几乎相等，那么无论搜索哪个值都可能得到一半的数据。在这些情况下，还不如不要索引，因为MySQL他还有一个查询优化器，查询优化器发现某个值出现在表的数据行中的百分比很高的时候，它一般会忽略索引，进行全表扫描。
惯用的百分比界线是”30%”。匹配的数据量超过一定限制的时候查询器会放弃使用索引，这也是索引失效的场景之一。</li>
</ul>
<h3 id="避免索引失效原则">避免索引失效原则</h3>
<p>建立索引之后还要保证索引生效，才能发挥索引的作用，以下是避免索引失效的原则：</p>
<ul>
<li>在使用复合索引时，不要跨列使用或无序使用，即最佳左前缀法则，否则索引失效；
跨列使用指，<code>where</code>后边的字段和<code>order by</code>后边的字段拼接起来，看是否满足索引的顺序，如不满足则为跨列，会出现<code>Using filsort</code>。</li>
<li>不要在索引上进行任何操作，例如：计算、函数运算、类型转换等，否则索引失效；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- age列为索引，但此时SQL语句age列存在计算，age索引列失效；
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">age</span><span class="o">*</span><span class="mi">3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;10&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- name为索引列，此时在该索引列上进行函数计算，name索引列失效；
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="k">left</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span><span class="o">=</span><span class="s1">&#39;July&#39;</span><span class="p">;</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- typeid为索引列，typeid为int类型，此时发生隐式类型转换，typeid索引列失效；
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="n">typeid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;1&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></li>
<li>复合索引不能使用不等于（<code>!=</code>、<code>&lt;&gt;</code>）或<code>is null</code>、<code>is not null</code>，否则自身及右侧索引全部失效；
大部分情况下如果复合索引使用上面的运算符索引会失效，但是MySQL在服务层存在<code>SQL</code>优化阶段，所以复合索引即使使用了不等于、<code>is null</code>、<code>is not null</code>等操作，还是可能会存在索引生效的情况；</li>
<li>尽量使用覆盖索引，使用覆盖索引会提高系统性能；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- name、tid、cid 为复合索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="n">tid</span><span class="p">,</span><span class="n">cid</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;zs&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></li>
<li><code>like</code>尽量以常量开头，不要以%开头，否则索引失效；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- name 为索引列，此处索引失效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_002</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%x%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 如果必须要使用%开头，可以使用覆盖索引挽救一下
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_002</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%x%&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></li>
<li>不要使用<code>or</code>，否则索引失效；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- authorid、typeid为复合索引，此处or的左右两边索引全部失效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">book_2021</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">authorid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">or</span><span class="w"> </span><span class="n">typeid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></li>
<li>避免使用<code>*</code>，因为使用<code>*</code>之后MySQL还需要计算把<code>*</code>替换成对应的列；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 不要使用*，把*替换成具体需要的列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">book_2021</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></li>
</ul>
<h2 id="mysql执行计划">MySQL执行计划</h2>
<p>执行计划是指一条<code>SQL</code>语句在经过MySQL查询优化器的优化后，具体的执行方式。
使用<code>explain</code>关键字可以模拟优化器执行SQL查询语句，从而知道MySQL是如何处理你的<code>SQL</code>语句的，分析你的查询语句或是表结构的性能瓶颈。
<code>explain</code>不止适用于<code>select</code>也适用于<code>delete</code>、<code>insert</code>、<code>replace</code>和<code>update</code>语句。</p>
<p>当<code>explain</code>可解释语句一起使用时，MySQL会显示来自优化器的关于语句执行计划的信息，也就是说MySQL解释了它将如何处理语句，包括有关表如何连接以及按顺序连接的信息。</p>
<p>在MySQL中执行任意一条<code>SQL</code>前加上<code>explain</code>关键字，即可看到：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl"> +----+-------------+----------+------+---------------+------+---------+------+------+-------+
</span></span><span class="line"><span class="cl"> | id | select_type | table    | type | possible_keys | key  | key_len | ref  | rows | Extra |
</span></span><span class="line"><span class="cl"> +----+-------------+----------+------+---------------+------+---------+------+------+-------+
</span></span></code></pre></div><h3 id="idtable">id、table</h3>
<p><code>table</code>是显示这一行的数据是关于哪张表的。<code>id</code>是<code>select</code>查询的序列号，包含一组数字，表示查询中执行<code>select</code>子句或操作表的顺序。</p>
<ul>
<li><code>id</code>值相同，执行顺序由上至下；</li>
<li><code>id</code>值不同，<code>id</code>值越大优先级越高，越先被执行；</li>
</ul>
<p>表的执行顺序与表中数据息息相关，举个例子：表A：3条数据 表B：4条数据 表C：6条数据。
假设在执行某条<code>SQL</code>的情况下表A、B、C的<code>id</code>值相同，假设执行顺序：表A、B、C。在给表B添加4条数据后，再次执行前面的这条<code>SQL</code>发现执行顺序变为：表A、C、B。
这是因为中间结果会影响表的执行顺序：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">3 * 4 * 2 = 12 * 2 = 24
</span></span><span class="line"><span class="cl">3 * 2 * 4 = 6 * 4 = 24
</span></span></code></pre></div><p>虽然最后结果一样，但是中间过程不一样。中间过程越小占用的空间越小，所以在<code>ID</code>值相同的情况下数据小的表优先查询。</p>
<h3 id="select_type">select_type</h3>
<p><code>select_type</code>是查询的类型，主要是用于区别普通查询、联合查询、子查询等的复杂查询。查询类型：</p>
<ul>
<li><code>PRIMARY</code>：包含自查询的主查询，最外层部分；</li>
<li><code>SUBQUERY</code>：查询语句中包含了子查询，非最外层；</li>
<li><code>SIMPLE</code>：简单查询,即SQL中不包含子查询或者UNION查询；</li>
<li><code>DERIVED</code>：在查询过程中创建了临时表，例如：
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">table1</span><span class="p">)</span><span class="w"> </span><span class="n">t1</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></li>
<li><code>UNION</code>：若第二个<code>SELECT</code>出现在<code>UNION</code>之后，则被标记为<code>UNION</code>；若<code>UNION</code>包含在<code>FROM</code>子句的子查询中外层<code>SELECT</code>将被标记为<code>DERIVED</code>；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> explain select name from (select * from table1 union select * from table2) t1;
</span></span></code></pre></div></li>
<li><code>UNION RESULT</code>：从<code>UNION</code>表中的结果；</li>
</ul>
<h3 id="type">type</h3>
<p><code>type</code>是索引类型，是较为重要的一个指标，结果值从最好到最坏依次是：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl"> system &gt; const &gt; eq_ref &gt; ref &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt;ALL
</span></span></code></pre></div><p>实际工作中可能用不到这么多，一般只要记住以下就行了：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl"> system &gt; const &gt; eq_ref &gt; ref &gt; range &gt; index &gt; ALL
</span></span></code></pre></div><p>其中<code>system</code>、<code>const</code>只是理想情况，实际能只达到<code>ref</code>、<code>range</code>。</p>
<p>常见索引类型：</p>
<ul>
<li><code>system</code>：表只有一行记录的系统表，或衍生表只有一行数据的主查询；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 衍生表：(select * from tbl_001) 只有一条记录；id为主键索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="p">)</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></li>
<li><code>const</code>：仅仅能查询到一条记录的SQL，并且用于主键索引或者唯一键索引；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- tbl_001表只有一条记录；id为主键索引或唯一键索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></li>
<li><code>eq_ref</code>：唯一性索引；对于每个索引键的查询，返回匹配唯一一行的数据,有且只有一个，不能多也不能为0；常见于主键或唯一索引扫描；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- tbl_001.tid为索引列；且tbl_001与tbl_002表中数据记录一一对应
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="p">,</span><span class="n">tbl_002</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">tbl_001</span><span class="p">.</span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tbl_002</span><span class="p">.</span><span class="n">id</span><span class="w">
</span></span></span></code></pre></div></li>
<li><code>ref</code>：非唯一性索引；对于每个索引键的查询，返回多个匹配的所有行，包括0个；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- name 为索引列；tbl_001 表中 name 值为 zs 的有多个
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;zs&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></li>
<li><code>range</code>：检索指定范围的行，where后面是一个范围查询常见：between and、in、&gt;、&lt;=；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- tid 为索引列；
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="o">&lt;=</span><span class="mi">3</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></li>
<li><code>index</code>：查询全部索引中的数据；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- name为索引列；
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></li>
<li><code>all</code>：查询全部表中的数据；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- name不是索引列；
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></li>
</ul>
<h3 id="possible_keyskey">possible_keys、key</h3>
<p><code>possible_keys</code>是可能用到的索引，是一种预测，不准确。<code>key</code>是实际用到的索引，如果为<code>null</code>则没有用到索引。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- name为索引列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+-------+---------------+----------+---------+------+------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+-------+---------------+----------+---------+------+------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="n">idx_name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">83</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+-------+---------------+----------+---------+------+------+-------------+
</span></span></span></code></pre></div><h3 id="key_len">key_len</h3>
<p><code>key_len</code>索引使用的长度，可通过索引列长度，例如：<code>name vachar(20)</code>，来判断复合索引到底有没有使用。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- name为索引列；可以为null；varchar类型；utf8字符集；
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;zs&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+-------+---------------+----------+---------+------+------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+-------+---------------+----------+---------+------+------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="n">idx_name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">63</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+-------+---------------+----------+---------+------+------+-------------+
</span></span></span></code></pre></div><p>其中，如果索引字段可以为<code>null</code>，MySQL会用一个字节进行标识，<code>varchar</code>为可变长度，MySQL用两个字节来标识。</p>
<blockquote>
<p>utf8：一个字符三个字节；
gbk：一个字符两个字节；
latin：一个字符一个字节；</p>
</blockquote>
<p>举例，字段<code>name vachar(20)</code>，不能为<code>null</code>，<code>utf8</code>编码，执行执行计划<code>name</code>列使用到了索引那么<code>key_len</code>等于<code>20*3+1+2=63</code>。</p>
<h3 id="ref">ref</h3>
<p><code>ref</code>指明当前表所引用的字段。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 其中b.d可以为常量，常量用 const 标识
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="k">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">d</span><span class="p">;</span><span class="w">  
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- tid 为索引列
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="n">tbl_002</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;zs&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-------+--------+------------------+----------+---------+-----------------+------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">             </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-------+--------+------------------+----------+---------+-----------------+------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">t1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">idx_name</span><span class="p">,</span><span class="n">idx_tid</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">idx_name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">83</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">const</span><span class="w">           </span><span class="o">|</span><span class="w">    </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">t2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="n">eq_ref</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">4</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">sql_demo</span><span class="p">.</span><span class="n">t1</span><span class="p">.</span><span class="n">tid</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">        </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-------+--------+------------------+----------+---------+-----------------+------+-------------+
</span></span></span></code></pre></div><h3 id="rows">rows</h3>
<p><code>rows</code>表示查询行数，实际通过索引查询到的个数。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="n">tbl_002</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ls&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+------+------+----+------+-------+-------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">tid</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">name1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">name2</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+------+------+----+------+-------+-------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ls</span><span class="w">   </span><span class="o">|</span><span class="w">    </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ls</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">ls1</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">ls2</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">ls</span><span class="w">   </span><span class="o">|</span><span class="w">    </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">zs</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">zs1</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">zs2</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+------+------+----+------+-------+-------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">mysql</span><span class="o">&gt;</span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="n">t1</span><span class="p">,</span><span class="n">tbl_002</span><span class="w"> </span><span class="n">t2</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">tid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">t2</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">t1</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ls&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-------+-------+------------------+------------+---------+----------------+------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">        </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-------+-------+------------------+------------+---------+----------------+------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">t2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">PRIMARY</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="n">index_name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">249</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">           </span><span class="o">|</span><span class="w">    </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">t1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">idx_name</span><span class="p">,</span><span class="n">idx_tid</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">idx_tid</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">5</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">sql_demo</span><span class="p">.</span><span class="n">t2</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-------+-------+------------------+------------+---------+----------------+------+-------------+
</span></span></span></code></pre></div><h3 id="extra">Extra</h3>
<p><code>Extra</code>包含不适合在其他列中显示但十分重要的额外信息。</p>
<p>常见值：</p>
<ul>
<li><code>Using filesort</code>：文件内排序；出现这个值代表额外的一次排序，性能消耗比较大，需要进行<code>SQL</code>优化。常见<code>order by</code>语句中；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- name 为单值索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;zs&#39;</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+------+---------------+----------+---------+-------+------+----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">          </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+------+---------------+----------+---------+-------+------+----------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">idx_name</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">idx_name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">83</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="n">filesort</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+------+---------------+----------+---------+-------+------+----------------+
</span></span></span></code></pre></div>对于单值索引来说，如果排序和查找的是同一个字段，则不会出现<code>Using filesort</code>反之则出现。一般通过<code>where</code>哪些字段就<code>orderby</code>哪些字段来避免。
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- name，tid 为复合索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;zs&#39;</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">tid</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+------+---------------+-----------+---------+-------+------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+------+---------------+-----------+---------+-------+------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">idx_trans</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">idx_trans</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">83</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+------+---------------+-----------+---------+-------+------+-------------+
</span></span></span></code></pre></div>对于复合索引来说要按照建立复合索引的顺序来使用，不要跨列或者无序使用。
<blockquote>
<p>跨列使用指，<code>where</code>后边的字段和<code>order by</code>后边的字段拼接起来，看是否满足索引的顺序，如不满足则为跨列，会出现<code>Using filsort</code>。</p>
</blockquote>
</li>
<li><code>Using temporary</code>：使了用临时表保存中间结果，MySQL在对查询结果排序时使用临时表。性能消耗也是很大的，一般出现这个词需要进行<code>SQL</code>优化。常见于分组查询<code>group by</code>语句；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- name、tid、cid 为复合索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;zs&#39;</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">cid</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+------+---------------+---------+---------+-------+------+------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">                        </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+------+---------------+---------+---------+-------+------+------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">idx_ntc</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">idx_ntc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">83</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">index</span><span class="p">;</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">temporary</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+------+---------------+---------+---------+-------+------+------------------------------+
</span></span></span></code></pre></div><code>Using temporary</code>出现的原因，已经有表了但是不使用，必须再来一张表。我们可以通过查询哪些列，就通过哪些列来分组来避免。</li>
<li><code>Using index</code>：出现这个值代表性能还是不错的；表示使用到了覆盖索引，不读取源文件，只从索引文件中获取数据，不需要回表查询。
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- name、tid、cid 为复合索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="n">tid</span><span class="p">,</span><span class="n">cid</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;zs&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+------+---------------+---------+---------+-------+------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+------+---------------+---------+---------+-------+------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">idx_ntc</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">idx_ntc</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">83</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+------+---------------+---------+---------+-------+------+-------------+
</span></span></span></code></pre></div>如果用到了索引覆盖时，会对<code>possible_key</code>和<code>key</code>造成影响：
<ul>
<li>如果没有使用到<code>where</code>，则索引只出现在<code>key</code>中；</li>
<li>如果有<code>where</code>，则索引出现在<code>key</code>和<code>possible_key</code>中；</li>
</ul>
</li>
<li><code>Using where</code>：出现这个值代表需要回表查询；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- name 为单值索引，此时索引中不包含其他字段，想要查询其他字段就必须回表查询
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="n">tid</span><span class="p">,</span><span class="n">cid</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;zs&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+------+---------------+---------+---------+-------+------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+------+---------------+---------+---------+-------+------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">idx_name</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">idx_name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">83</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">const</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">2</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+---------+------+---------------+---------+---------+-------+------+-------------+
</span></span></span></code></pre></div></li>
<li><code>Impossible WHERE</code>：<code>where</code>语句永远为<code>false</code>，永远不成立；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;zs&#39;</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;ls&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-------+------+---------------+------+---------+------+------+------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">            </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-------+------+---------------+------+---------+------+------+------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Impossible</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-------+------+---------------+------+---------+------+------+------------------+
</span></span></span></code></pre></div></li>
</ul>
<h2 id="mysql优化">MySQL优化</h2>
<p>为什么要进行优化？</p>
<ul>
<li>SQL语句欠佳、执行过程耗时较长、索引失效？</li>
<li>单库数据量越来越大，存储出现问题？</li>
<li>在高并发场景下，大量请求阻塞？</li>
</ul>
<p>总之一句话，数据库出现性能瓶颈。</p>
<h3 id="sql执行过程">SQL执行过程</h3>
<p>想要进行<code>SQL</code>优化，首先要弄懂<code>SQL</code>编写过程和<code>SQL</code>执行过程是存在区别的：</p>
<ul>
<li><code>SQL</code>编写过程：
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="k">having</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="p">..</span><span class="w">
</span></span></span></code></pre></div></li>
<li><code>SQL</code>执行过程：
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="p">..</span><span class="w">  </span><span class="k">where</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="k">having</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">distinct</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="p">..</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="p">..</span><span class="w">
</span></span></span></code></pre></div></li>
</ul>
<p>之所以<code>SQL</code>的编写过程会和执行过程有区别，是因为MySQL中有专门负责优化<code>select</code>语句的优化器模块。</p>
<blockquote>
<p>MySQL Query Optimizer：MySQL查询优化器。主要功能:通过计算分析系统中收集到的统计信息，为客户端请求的Select提供MySQL认为最优的执行计划。</p>
</blockquote>
<p>当客户端向MySQL请求一条<code>select</code>，命令解析器模块完成请求分类，区别出是<code>select</code>并转发给<code>MySQL Query Optimizer</code>时，<code>MySQL Query Optimizer</code>首先会对整条<code>select</code>进行优化，处理掉一些常量表达式的预算直接换算成常量值。
并对<code>select</code>中的查询条件进行简化和转换，如去掉一些无用或显而易见的条件、结构调整等。然后分析<code>select</code>中的<code>Hint</code>信息，看显示<code>Hint</code>信息是否可以完全确定该<code>select</code>的执行计划。
如果没有<code>Hint</code>或<code>Hint</code>信息还不足以完全确定执行计划，则会读取所涉及对象的统计信息，根据<code>Query</code>进行写相应的计算分析，然后再得出最后的执行计划。</p>
<blockquote>
<p>Hint: 简单来说就是在某些特定的场景下人工协助MySQL优化器的工作，使其生成最优的执行计划。 一般来说，优化器的执行计划都是最优化的，不过在某些特定场景下，执行计划可能不是最优化。</p>
</blockquote>
<h3 id="优化思路">优化思路</h3>
<p>数据库性能优化方案很多，主要分为两大类：软件层面、硬件层面。</p>
<p>软件层面包括，<code>SQL</code>调优、表结构优化、读写分离、数据库集群、分库分表等。硬件层面主要是增加机器性能。下面是几种常见的优化思路：</p>
<ol>
<li><code>SQL</code>调优主要目的是尽可能的让那些慢<code>SQL</code>变快，手段其实也很简单就是让<code>SQL</code>执行尽量命中索引：
<ul>
<li>避免在<code>where</code>子句中对字段进行<code>null</code>值判断，创建表默认值是<code>NULL</code>。尽量使用<code>NOT NULL</code>，或使用特殊值，如 0、-1；</li>
<li>避免在<code>where</code>子句中使用<code>!=</code>或<code>&lt;&gt;</code>操作符，MySQL 只有对以下操作符才使用索引：<code>&lt;</code>、<code>&lt;=</code>、<code>=</code>、<code>&gt;</code>、<code>&gt;=</code>、<code>BETWEEN</code>、<code>IN</code>、非<code>%</code>开头的<code>LIKE</code>；</li>
<li>避免在<code>where</code>子句中使用<code>or</code>来连接条件，可以使用<code>UNION</code>进行连接；</li>
<li>能用<code>union all</code>就不用 <code>union</code>，<code>union</code>过滤重复数据要耗费更多的CPU资源；</li>
<li>避免全部<code>like</code>查询，如<code>'%ConstXiong%'</code>；</li>
<li>避免在索引列上使用计算、函数；</li>
<li><code>in</code>和<code>not in</code>慎用，能用<code>between</code>不要用<code>in</code>；</li>
<li><code>select</code>子句中避免使用<code>*</code>；</li>
<li>根据<code>where</code>和<code>order by</code>使用比较频繁的字段创建索引，提高查询效率；</li>
<li>索引不宜过多，单表最好不要超过6个。索引过多会导致占用存储空间变大，<code>insert</code>、<code>update</code>变慢；</li>
<li>删除未使用的索引；</li>
</ul>
</li>
<li>如果是单表数据量太大，解决办法：
<ul>
<li>分页查询(在索引上完成排序分页操作、借助主键进行关联)；</li>
<li>单表数据过大，进行分库分表；</li>
<li>考虑使用非关系型数据库提高查询效率；</li>
<li>全文索引场景较多，考虑使用<code>ElasticSearch</code>、<code>solr</code>；</li>
</ul>
</li>
<li>其他优化：
<ul>
<li>数据库配置参数调整；</li>
<li>数据库表结构优化；</li>
<li>硬件优化，增加服务器数量，扩大服务器内存，CPU核数；</li>
</ul>
</li>
</ol>
<h3 id="排查慢sql">排查慢SQL</h3>
<p>想要优化<code>SQL</code>，首先要找到慢<code>SQL</code>，慢<code>SQL</code>日志超过响应时间的阈值默认10秒，便会记录该<code>SQL</code>。
慢<code>SQL</code>日志默认是关闭的，建议在开发调优时打开，最终部署上线时关闭。</p>
<h4 id="慢sql日志设置">慢SQL日志设置</h4>
<p>通过<code>SQL</code>来查看记录慢<code>SQL</code>日志是否开启：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 查看变量 slow_query_log，记录慢查询日志默认关闭
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%slow_query_log%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">---------------------+----------------------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Variable_name</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">Value</span><span class="w">                                        </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">---------------------+----------------------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">slow_query_log</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="k">OFF</span><span class="w">                                          </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">slow_query_log_file</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">MacBook</span><span class="o">-</span><span class="n">Pro</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">slow</span><span class="p">.</span><span class="n">log</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">---------------------+----------------------------------------------+
</span></span></span></code></pre></div><p>可以通过<code>SQL</code>来进行开启记录慢<code>SQL</code>日志：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 在内存中开启慢SQL记录日志； 此种方式在 mysql 服务重启后失效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="n">slow_query_log</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 查看是否开启慢SQL日志记录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%slow_query_log%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">---------------------+----------------------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Variable_name</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">Value</span><span class="w">                                        </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">---------------------+----------------------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">slow_query_log</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="k">ON</span><span class="w">                                           </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">slow_query_log_file</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">MacBook</span><span class="o">-</span><span class="n">Pro</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">slow</span><span class="p">.</span><span class="n">log</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">---------------------+----------------------------------------------+
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 在MySQL my.cnf 配置文件中追加配置;重启MySQL服务后也生效，即永久开启
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">slow_query_log</span><span class="o">=</span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">slow_query_log_file</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">MacBook</span><span class="o">-</span><span class="n">Pro</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">slow</span><span class="p">.</span><span class="n">log</span><span class="w">
</span></span></span></code></pre></div><p>查看慢<code>SQL</code>记录日志阈值：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 查看慢SQL记录日志阈值，默认10秒
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%long_query_time%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">-----------------+-----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Variable_name</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Value</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">-----------------+-----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">long_query_time</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">10</span><span class="p">.</span><span class="mi">000000</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">-----------------+-----------+
</span></span></span></code></pre></div><p>修改慢<code>SQL</code>记录日志阈值：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 在内存中修改设置慢查询SQL记录日志阈值为5秒；注意设置后不会立即生效，需要重新登陆mysql客户端才会生效
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="n">long_query_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">5</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 设置之后重新登陆mysql使用命令查看慢SQL查询日志阈值 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%long_query_time%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">-----------------+-----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Variable_name</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Value</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">-----------------+-----------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">long_query_time</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">5</span><span class="p">.</span><span class="mi">000000</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">-----------------+-----------+
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 在MySQL配置文件my.cnf中修改慢查询SQL记录日志阈值,设置为3秒
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">long_query_time</span><span class="o">=</span><span class="mi">3</span><span class="w">
</span></span></span></code></pre></div><h4 id="查看慢sql日志">查看慢SQL日志</h4>
<p>直接查看慢SQL日志；</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w">  </span><span class="c1">-- 模拟慢查询SQL 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">-- 查看是否开启慢SQL日志记录
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="k">show</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%slow_query_log%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">+</span><span class="c1">---------------------+----------------------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">Variable_name</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">Value</span><span class="w">                                        </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">+</span><span class="c1">---------------------+----------------------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">slow_query_log</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="k">ON</span><span class="w">                                           </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">slow_query_log_file</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">MacBook</span><span class="o">-</span><span class="n">Pro</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">slow</span><span class="p">.</span><span class="n">log</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="o">+</span><span class="c1">---------------------+----------------------------------------------+
</span></span></span></code></pre></div><p>查看慢<code>SQL</code>日志记录<code>cat /usr/local/mysql/data/MacBook-Pro-2-slow.log</code>执行命令：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="n">MacBook</span><span class="o">-</span><span class="n">Pro</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span><span class="o">~</span><span class="w"> </span><span class="n">root</span><span class="o">#</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">MacBook</span><span class="o">-</span><span class="n">Pro</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">slow</span><span class="p">.</span><span class="n">log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">mysqld</span><span class="p">,</span><span class="w"> </span><span class="k">Version</span><span class="p">:</span><span class="w"> </span><span class="mi">8</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">22</span><span class="w"> </span><span class="p">(</span><span class="n">MySQL</span><span class="w"> </span><span class="n">Community</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">GPL</span><span class="p">).</span><span class="w"> </span><span class="n">started</span><span class="w"> </span><span class="k">with</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Tcp</span><span class="w"> </span><span class="n">port</span><span class="p">:</span><span class="w"> </span><span class="mi">3306</span><span class="w">  </span><span class="n">Unix</span><span class="w"> </span><span class="n">socket</span><span class="p">:</span><span class="w"> </span><span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">mysql</span><span class="p">.</span><span class="n">sock</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">Time</span><span class="w">                 </span><span class="n">Id</span><span class="w"> </span><span class="n">Command</span><span class="w">    </span><span class="n">Argument</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="n">Time</span><span class="p">:</span><span class="w"> </span><span class="mi">2021</span><span class="o">-</span><span class="mi">09</span><span class="o">-</span><span class="mi">17</span><span class="n">T06</span><span class="p">:</span><span class="mi">46</span><span class="p">:</span><span class="mi">20</span><span class="p">.</span><span class="mi">655775</span><span class="n">Z</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="k">User</span><span class="o">@</span><span class="k">Host</span><span class="p">:</span><span class="w"> </span><span class="n">root</span><span class="p">[</span><span class="n">root</span><span class="p">]</span><span class="w"> </span><span class="o">@</span><span class="w"> </span><span class="n">localhost</span><span class="w"> </span><span class="p">[]</span><span class="w">  </span><span class="n">Id</span><span class="p">:</span><span class="w">    </span><span class="mi">15</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">#</span><span class="w"> </span><span class="n">Query_time</span><span class="p">:</span><span class="w"> </span><span class="mi">4</span><span class="p">.</span><span class="mi">003891</span><span class="w">  </span><span class="n">Lock_time</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000000</span><span class="w"> </span><span class="n">Rows_sent</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">  </span><span class="n">Rows_examined</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">sql_demo</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="k">timestamp</span><span class="o">=</span><span class="mi">1631861176</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">sleep</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>通过<code>mysqldumpslow</code>工具来查看,可以通过一些过滤条件快速找到需要定位的慢SQL；</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">--语法：mysqldumpslow 各种参数 慢查询日志文件路径
</span></span></span><span class="line"><span class="cl"><span class="c1">-- -s：排序方式
</span></span></span><span class="line"><span class="cl"><span class="c1">-- -r：逆序反转
</span></span></span><span class="line"><span class="cl"><span class="c1">-- -l：锁定时间，不要从总时间中减去锁定时间
</span></span></span><span class="line"><span class="cl"><span class="c1">-- -g：在文件中查找考虑包含此字符串的
</span></span></span><span class="line"><span class="cl"><span class="c1">-- 更多指令解析查看 mysqldumpslow --help
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 获取返回记录最多的3条SQL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">mysqldumpslow</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">MacBook</span><span class="o">-</span><span class="n">Pro</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">slow</span><span class="p">.</span><span class="n">log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 获取访问次数最多的3条SQL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">mysqldumpslow</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">MacBook</span><span class="o">-</span><span class="n">Pro</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">slow</span><span class="p">.</span><span class="n">log</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 按照时间排序，前10条包含 left join 的查询SQL 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">mysqldumpslow</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="mi">10</span><span class="w"> </span><span class="o">-</span><span class="k">g</span><span class="w"> </span><span class="s2">&#34;left join&#34;</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="k">local</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="k">data</span><span class="o">/</span><span class="n">MacBook</span><span class="o">-</span><span class="n">Pro</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">slow</span><span class="p">.</span><span class="n">log</span><span class="w">
</span></span></span></code></pre></div><h4 id="模拟数据并分析sql">模拟数据并分析SQL</h4>
<p>模拟数据。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 创建表
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">database</span><span class="w"> </span><span class="n">testdata</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">testdata</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">dept</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">dno</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">dname</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">loc</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">engine</span><span class="o">=</span><span class="n">innodb</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">charset</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">emp</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">eid</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">ename</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">job</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">deptno</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="mi">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="p">)</span><span class="n">engine</span><span class="o">=</span><span class="n">innodb</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="n">charset</span><span class="o">=</span><span class="n">utf8</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 创建存储过程：获取随机字符串
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="n">log_bin_trust_function_creators</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">testdata</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">delimiter</span><span class="w"> </span><span class="err">$</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">randstring</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="nb">int</span><span class="p">)</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">begin</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">declare</span><span class="w"> </span><span class="n">all_str</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;abcdefghijklmnopqrestuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">declare</span><span class="w"> </span><span class="n">return_str</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">255</span><span class="p">)</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">declare</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">while</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">n</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">do</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">set</span><span class="w"> </span><span class="n">return_str</span><span class="o">=</span><span class="n">concat</span><span class="p">(</span><span class="n">return_str</span><span class="p">,</span><span class="w"> </span><span class="k">substring</span><span class="p">(</span><span class="n">all_str</span><span class="p">,</span><span class="w"> </span><span class="n">FLOOR</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">rand</span><span class="p">()</span><span class="o">*</span><span class="mi">52</span><span class="p">),</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="k">set</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">end</span><span class="w"> </span><span class="n">while</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="n">return_str</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="err">$</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 创建存储函数：插入随机整数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">use</span><span class="w"> </span><span class="n">testdata</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">function</span><span class="w"> </span><span class="n">ran_num</span><span class="p">()</span><span class="w"> </span><span class="k">returns</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">begin</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">declare</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="n">floor</span><span class="p">(</span><span class="n">rand</span><span class="p">()</span><span class="o">*</span><span class="mi">100</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">i</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">end</span><span class="err">$</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 创建存储过程：向emp表插入数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">procedure</span><span class="w"> </span><span class="n">insert_emp</span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="n">eid_start</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">data_times</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">begin</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">declare</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">autocommit</span><span class="w"> </span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">repeat</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">emp</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="n">eid_start</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">randstring</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="w"> </span><span class="s1">&#39;other&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">ran_num</span><span class="p">());</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">until</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="n">data_times</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="n">repeat</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">commit</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="err">$</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 创建存储过程：向dept表插入数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">procedure</span><span class="w"> </span><span class="n">insert_dept</span><span class="p">(</span><span class="k">in</span><span class="w"> </span><span class="n">dno_start</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">data_times</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">begin</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">declare</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">autocommit</span><span class="w"> </span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="n">repeat</span><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">dept</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="n">dno_start</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">randstring</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="w"> </span><span class="n">randstring</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">until</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="n">data_times</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="n">repeat</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">commit</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">end</span><span class="w"> </span><span class="err">$</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 向emp、dept表中插入数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">delimiter</span><span class="w"> </span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="n">insert_emp</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span><span class="w"> </span><span class="mi">800000</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">call</span><span class="w"> </span><span class="n">insert_dept</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 验证插入数据量
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">emp</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>使用<code>show profile</code>进行<code>SQL</code>分析。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 查看 profiling 是否开启，默认是关闭的
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;profiling&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">---------------+-------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Variable_name</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Value</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">---------------+-------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">profiling</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">OFF</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">---------------+-------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 如果没开启将其开启
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">profiling</span><span class="o">=</span><span class="k">on</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>执行测试<code>SQL</code>，任意执行均可供之后<code>SQL</code>分析。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">emp</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">emp</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">eid</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">eid</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">emp</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">eid</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">150000</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 执行命令，查看结果
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">profiles</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----------+------------+--------------------------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Query_ID</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Duration</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="n">Query</span><span class="w">                                            </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----------+------------+--------------------------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">2</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00300900</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">tables</span><span class="w">                                      </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">01485700</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">desc</span><span class="w"> </span><span class="n">emp</span><span class="w">                                         </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">4</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00191200</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">emp</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">eid</span><span class="o">%</span><span class="mi">10</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">150000</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">25516300</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">emp</span><span class="w">                                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">6</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00026400</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">emp</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">eid</span><span class="o">%</span><span class="mi">10</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">150000</span><span class="w">   </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">7</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00019600</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">eid</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">emp</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">eid</span><span class="o">%</span><span class="mi">10</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">150000</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">8</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">03907500</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">eid</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">emp</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">eid</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">150000</span><span class="w">    </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w">        </span><span class="mi">9</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">06499100</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">emp</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">eid</span><span class="w"> </span><span class="k">limit</span><span class="w"> </span><span class="mi">150000</span><span class="w">      </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">10</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00031500</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">emp</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">eid</span><span class="o">%</span><span class="mi">20</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="mi">5</span><span class="w">     </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">11</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00009100</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">emp</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">eid</span><span class="o">%</span><span class="mi">20</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">12</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00012400</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">emp</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">eid</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w">          </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">13</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">25195300</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">emp</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">eid</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">eid</span><span class="w">      </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">14</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">00196200</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;profiling&#39;</span><span class="w">                  </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w">       </span><span class="mi">15</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">26208900</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">emp</span><span class="w"> </span><span class="k">group</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">eid</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">eid</span><span class="w">      </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----------+------------+--------------------------------------------------+
</span></span></span></code></pre></div><p>使用命令<code>show profile cpu,block io for query</code>上一步前面执行<code>show profiles</code> 的<code>Query_ID</code>诊断<code>SQL</code>。</p>
<blockquote>
<p>show profile 参数备注，不区分大小写：
all：显示所有的开销信息；
block io：显示块lO相关开销；
context switches：上下文切换相关开销；
cpu：显示CPU相关开销信息；
ipc：显示发送和接收相关开销信息；
memory：显示内存相关开销信息；
page faults：显示页面错误相关开销信息；
source：显示和Source_function，Source_file，Source_line相关的开销信息；
swaps：显示交换次数相关开销的信息；</p>
</blockquote>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">profile</span><span class="w"> </span><span class="n">cpu</span><span class="p">,</span><span class="n">block</span><span class="w"> </span><span class="n">io</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----------------------------+----------+----------+------------+--------------+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Status</span><span class="w">                     </span><span class="o">|</span><span class="w"> </span><span class="n">Duration</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CPU_user</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">CPU_system</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Block_ops_in</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Block_ops_out</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----------------------------+----------+----------+------------+--------------+---------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">starting</span><span class="w">                   </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">004292</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000268</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000941</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">checking</span><span class="w"> </span><span class="n">permissions</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000026</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000012</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000013</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">checking</span><span class="w"> </span><span class="n">permissions</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000007</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000005</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000003</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Opening</span><span class="w"> </span><span class="n">tables</span><span class="w">             </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">003883</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000865</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000880</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">init</span><span class="w">                       </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000022</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000013</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000008</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">System</span><span class="w"> </span><span class="k">lock</span><span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000013</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000012</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000002</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">optimizing</span><span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000994</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000078</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000155</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">statistics</span><span class="w">                 </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000233</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000222</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000011</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">preparing</span><span class="w">                  </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000046</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000043</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000003</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Creating</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="k">table</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000075</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000073</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000002</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">executing</span><span class="w">                  </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">001532</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000141</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000266</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">checking</span><span class="w"> </span><span class="n">permissions</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000050</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000044</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000005</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">checking</span><span class="w"> </span><span class="n">permissions</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000014</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000012</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000002</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">checking</span><span class="w"> </span><span class="n">permissions</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">001539</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000102</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000356</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">checking</span><span class="w"> </span><span class="n">permissions</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000044</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000037</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000007</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">checking</span><span class="w"> </span><span class="n">permissions</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000019</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000016</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000002</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">checking</span><span class="w"> </span><span class="n">permissions</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">001250</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000089</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000318</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">end</span><span class="w">                        </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000015</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000007</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000008</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="k">end</span><span class="w">                  </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000006</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000004</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000001</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">handler</span><span class="w"> </span><span class="k">commit</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000041</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000040</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000002</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">removing</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="k">table</span><span class="w">         </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000012</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000010</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000001</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">waiting</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">handler</span><span class="w"> </span><span class="k">commit</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000010</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000009</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000002</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">closing</span><span class="w"> </span><span class="n">tables</span><span class="w">             </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000019</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000018</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000001</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">freeing</span><span class="w"> </span><span class="n">items</span><span class="w">              </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000648</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000081</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000152</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">cleaning</span><span class="w"> </span><span class="n">up</span><span class="w">                </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000067</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="p">.</span><span class="mi">000047</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">0</span><span class="p">.</span><span class="mi">000021</span><span class="w"> </span><span class="o">|</span><span class="w">            </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">             </span><span class="mi">0</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----------------------------+----------+----------+------------+--------------+---------------+
</span></span></span></code></pre></div><h4 id="全局查询日志">全局查询日志</h4>
<p>不要在生产环境开启这个功能。</p>
<p>在MySQL配置文件<code>my.cnf</code>中设置全局查询日志：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">-- 开启全局查询日志
</span></span><span class="line"><span class="cl">general_log=1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- 记录日志文件的路径
</span></span><span class="line"><span class="cl">general_log_file=/path/logfile
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- 设置输出格式为 FILE
</span></span><span class="line"><span class="cl">log_output=FILE
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">-- 通过cat命令直接查看；如果为空则需要造数
</span></span><span class="line"><span class="cl">cat /var/lib/mysql/bigdata01.log;
</span></span></code></pre></div><p>在MySQL客户端设置全局查询日志：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="c1">-- 查看是否开启全局查询日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">show</span><span class="w"> </span><span class="n">variables</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;%general_log%&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 开启全局查询日志
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">set</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="n">general_log</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 设置输出格式为 TABLE
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">set</span><span class="w"> </span><span class="k">global</span><span class="w"> </span><span class="n">log_output</span><span class="o">=</span><span class="s1">&#39;TABLE&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="c1">-- 可在mysql库里的geneial_log表查看；如果为空则需要造数
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">mysql</span><span class="p">.</span><span class="n">general_log</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><h3 id="exist和in选择">exist和in选择</h3>
<p>两者可以互相替代，如果主查询的数据集大，使用<code>in</code>的效率高一点。如果子查询的数据集大，使用<code>exist</code>效率高一点。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 假设此处主查询数据集较大，使用in
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="c1">-- 假设此处子查询数据集较大，使用exist
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w">  </span><span class="k">select</span><span class="w"> </span><span class="n">tid</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="k">exists</span><span class="w"> </span><span class="p">(</span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">tbl_001</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><blockquote>
<p>exists语法：将主查询的结果，放到子查询结果中进行判断，看子查询中是否有数据，如果有数据则保留数据并返回，没有则返回空。</p>
</blockquote>
<h3 id="order-by优化">order by优化</h3>
<p><code>order by</code>是比较常用的一个关键字，基本上查询出来的数据都要进行排序，否则就太乱了。使用<code>order by</code>的时候常常伴随着<code>Using filesort</code>的发生，<code>Using filesort</code>在底层有两种算法，根据IO的次数分为：</p>
<ul>
<li>双路排序：MySQL4.1之前默认使用双路排序；具体执行流程，双路排序需要扫描两次磁盘上的字段，首先扫描排序的字段对字段进行排序，然后扫描其他字段；</li>
<li>单路排序：为了减少IO访问次数在MySQL4.1之后默认使用单路排序；读取一次获取全部的字段，在<code>buffer</code>中进行排序。但是此种方法存在隐患不一定是只读一次数据，如果数据量过大<code>buffer</code>放不下则再需要读取文件，可以通过调节<code>buffer</code>来进行缓解；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 设置读取文件缓冲区（buffer）的大小,单位字节
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">max_length_for_sort_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1024</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div></li>
</ul>
<p>如果需要排序的列的总大小超过了设置的<code>max_length_for_sort_data</code>那么MySQL底层会自动从单路排序切换到双路排序。
要保证全部索引排序字段的一致性，都是升序或都是降序，不要部分升序部分降序。</p>
<h3 id="sql优化案例">SQL优化案例</h3>
<h4 id="单表优化">单表优化</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 准备测试表、测试数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">book_2021</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">bid</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">authorid</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">publicid</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">typeid</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">book_2021</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;java&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">book_2021</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;php&#39;</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">book_2021</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;c&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">book_2021</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="s1">&#39;c#&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">book_2021</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="s1">&#39;c++&#39;</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>需要优化的<code>SQL</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- SQL原型，优化该SQL 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">bid</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">book_2021</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">typeid</span><span class="w"> </span><span class="k">in</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">authorid</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">typeid</span><span class="w"> </span><span class="k">desc</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>执行计划分析该<code>SQL</code>，发现该<code>SQL</code>存在<code>Using filesort</code>，<code>type</code>为<code>ALL</code>，需要进行<code>SQL</code>优化。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">bid</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">book_2021</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">typeid</span><span class="w"> </span><span class="k">in</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">authorid</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">typeid</span><span class="w"> </span><span class="k">desc</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-----------+------+---------------+------+---------+------+------+-----------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">                       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-----------+------+---------------+------+---------+------+------+-----------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">book_2021</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ALL</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">where</span><span class="p">;</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="n">filesort</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-----------+------+---------------+------+---------+------+------+-----------------------------+
</span></span></span></code></pre></div><ol>
<li>根据<code>SQL</code>的执行过程可知,建立索引的顺序为<code>typeid、authorid、bid</code>；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl"> -- sql执行顺序
</span></span><span class="line"><span class="cl"> from .. on .. join ..  where .. group by .. having .. select distinct .. order by .. limit ..
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 建立索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">book_2021</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">idx_tab</span><span class="p">(</span><span class="n">typeid</span><span class="p">,</span><span class="n">authorid</span><span class="p">,</span><span class="n">bid</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div></li>
<li>使用<code>in</code>的时候使索引失效，如果<code>in</code>失效那么后面的索引也将会失效，所以将范围条件放到最后；
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 优化后的SQL
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">bid</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">book_2021</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">authorid</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">typeid</span><span class="w"> </span><span class="k">in</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">typeid</span><span class="w"> </span><span class="k">desc</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div>将旧索引删除，创建字段顺序对应的索引。
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 删除 idx_tab 索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">drop</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">idx_tab</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">book_2021</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 给表 book_2021 添加索引 idx_atb
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">book_2021</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">idx_atb</span><span class="p">(</span><span class="n">authorid</span><span class="p">,</span><span class="n">typeid</span><span class="p">,</span><span class="n">bid</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div></li>
</ol>
<p>最终优化后的<code>SQL</code>执行过程：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="n">bid</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">book_2021</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">authorid</span><span class="o">=</span><span class="mi">1</span><span class="w"> </span><span class="k">and</span><span class="w"> </span><span class="n">typeid</span><span class="w"> </span><span class="k">in</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">order</span><span class="w"> </span><span class="k">by</span><span class="w"> </span><span class="n">typeid</span><span class="w"> </span><span class="k">desc</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-----------+------------+-------+---------------+---------+---------+------+------+----------+-----------------------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">                                         </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-----------+------------+-------+---------------+---------+---------+------+------+----------+-----------------------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">book_2021</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">range</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">idx_atb</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">idx_atb</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">8</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">100</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">where</span><span class="p">;</span><span class="w"> </span><span class="k">Backward</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">scan</span><span class="p">;</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-----------+------------+-------+---------------+---------+---------+------+------+----------+-----------------------------------------------+
</span></span></span></code></pre></div><p>单表优化总结：</p>
<ul>
<li>最佳左前缀原则，保持索引的定义和使用顺序一致；</li>
<li>索引需要逐步优化；</li>
<li>将包含范围查询的条件放置到最后；</li>
</ul>
<h4 id="两表优化">两表优化</h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 准备测试表、测试数据
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">teacher2</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">tid</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">cid</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w">  
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">teacher2</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">teacher2</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">teacher2</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">course2</span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">cid</span><span class="w"> </span><span class="nb">int</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="n">cname</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">course2</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;java&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">course2</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="s1">&#39;phython&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">course2</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;kotlin&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>需要优化的<code>SQL</code>：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- SQL原型，优化该SQL 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">teacher2</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">outer</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">course2</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">cid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">cid</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">cname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;java&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>执行过程分析该<code>SQL</code>，发现进行了全表扫描。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">teacher2</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">outer</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">course2</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">cid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">cid</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">cname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;java&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+--------------------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">                                      </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+--------------------------------------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="k">c</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="k">ALL</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">33</span><span class="p">.</span><span class="mi">33</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">where</span><span class="w">                                </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="k">ALL</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">          </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">3</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">33</span><span class="p">.</span><span class="mi">33</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">where</span><span class="p">;</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">buffer</span><span class="w"> </span><span class="p">(</span><span class="n">hash</span><span class="w"> </span><span class="k">join</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+--------------------------------------------+
</span></span></span></code></pre></div><p>优化思路为建立索引，在哪张表哪个字段建立索引？即<strong>小表驱动大表</strong>，索引应建立在经常使用的字段上，假设此时teacher表数据量少，那么应为<code>t.cid、c.name</code>字段加索引。</p>
<p>什么是小表驱动大表？
假设小表10条数据，大表300条数据，让大小表做嵌套循环。无论10是外层循环还是300是外层循环，结果都是3000次，但是为了减少表连接创建的次数，应该将10，即小表放在外层循环这样效率会更高。</p>
<p>为什么这么做？
现有两个表A与B ，表A有200条数据，表B有20万条数据。按照循环的概念举个例子：</p>
<ul>
<li>小表驱动大表：
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">for(200条){
</span></span><span class="line"><span class="cl">for(20万条){
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div></li>
<li>大表驱动小表：
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">for(20万条){
</span></span><span class="line"><span class="cl">for(200条){
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></div></li>
</ul>
<p>如果小的循环在外层，对于表连接来说就只连接200次，如果大的循环在外层，则需要进行20万次表连接，从而浪费资源，增加消耗。
小表驱动大表的目的是通过减少表连接创建的次数，加快查询速度。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 给表teacher2、course2 添加索引
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">teacher2</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">idx_teacher2_cid</span><span class="p">(</span><span class="n">cid</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">alter</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">course2</span><span class="w"> </span><span class="k">add</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">idx_course2_cname</span><span class="p">(</span><span class="n">cname</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>最终优化后的SQL：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 添加索引后
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">explain</span><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">teacher2</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">left</span><span class="w"> </span><span class="k">outer</span><span class="w"> </span><span class="k">join</span><span class="w"> </span><span class="n">course2</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">cid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">cid</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">cname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">&#39;java&#39;</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-------+------------+------+-------------------+-------------------+---------+----------------+------+----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">select_type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">partitions</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">type</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">possible_keys</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">key</span><span class="w">               </span><span class="o">|</span><span class="w"> </span><span class="n">key_len</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">            </span><span class="o">|</span><span class="w"> </span><span class="k">rows</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">Extra</span><span class="w">       </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-------+------------+------+-------------------+-------------------+---------+----------------+------+----------+-------------+
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="k">c</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">idx_course2_cname</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">idx_course2_cname</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="mi">83</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">const</span><span class="w">          </span><span class="o">|</span><span class="w">    </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">100</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">|</span><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">SIMPLE</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="k">NULL</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="k">ref</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">idx_teacher2_cid</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="n">idx_teacher2_cid</span><span class="w">  </span><span class="o">|</span><span class="w"> </span><span class="mi">4</span><span class="w">       </span><span class="o">|</span><span class="w"> </span><span class="n">sql_demo</span><span class="p">.</span><span class="k">c</span><span class="p">.</span><span class="n">cid</span><span class="w"> </span><span class="o">|</span><span class="w">    </span><span class="mi">1</span><span class="w"> </span><span class="o">|</span><span class="w">   </span><span class="mi">100</span><span class="p">.</span><span class="mi">00</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="k">Using</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="o">|</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="o">+</span><span class="c1">----+-------------+-------+------------+------+-------------------+-------------------+---------+----------------+------+----------+-------------+
</span></span></span></code></pre></div><p>多表优化总结：</p>
<ul>
<li>小表驱动大表；</li>
<li>索引建立在经常查询的字段上；</li>
</ul>
<h2 id="mysql锁机制">MySQL锁机制</h2>
<p>在数据库中，除传统的计算资源，如CPU、RAM、IO等的争用以外，数据也是一种供许多用户共享的资源。如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。从这个角度来说，锁对数据库而言显得尤其重要，也更加复杂。
简而言之，锁机制是解决因资源共享而造成的并发问题。</p>
<p>MySQL中的锁按照对数据操作的类型分为，读锁即共享锁，写锁即互斥锁。按照操作粒度来分，分为表锁、行锁，页锁。</p>
<ul>
<li>读锁：对于同一个数据，多个读操作可以同时进行，互不干扰。</li>
<li>写锁：如果当前写操作没有完毕，则无法进行其他的读操作、写操作。</li>
<li>表锁：一次性对一张表整体加锁。<code>MyISAM</code>存储引擎偏向表锁，开销较小、加锁较快、无死锁、锁的范围较大，但是容易发生发生锁冲突，并发度低。</li>
<li>行锁：一次性对一条数据加锁。<code>InnoDB</code>存储引擎偏向行锁，开销较大、加锁较慢、容易出现死锁、锁的范围较小，但是不易发生锁冲突，并发度高。</li>
</ul>
<p>MySQL锁分为全局锁、表级锁以及行级锁，不同的存储引擎支持锁的粒度有所不同。<code>MyISAM</code>只支持到表级锁，<code>InnoDB</code>则可以支持到行级锁，锁的粒度决定了业务的并发度，因此更推荐使用<code>InnoDB</code>。
<code>InnoDB</code>默认最小加锁粒度为行级锁，并且锁是加在索引上，如果<code>SQL</code>语句未命中索引，则走聚簇索引的全表扫描，表上每条记录都会上锁，导致并发能力下降，增大死锁的概率。因此需要为表合理的添加索引，线上查询尽量命中索引。
尽可能让所有数据检索都通过索引来完成，避免无索引行锁升级为表锁。</p>
<h3 id="表锁">表锁</h3>
<p>测试数据：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="k">create</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="n">mylock</span><span class="w"> </span><span class="p">(</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">id</span><span class="w"> </span><span class="nb">int</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="k">null</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="n">auto_increment</span><span class="p">,</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">     </span><span class="n">name</span><span class="w"> </span><span class="nb">varchar</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="n">myisam</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">mylock</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">mylock</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;b&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">mylock</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;c&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">mylock</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">insert</span><span class="w"> </span><span class="k">into</span><span class="w"> </span><span class="n">mylock</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="k">values</span><span class="p">(</span><span class="s1">&#39;e&#39;</span><span class="p">);</span><span class="w">
</span></span></span></code></pre></div><p>加锁、解锁常用命令：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 加锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">lock</span><span class="w"> </span><span class="k">table</span><span class="w"> </span><span class="err">表名</span><span class="mi">1</span><span class="w"> </span><span class="k">read</span><span class="o">/</span><span class="k">write</span><span class="p">,</span><span class="w"> </span><span class="err">表名</span><span class="mi">2</span><span class="w"> </span><span class="k">read</span><span class="o">/</span><span class="k">write</span><span class="p">,</span><span class="w"> </span><span class="err">其他</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 解锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="n">unlock</span><span class="w"> </span><span class="n">tables</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 查看表上是否加锁；在In_use列，0代表没有加锁，1代表加锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="k">open</span><span class="w"> </span><span class="n">tables</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 分析表锁
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- Table_locks_immediate：产生表级锁定的次数，表示可以立即获取锁的查询次数，每立即获取锁值加1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- Table_locks_waited：出现表级锁定争用而发生等待的次数(不能立即获取锁的次数，每等待一次锁值加1)，此值高则说明存在着较严重的表级锁争用情况
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">show</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="k">like</span><span class="w"> </span><span class="s1">&#39;table_locks%&#39;</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>给表添加读锁及测试读操作：</p>
<p><img alt="MySqlSQL优化及锁机制-002" src="/posts/annex/images/essays/MySqlSQL%E4%BC%98%E5%8C%96%E5%8F%8A%E9%94%81%E6%9C%BA%E5%88%B6-002.png"></p>
<p><img alt="MySqlSQL优化及锁机制-004" src="/posts/annex/images/essays/MySqlSQL%E4%BC%98%E5%8C%96%E5%8F%8A%E9%94%81%E6%9C%BA%E5%88%B6-004.png"></p>
<p>给表添加读锁及测试写操作：</p>
<p><img alt="MySqlSQL优化及锁机制-003" src="/posts/annex/images/essays/MySqlSQL%E4%BC%98%E5%8C%96%E5%8F%8A%E9%94%81%E6%9C%BA%E5%88%B6-003.png"></p>
<p><img alt="MySqlSQL优化及锁机制-005" src="/posts/annex/images/essays/MySqlSQL%E4%BC%98%E5%8C%96%E5%8F%8A%E9%94%81%E6%9C%BA%E5%88%B6-005.png"></p>
<p>给某个表添加读锁之后，所有会话都能对这个表进行读操作，但是当前会话不能对该表进行写操作，对其他表进行读、写操作；其他会话能需要等持有锁的会话释放该表的锁后，才能进行写操作，期间将会一直处于等待状态，可以对其他表进行读写操作。</p>
<p>给表添加写锁及测试读操作：</p>
<p><img alt="MySqlSQL优化及锁机制-006" src="/posts/annex/images/essays/MySqlSQL%E4%BC%98%E5%8C%96%E5%8F%8A%E9%94%81%E6%9C%BA%E5%88%B6-006.png"></p>
<p><img alt="MySqlSQL优化及锁机制-007" src="/posts/annex/images/essays/MySqlSQL%E4%BC%98%E5%8C%96%E5%8F%8A%E9%94%81%E6%9C%BA%E5%88%B6-007.png"></p>
<p>给表添加写锁及测试写操作：</p>
<p><img alt="MySqlSQL优化及锁机制-008" src="/posts/annex/images/essays/MySqlSQL%E4%BC%98%E5%8C%96%E5%8F%8A%E9%94%81%E6%9C%BA%E5%88%B6-008.png"></p>
<p><img alt="MySqlSQL优化及锁机制-009" src="/posts/annex/images/essays/MySqlSQL%E4%BC%98%E5%8C%96%E5%8F%8A%E9%94%81%E6%9C%BA%E5%88%B6-009.png"></p>
<p>给某个表添加写锁之后，当前会话可以对该表进行写操作、读操作，其他会话要想对该表进行读写操作需要等持有锁的会话释放锁，否则期间将会一直等待该锁释放；但是当前持有锁的会话是不能对其他表进行读写操作，其他会话能够对其他表进行读写操作。</p>
<p>对于表锁，<code>MyISAM</code>在执行查询语句前，会自动给涉及的所有表加读锁，在执行增删改操作前，会自动给涉及的表加写锁。</p>
<ul>
<li>对<code>MyISAM</code>表的读操作，不会阻塞其他进程对同一表的读请求，但会阻塞对同一表的写请求。只有当读锁释放后，才会执行其它进程的写操作。</li>
<li>对<code>MyISAM</code>表的写操作，会阻塞其他进程对同一表的读和写操作，只有当写锁释放后，才会执行其它进程的读写操作。</li>
</ul>
<p>简而言之，就是读锁会阻塞写，但是不会堵塞读，而写锁则会把读和写都堵塞。</p>
<h3 id="行锁">行锁</h3>
<p>测试数据：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="w"> </span><span class="nb">INT</span><span class="p">(</span><span class="mi">11</span><span class="p">),</span><span class="n">b</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">16</span><span class="p">))</span><span class="n">ENGINE</span><span class="o">=</span><span class="n">INNODB</span><span class="p">;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;b2&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;4000&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="s1">&#39;5000&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;6000&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="s1">&#39;7000&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;8000&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="s1">&#39;9000&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="k">VALUES</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;b1&#39;</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">test_innodb_a_ind</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="p">(</span><span class="n">a</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> </span><span class="k">CREATE</span><span class="w"> </span><span class="k">INDEX</span><span class="w"> </span><span class="n">test_innodb_lock_b_ind</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="p">(</span><span class="n">b</span><span class="p">);</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"> 
</span></span></span></code></pre></div><p>常用命令：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 分析行锁定：
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- 尤其是当等待次数很高，而且每次等待时长也不小的时候，我们就需要分析系统中为什么会有如此多的等待，然后根据分析结果着手指定优化计划。
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- Innodb_row_lock_current_waits：当前正在等待锁定的数量；
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- Innodb_row_lock_time：从系统启动到现在锁定总时间长度；
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- Innodb_row_lock_time_avg：每次等待所花平均时间；
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- Innodb_row_lock_time_max：从系统启动到现在等待最常的一次所花的时间；
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- Innodb_row_lock_waits：系统启动后到现在总共等待的次数；
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="c1">-- show status like &#39;innodb_row_lock%&#39;;
</span></span></span></code></pre></div><p>由于行锁与事务相关，所以在测试之前需要关闭MySQL的自动提交：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="c1">-- 关闭自动提交；0关闭，1打开
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="w"> </span><span class="k">set</span><span class="w"> </span><span class="n">autocommit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p>测试行锁读写操作：</p>
<p><img alt="MySqlSQL优化及锁机制-010" src="/posts/annex/images/essays/MySqlSQL%E4%BC%98%E5%8C%96%E5%8F%8A%E9%94%81%E6%9C%BA%E5%88%B6-010.png"></p>
<p><img alt="MySqlSQL优化及锁机制-011" src="/posts/annex/images/essays/MySqlSQL%E4%BC%98%E5%8C%96%E5%8F%8A%E9%94%81%E6%9C%BA%E5%88%B6-011.png"></p>
<p>当前会话当关闭MySQL自动提交后，修改表中的某一行数据，未提交前其他会话是不可见该修改的数据的；如果当前会话和修改某一行数据其他会话也修改该行数据则其他会话会一直等待，直到持有锁的会话<code>commit</code>后才会执行。
如果当前会话和其他会话操作同一张表的不同行数据时，则相互不影响。使用行锁时注意，无索引行或索引失效都会导致行锁变为表锁。</p>
<p>当我们用范围条件而不是相等条件检索数据，并请求共享或排他锁时，<code>InnoDB</code>会给符合条件的已有数据记录的索引项加锁，对于键值在条件范围内但并不存在的记录，叫做“间隙”。
<code>InnoDB</code>也会对这个“间隙”加锁，这种锁机制就是所谓的间隙锁。</p>
<p>因为查询执行过程中通过过范围查找，它会锁定整个范围内所有的索引键值，即使这个键值并不存在。
间隙锁有一个比较致命的弱点，就是当锁定一个范围键值之后，即使某些不存在的键值也会被无辜的锁定，而造成在锁定的时候无法插入锁定键值范围内的任何数据。在某些场景下这可能会对性能造成很大的危害。</p>
<p>如何锁定一行？在查询语句使用<code>for update</code>关键字可以实现锁定一行。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sql" data-lang="sql"><span class="line"><span class="cl"><span class="w"> </span><span class="k">select</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="n">test_innodb_lock</span><span class="w"> </span><span class="k">where</span><span class="w"> </span><span class="n">a</span><span class="o">=</span><span class="mi">8</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">update</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></div><p><img alt="MySqlSQL优化及锁机制-012" src="/posts/annex/images/essays/MySqlSQL%E4%BC%98%E5%8C%96%E5%8F%8A%E9%94%81%E6%9C%BA%E5%88%B6-012.png"></p>
<p><code>Innodb</code>存储引擎由于实现了行级锁定，虽然在锁定机制的实现方面所带来的性能损耗可能比表级锁定会要更高一些，但是在整体并发处理能力方面要远远优于<code>MyISAM</code>的表级锁定的。
当系统并发量较高的时候，<code>Innodb</code>的整体性能和<code>MyISAM</code>相比就会有比较明显的优势了。但是<code>Innodb</code>的行级锁定同样也有其脆弱的一面，当我们使用不当的时候，可能会让<code>Innodb</code>的整体性能表现不仅不能比<code>MyISAM</code>高，甚至可能会更差。</p>
<h2 id="分库分表">分库分表</h2>
<p>当数据库存储出现瓶颈的时候，就需要进行分库分表了。
假设你现在在一个小公司，注册用户20万，每天活跃用户1万，每天单表数据量就1000，然后高峰期每秒钟并发请求最多10个。
随着公司业务发展，过了几年，注册用户数达到了5000 万，每天活跃用户数200万，每天单表数据量50万条，数据库磁盘容量不断消耗掉，高峰期并发达到惊人的5000~8000，这时候你会发现你得系统已经支撑不住了已经挂掉了。</p>
<p>随着业务的发展，数据库会遇到瓶颈，单表得数据量太大，会极大影响你的<code>SQL</code>执行的性能，到了后面<code>SQL</code>就跑的很慢了。
所以为了维持功能的正常使用不得不分库分表。</p>
<ul>
<li>分表：分表就是把一个表的数据放到多个表中，然后查询的时候你就查一个表。比如按照用户<code>id</code>来分表，将一个用户的数据就放在一个表中。
然后操作的时候你对一个用户就操作那个表就好了。分表主要是为了减少单张表的大小，解决单表数据量带来的性能问题。当单表数据增量过快，业界流传是超过500万的数据量就要考虑分表了。
当然500万只是一个经验值，大家可以根据实际情况做出决策。</li>
<li>分库：一个库一般我们经验而言，最多支撑到并发2000，超过这个数字就一定要扩容了，而且一个健康的单库并发值你最好保持在每秒 1000 左右，不要太大。
那么你可以将一个库的数据拆分到多个库中，访问的时候就访问一个库好了。</li>
</ul>
<p>分库分表是两个事情，可能是光分库不分表，也可能是光分表不分库，都有可能，但不管怎样分库分表一定是为了支撑高并发、数据量大两个问题的。
分库分表是能不分就不分，因为分库分表也会带来一些问题：</p>
<ul>
<li>跨库关联查询；</li>
<li>分布式事务；</li>
<li>排序、分页、函数计算问题；</li>
<li>分布式ID；</li>
<li>多数据源；</li>
</ul>
<h3 id="拆分方案">拆分方案</h3>
<p>怎么拆分？拆分方案一般分为两种，水平拆分，垂直拆分。</p>
<p>水平拆分的意思，基于数据划分，表结构相同，数据不同。例如，现有一个业务表，新建业务表2，业务表与业务表2中字段一致，将ID为奇数的存储在业务表中，偶数的存放在业务表2中。
就是把一个表的数据给弄到多个库的多个表里去，但是每个库的表结构都一样，只不过每个库表放的数据是不同的，所有库表的数据加起来就是全部数据。
水平拆分的意义，就是将数据均匀放更多的库里，然后用多个库来扛更高的并发，还有就是用多个库的存储容量来进行扩容。</p>
<p>垂直拆分的意思，基于表或字段划分，表结构不同。例如，将业务表中不常用的字段<code>name</code>和<code>age</code>存放到业务表2中。
就是把一个有很多字段的表给拆分成多个表，或者是多个库上去。每个库表的结构都不一样，每个库表都包含部分字段。
一般来说，会将较少的访问频率很高的字段放到一个表里去，然后将较多的访问频率很低的字段放到另外一个表里去。
因为数据库是有缓存的，你访问频率高的行字段越少，就可以在缓存里缓存更多的行，性能就越好，这个一般在表层面做的较多一些。</p>
<ul>
<li>
<p>在一个库内拆分多个表：先分库，将不同数据库中的表拆分为了多个子表，多个子表存在于同一数据库中；
<img alt="MySqlSQL优化及锁机制-013" src="/posts/annex/images/essays/MySqlSQL%E4%BC%98%E5%8C%96%E5%8F%8A%E9%94%81%E6%9C%BA%E5%88%B6-013.png"></p>
</li>
<li>
<p>用多库拆分一个表，将一个数据库中的表拆分到多个数据库中；
<img alt="MySqlSQL优化及锁机制-014" src="/posts/annex/images/essays/MySqlSQL%E4%BC%98%E5%8C%96%E5%8F%8A%E9%94%81%E6%9C%BA%E5%88%B6-014.png"></p>
</li>
</ul>
<p>在一个数据库中将一张表拆分为几个子表，在一定程度上可以解决单表查询性能的问题，但是也会遇到单数据库存储瓶颈这个问题，所以用的更多的还是将子表拆分到多个数据库中。</p>
<p>除了垂直和水平拆分外，还有比较流行的分库分表方式，一种是按照<code>range</code>，即范围来分。每个库存一段连续的数据，这个一般是按比如时间范围来的。
但是这种一般较少用，因为很容易产生热点问题，大量的流量都打在最新的数据上了；另一种是按照某个字段的<code>hash</code>值，一下均匀分散。</p>
<ul>
<li><code>range</code>的好处在于扩容的时候很简单，因为你只要预备好，给每个月都准备一个库就可以了，到了一个新的月份的时候，自然而然，就会写新的库了；
但是大部分的请求，都是访问最新的数据。实际生产用<code>range</code>要看场景。</li>
<li><code>hash</code>的好处在于可以平均分配每个库的数据量和请求压力；坏处在于说扩容起来比较麻烦，会有一个数据迁移的过程，之前的数据需要重新计算<code>hash</code>值重新分配到不同的库或表。</li>
</ul>
<h3 id="数据迁移方案">数据迁移方案</h3>
<p>现在有一个未分库分表的系统，未来要分库分表，如何设计才可以让系统从未分库分表动态切换到分库分表上？</p>
<p>方案一：停机迁移</p>
<ol>
<li>网站或者App发布公告，例如，0点到早上6点进行运维，无法访问；</li>
<li>到时间将系统停掉，执行导数工具，将单库单表的数据读出来，写到分库分表里面去；</li>
<li>导数完之后，需要改配置，验证一下数据；</li>
</ol>
<p>方案二：双写迁移</p>
<ol>
<li>在线上系统里面，之前所有写库的地方，增删改操作，除了对老库增删改，都加上对新库的增删改；</li>
<li>重新部署系统，新数据库数据差太多，就写一个导数工具，跑起来读老库数据写新库，跑的时候要注意，老数据不要覆盖掉新数据；</li>
<li>假设导完数据了，有可能数据还是存在不一致，那么就程序自动做一轮校验，比对新老库每个表的每条数据，就针对那些不一样的，从老库读数据再次写。
反复循环，直到两个库每个表的数据都完全一致为止；</li>
</ol>
<h3 id="分库分表中间件">分库分表中间件</h3>
<p>在MySQL中，分库分表是为了处理大规模数据和高并发访问的技术。中间件在这方面扮演着重要角色，它负责将数据库请求路由到正确的数据库和表。</p>
<ol>
<li><a href="https://github.com/alibaba/cobar/wiki">Cobar</a>: 阿里B2B团队开发和开源的，属于 <code>proxy</code> 层方案，就是介于应用服务器和数据库服务器之间。应用程序通过 <code>JDBC</code> 驱动访问 <code>Cobar</code> 集群，<code>Cobar</code> 根据 <code>SQL</code> 和分库规则对 <code>SQL</code> 做分解，然后分发到 MySQL 集群不同的数据库实例上执行。早些年还可以用，但是最近几年都没更新了，基本没啥人用，差不多算是被抛弃的状态吧。而且不支持读写分离、存储过程、跨库 <code>join</code> 和分页等操作。</li>
<li><a href="https://github.com/alibaba/tb_tddl">TDDL</a>: 淘宝团队开发的，属于 <code>client</code> 层方案。支持基本的CRUD语法和读写分离，但不支持 <code>join</code>、多表查询等语法。目前使用的也不多，因为还依赖淘宝的 <code>diamond</code> 配置管理系统。</li>
<li><a href="https://github.com/Qihoo360/Atlas">Atlas</a>: 360开源的，属于 <code>proxy</code> 层方案，以前是有一些公司在用的，但是确实有一个很大的问题就是社区最新的维护都在 5 年前了。所以，现在用的公司基本也很少了。</li>
<li><a href="https://shardingsphere.apache.org/document/legacy/4.x/document/cn/overview">Sharding-jdbc</a>: 当当开源的，属于 <code>client</code> 层方案，是 <code>ShardingSphere</code> 的 <code>client</code> 层方案，<code>ShardingSphere</code> 还提供 <code>proxy</code> 层的方案 <code>Sharding-Proxy</code>。确实之前用的还比较多一些，因为 SQL 语法支持也比较多，没有太多限制，而且截至 2019 年 4 月，已经推出到了 4.0.0-RC1 版本，支持分库分表、读写分离、分布式 ID 生成、柔性事务（最大努力送达型事务、TCC 事务）。而且确实之前使用的公司会比较多一些（这个在官网有登记使用的公司，可以看到从 2017 年一直到现在，是有不少公司在用的），目前社区也还一直在开发和维护，还算是比较活跃，个人认为算是一个现在也可以选择的方案。</li>
<li><a href="https://www.yuque.com/ccazhw/ml3nkf">Mycat</a>: 基于 <code>Cobar</code> 改造的，属于 <code>proxy</code> 层方案，支持的功能非常完善，而且目前应该是非常火的而且不断流行的数据库中间件，社区很活跃，也有一些公司开始在用了。但是确实相比于 <code>Sharding jdbc</code> 来说，年轻一些，经历的锤炼少一些。</li>
</ol>
<p>现在其实建议考量的，就是<code>Sharding-jdbc</code>和<code>Mycat</code>，这两个都可以去考虑使用。无论分库还是分表，上面说的那些数据库中间件都是可以支持的。
就是基本上那些中间件可以做到你分库分表之后，中间件可以根据你指定的某个字段值，比如说<code>userid</code>，自动路由到对应的库上去，然后再自动路由到对应的表里去。</p>
<p><code>Sharding-jdbc</code>这种<code>client</code>层方案的优点在于不用部署，运维成本低，不需要代理层的二次转发请求，性能很高，但是如果遇到升级啥的需要各个系统都重新升级版本再发布，各个系统都需要耦合<code>Sharding-jdbc</code>的依赖。
<code>Mycat</code>这种<code>proxy</code>层方案的缺点在于需要部署，自己运维一套中间件，运维成本高，但是好处在于对于各个项目是透明的，如果遇到升级之类的都是自己中间件那里搞就行了。</p>
<p>通常来说，这两个方案其实都可以选用，但是建议中小型公司选用<code>Sharding-jdbc</code>，<code>client</code>层方案轻便，而且维护成本低，不需要额外增派人手。而且中小型公司系统复杂度会低一些，项目也没那么多；但是中大型公司最好还是选用 <code>Mycat</code> 这类 <code>proxy</code> 层方案，因为可能大公司系统和项目非常多，团队很大，人员充足，那么最好是专门弄个人来研究和维护<code>Mycat</code>，然后大量项目直接透明使用即可。</p>
<h2 id="参考文章">参考文章</h2>
<ul>
<li><a href="https://mp.weixin.qq.com/s/-Jipxjwe-jAax4hJSe-9Jg">https://mp.weixin.qq.com/s/-Jipxjwe-jAax4hJSe-9Jg</a></li>
<li><a href="https://www.hollischuang.com/archives/6330">https://www.hollischuang.com/archives/6330</a></li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/using-explain.html">https://dev.mysql.com/doc/refman/8.0/en/using-explain.html</a></li>
<li><a href="https://www.javanav.com/interview/7b1d6961b1e344fa9b6ea74819d4f417.html">https://www.javanav.com/interview/7b1d6961b1e344fa9b6ea74819d4f417.html</a></li>
<li><a href="http://blog.chinaunix.net/uid-30272888-id-5602128.html">http://blog.chinaunix.net/uid-30272888-id-5602128.html</a></li>
<li><a href="https://blog.codinglabs.org/articles/theory-of-mysql-index.html">https://blog.codinglabs.org/articles/theory-of-mysql-index.html</a></li>
<li><a href="https://javaguide.cn/database/mysql/mysql-index.html">https://javaguide.cn/database/mysql/mysql-index.html</a></li>
<li><a href="https://mp.weixin.qq.com/s/8qemhRg5MgXs1So5YCv0fQ">https://mp.weixin.qq.com/s/8qemhRg5MgXs1So5YCv0fQ</a></li>
<li><a href="https://javaguide.cn/database/mysql/innodb-implementation-of-mvcc.html">https://javaguide.cn/database/mysql/innodb-implementation-of-mvcc.html</a></li>
<li><a href="https://javabetter.cn/mysql/shiwu-shixian.html">https://javabetter.cn/mysql/shiwu-shixian.html</a></li>
</ul>
</div>
                    <div id="post_footer" class="post_footer">
                        <div class="meta">

                            <div id="post_footer_info" class="info">
                                <span class="field tags">
                                    <i class="ri-stack-line"></i>
                                    
                                        
                                        <a href="http://localhost:1313/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
                                        
                                        <a href="http://localhost:1313/tags/%E8%AF%A6%E8%A7%A3/">详解</a>
                                        
                                    
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
                
                
                <div id="doc_comments" class="doc_comments"></div>
                
            </div>
        </div>
    </div>
    
<a id="search-btn" style="display: inline-block;" href="javascript:void(0);">
    <span class="ri-search-line"></span>
</a>
<div id="fastSearch">
    <input id="searchInput" tabindex="0" autocomplete="off">
    <ul id="searchResults"></ul>
</div>
<div class="side_nav">
    
    <a id="top_to_back" href="#" class="top_to_back">
        <svg t="1688614744062" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2152" width="16" height="16"><path d="M966.4 323.2c-9.6-9.6-25.6-9.6-35.2 0l-416 416-425.6-416c-9.6-9.6-25.6-9.6-35.2 0-9.6 9.6-9.6 25.6 0 35.2l441.6 432c9.6 9.6 25.6 9.6 35.2 0l435.2-432C976 345.6 976 332.8 966.4 323.2z" p-id="2153" fill="#424242"></path></svg>    </a>
    
    <div>
        <a id="content_display" class="content_display">
            <svg t="1688606941910" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="57753" width="18" height="18"><path d="M192 448c10.9 0 21.8-4.2 30.2-12.5L497 160.8c5.4-5.4 11.8-6.2 15.1-6.2 3.3 0 9.6 0.8 15.1 6.2l274.7 274.7c16.7 16.7 43.7 16.7 60.3 0 16.7-16.7 16.7-43.7 0-60.3L587.4 100.4c-41.6-41.6-109.3-41.6-150.9 0L161.8 375.2c-16.7 16.7-16.7 43.7 0 60.3 8.4 8.3 19.3 12.5 30.2 12.5zM801.8 588.5L527.1 863.2c-5.4 5.4-11.8 6.2-15.1 6.2-3.3 0-9.7-0.8-15.1-6.2L222.2 588.5c-16.7-16.7-43.7-16.7-60.3 0-16.7 16.7-16.7 43.7 0 60.3l274.8 274.8c20.8 20.8 48.1 31.2 75.4 31.2 27.3 0 54.6-10.4 75.4-31.2l274.7-274.8c16.7-16.7 16.7-43.7 0-60.3-16.7-16.7-43.7-16.7-60.4 0z" fill="#424242" p-id="57754"></path></svg>
        </a>
        <a id="content_hidden" class="content_hidden">
            <svg t="1688603143752" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="15592" width="18" height="18"><path d="M479.004101 645.938677L165.25229 958.480465a37.510709 37.510709 0 0 0 0 54.059551 36.47863 36.47863 0 0 0 53.063061 0l293.679668-292.576411 293.715256 292.576411a36.443042 36.443042 0 0 0 53.063061 0 37.510709 37.510709 0 0 0 0-54.059551l-313.751811-312.541788c-21.210989-22.349834-36.514219-24.698702-66.017424 0z m66.053013-267.877709l312.577377-312.541789a37.510709 37.510709 0 0 0 0-54.059551 36.443042 36.443042 0 0 0-53.063061 0l-292.505234 292.576411L219.560963 11.459628a36.47863 36.47863 0 0 0-53.063061 0 37.510709 37.510709 0 0 0 0 54.059551l312.577377 312.541789a46.58588 46.58588 0 0 0 65.981835-0.035589z" p-id="15593" fill="#424242"></path></svg>
        </a>
    </div>
    
    <a id="back_to_top" href="#" class="back_to_top">
        <svg t="1688628374733" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="3166" width="16" height="16"><path d="M966.4 668.8l-435.2-432c-9.6-9.6-25.6-9.6-35.2 0l-441.6 432c-9.6 9.6-9.6 25.6 0 35.2 9.6 9.6 25.6 9.6 35.2 0l425.6-416 416 416c9.6 9.6 25.6 9.6 35.2 0S976 678.4 966.4 668.8z" p-id="3167" fill="#424242"></path></svg>
    </a>
</div>
    <footer class="footer">
    <div id="footer_powered_by" class="powered_by">
        <a href="https://varkai.com">Designed by VarKai,</a>
        <a href="http://www.gohugo.io/">Proudly published with Hugo</a>
    </div>

    <div id="footer_slogan" class="footer_slogan">
        <span>from 2020</span>
    </div>
</footer>
    






<script src="https://cdn.jsdelivr.net/gh/whiteppure/iblog@main/docs/js/jquery-3.5.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/whiteppure/iblog@main/docs/js/fancybox.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/whiteppure/iblog@main/docs/js/darkmode.js"></script>
<script src="https://cdn.jsdelivr.net/gh/whiteppure/iblog@main/docs/js/zozo.js"></script>

<script src="https://cdn.jsdelivr.net/gh/whiteppure/iblog@main/docs/js/busuanzi_2.3_busuanzi.pure.mini.js"></script>
<script src="https://cdn.jsdelivr.net/gh/whiteppure/iblog@main/docs/js/html2canvas.js"></script>
<script src="https://cdn.jsdelivr.net/gh/whiteppure/iblog@main/docs/js/utils.js"></script>
<script src="https://cdn.jsdelivr.net/gh/whiteppure/iblog@main/docs/js/html2md.js"></script>
<script src="https://cdn.jsdelivr.net/gh/whiteppure/iblog@main/docs/js/htmlexport.js"></script>
<script src="https://cdn.jsdelivr.net/gh/whiteppure/iblog@main/docs/js/fastsearch.js"></script>
<script src="https://cdn.jsdelivr.net/gh/whiteppure/iblog@main/docs/js/fuse.js"></script>


<script>
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
</script>


<script>
    
    document.addEventListener("DOMContentLoaded", function () {
        const uvE = document.getElementById('busuanzi_value_site_uv');
        const pvE = document.getElementById('busuanzi_value_site_pv');
        const uvObs = new MutationObserver((mutationsList) => {
            for (let mutation of mutationsList) {
                if (mutation.type === 'childList') {
                    uvObs.disconnect();
                    mutation.target.innerHTML = parseInt(mutation.target.innerHTML) + 57030;
                    break;
                }
            }
        });
        const pvObs = new MutationObserver((mutationsList) => {
            for (let mutation of mutationsList) {
                if (mutation.type === 'childList') {
                    pvObs.disconnect();
                    mutation.target.innerHTML = parseInt(mutation.target.innerHTML) + 203040;
                    break;
                }
            }
        });
        const config = {
            childList: true
        };
        uvObs.observe(uvE, config);
        pvObs.observe(pvE, config);
    });
</script>


<script>
    
    document.addEventListener('DOMContentLoaded', function() {
        var links = document.querySelectorAll('.content a');
        links.forEach(function(link) {
            link.setAttribute('target', '_blank');
        });
    });
</script>











</body>

</html>